## ä¸€ã€å‰è¨€

> â€œä¸€åƒä¸ªäººçœ¼é‡Œæœ‰ä¸€åƒä¸ªå“ˆå§†é›·ç‰¹â€ æœ¬æ–‡ä»…æ˜¯ä½œè€…è¿™æ®µæ—¶é—´å¯¹å¾®å‰ç«¯çš„æ€è€ƒä¸æ„Ÿæ‚Ÿï¼Œæ–‡ç¬”æ‹™åŠ£ï¼Œå¤šå¤šæµ·æ¶µã€‚å¾®å‰ç«¯çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯å¾®å‰ç«¯å¹¶ä¸å®Œç¾ã€‚åªæœ‰é€‚åˆè‡ªå·±ã€é€‚åˆå›¢é˜Ÿçš„æ‰æ˜¯æœ€ä½³å®è·µã€‚å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©æ‚¨åœ¨å¾®å‰ç«¯å­¦ä¹ ä¹‹è·¯ä¸ŠèŠ‚çº¦ä¸€ç‚¹æ—¶é—´ã€‚ä¹Ÿæ¬¢è¿å¤§å®¶æå‡ºæ„è§ã€è¸Šè·ƒçš„åé¦ˆã€å¸Œæœ›èƒ½ä¸å¤§å®¶å…±è¿›æ­¥ï¼ŒåŠ æ²¹ï½

ç”±äºæœ¬æ–‡è¾ƒé•¿ï¼ˆPSï¼šæœ¬äººæ‡’å¾—åˆ†ç¯‡ï¼‰ï¼Œç›®å½•ä¸€è‡³ç›®å½•ä¸ƒåç†è®ºçŸ¥è¯†ï¼Œç›®å½•ä¸ƒä¹‹åä¸ºå®è·µæ“ä½œä¸æ€è€ƒï¼Œå¤§å®¶å¯ä»¥é€‚å½“çš„è·³è·ƒæ¥çœ‹

**å¾®å‰ç«¯æ˜¯ä»€ä¹ˆï¼Ÿ**

-   å¾®å‰ç«¯ä¸æ˜¯ç‰¹æŒ‡æŸä¸€é¡¹æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§æ€æƒ³ã€‚æ˜¯ç”±2016å¹´Â [ThoughtWorks Technology Radar](https://link.juejin.cn/?target=https%3A%2F%2Fwww.thoughtworks.com%2Fradar%2Ftechniques%2Fmicro-frontends "https://www.thoughtworks.com/radar/techniques/micro-frontends") ä¸­æå‡ºçš„ï¼Œå€Ÿé‰´åç«¯å¾®æœåŠ¡çš„æ¶æ„æ¨¡å¼ï¼Œå°† Web åº”ç”¨ç”±å•ä¸€çš„å•ä½“åº”ç”¨è½¬å˜ä¸ºå¤šä¸ªå°å‹å‰ç«¯åº”ç”¨ï¼Œèšåˆä¸ºä¸€çš„åº”ç”¨ã€‚
-   æ‰€ä»¥å¾®å‰ç«¯ä¸æ˜¯æŒ‡å…·ä½“çš„åº“ï¼Œä¸æ˜¯æŒ‡å…·ä½“çš„æ¡†æ¶ï¼Œä¸æ˜¯æŒ‡å…·ä½“çš„å·¥å…·ï¼Œè€Œæ˜¯ä¸€ç§ç†æƒ³ä¸æ¶æ„æ¨¡å¼ã€‚
-   å¾®å‰ç«¯çš„æ ¸å¿ƒä¸‰å¤§åŸåˆ™å°±æ˜¯ï¼š**ç‹¬ç«‹è¿è¡Œã€ç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹å¼€å‘** æ‰€ä»¥æ»¡è¶³è¿™äº›çš„æœ€ä½³äººé€‰å°±æ˜¯ â€œiframeâ€!!!

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0457bc5f24a7491ea730dffc2a93d91f~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

**å¾®å‰ç«¯èƒ½è§£å†³æˆ‘ä»¬ä»€ä¹ˆé—®é¢˜ï¼Ÿ**

ä¸¾ä¾‹: ä¸€ä¸ªæŒç»­å¤šå¹´çš„åº”ç”¨ï¼Œç»å†å‡ å¹´çš„ä¸šåŠ¡çš„æ›´æ–°è¿­ä»£ï¼Œå½“é¡¹ç›®å‘å±•åˆ°ä¸€å®šç¨‹åº¦çš„æ—¶å€™å°±ä¼šé‡åˆ°ä»¥ä¸‹é—®é¢˜

1.  ä¸šåŠ¡æ¨¡å—ä¹‹é—´ä¸æ–­çš„å †å ï¼Œäº¤é”™å¼•ç”¨ï¼Œä¸šåŠ¡è€¦åˆå¦‚ä½•æ²»ç†ï¼Ÿ
2.  è€æŠ€æœ¯ã€è€ä»£ç ä¸æ•¢åŠ¨ï¼Œæ–°æŠ€æœ¯ã€æ–°æ¶æ„åˆæƒ³ç”¨ï¼Ÿ
3.  ä¸‡å¹´æŠ€æœ¯å€ºï¼Ÿæ—¢è¦è·Ÿéšä¸šåŠ¡æ•æ·è¿­ä»£ï¼Œåˆè¦ä¿è¯ä»£ç åº“å‘å¥½å‘å±•ï¼Œæ—§çš„æ¡†æ¶ç±»åº“å¦‚ä½•å¹³ç¨³å‡çº§ï¼Ÿ
4.  ä¸€ä¸ªé¡¹ç›®å¤šä¸ªå›¢é˜Ÿå¼€å‘ï¼Œä½ å†²çªæˆ‘ï¼Œæˆ‘å†²çªä½ ï¼Œå¦‚ä½•è§£å†³å¹¶è¡Œå¼€å‘çš„å†²çªï¼Ÿ
5.  ä»£ç åº“æŒç»­è†¨èƒ€ï¼Œéš¾ä»¥ç»´æŠ¤çš„é¡¹ç›®ä»£ç ï¼Œæ˜¯å±ä¸Šé›•èŠ±ï¼Ÿè¿˜æ˜¯ä»å¤´å†æ¥ï¼Ÿ

æœ‰æ²¡æœ‰ä¸€ç§å¯ä»¥åˆ†è§£å¤æ‚åº¦ï¼Œæå‡åä½œæ•ˆç‡ï¼Œæ”¯æŒçµæ´»æ‰©å±•çš„æ¶æ„æ¨¡å¼ï¼Ÿ **å¾®å‰ç«¯åº”è¿è€Œç”Ÿâ€”â€” â€œæ›´å‹å¥½çš„iframeâ€** å°†ä¸€ä¸ªå·¨æ— éœ¸åº”ç”¨æ‹†è§£ä¸ºä¸€ä¸ªä¸ªç‹¬ç«‹çš„å¾®åº”ç”¨åº”ç”¨ï¼Œè€Œç”¨æˆ·åˆæ˜¯æ— æ„ŸçŸ¥çš„ï¼

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af88889843f944348039dca56679e7b0~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?) å¾®å‰ç«¯æ ¸å¿ƒåŸåˆ™ï¼š

-   æŠ€æœ¯æ ˆæ— å…³: ä¸»åº”ç”¨ä¸é™åˆ¶å­åº”ç”¨æ¥å…¥çš„æŠ€æœ¯æ ˆï¼Œæ¯ä¸ªåº”ç”¨çš„æŠ€æœ¯æ ˆé€‰å‹å¯ä»¥é…åˆä¸šåŠ¡æƒ…æ™¯é€‰æ‹©ã€‚
-   ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²ï¼šæ—¢å¯ä»¥ç»„åˆè¿è¡Œï¼Œä¹Ÿå¯ä»¥å•ç‹¬è¿è¡Œã€‚
-   ç¯å¢ƒéš”ç¦»ï¼šåº”ç”¨ä¹‹é—´ JavaScriptã€CSS éš”ç¦»é¿å…äº’ç›¸å½±å“
-   æ¶ˆæ¯é€šä¿¡ï¼šç»Ÿä¸€çš„é€šä¿¡æ–¹å¼ï¼Œé™ä½ä½¿ç”¨é€šä¿¡çš„æˆæœ¬
-   ä¾èµ–å¤ç”¨ï¼šè§£å†³ä¾èµ–ã€å…¬å…±é€»è¾‘éœ€è¦é‡å¤ç»´æŠ¤çš„é—®é¢˜

è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¾ªåºæ¸è¿›çš„è¿›è¡Œå·¨çŸ³åº”ç”¨çš„æ‹†è§£ï¼Œå»æŠ€æœ¯å‡çº§ã€å»æ¶æ„å°è¯•ã€å»ä¸šåŠ¡æ‹†è§£ç­‰ç­‰ã€‚ä»¥ä½æˆæœ¬ã€ä½é£é™©çš„è¿›è¡Œï¼Œ**ä¸ºé¡¹ç›®å¸¦æ¥æ›´å¤šå¯èƒ½æ€§**

**æˆ‘ä»¬çš„é¡¹ç›®é€‚ä¸é€‚åˆæ”¹é€ æˆå¾®å‰ç«¯é¡¹ç›®æ¨¡å¼ï¼Ÿ**

çœ‹æˆ‘ä»¬çš„é¡¹ç›®æ»¡è¶³ä¸æ»¡è¶³å¾®å‰ç«¯åŒ–ï¼Œå…ˆçœ‹èƒ½ä¸èƒ½æ»¡è¶³ä»¥ä¸‹å‡ ç‚¹å³å¯ã€‚

-   æ˜¯å¦æœ‰æ˜ç¡®çš„ä¸šåŠ¡è¾¹ç•Œï¼Œä¸šåŠ¡æ˜¯å¦é«˜åº¦é›†ä¸­ã€‚
-   ä¸šåŠ¡æ˜¯å¦é«˜åº¦è€¦åˆã€é¡¹ç›®æ˜¯å¦è¶³å¤Ÿåºå¤§åˆ°éœ€è¦æ‹†åˆ†ã€‚
-   å›¢é˜Ÿä¸­å­˜åœ¨å¤šä¸ªæŠ€æœ¯æ ˆå¹¶ä¸”æ— æ³•ç»Ÿä¸€ï¼Œéœ€è¦æ¥å…¥åŒä¸€å¥—ä¸»ç³»ç»Ÿã€‚
-   æŠ€æœ¯è€æ—§ï¼Œæ‰©å±•å›°éš¾ï¼Œç»´æŠ¤åƒåŠ›ä¸è®¨å¥½ã€‚
-   å¼€å‘ååŒã€éƒ¨ç½²ç»´æŠ¤ç­‰å·¥ä½œï¼Œæ•ˆç‡ä½ä¸‹ï¼Œä¸€ç€ä¸æ…ï¼Œæ»¡ç›˜çš†è¾“ã€‚

**æ³¨æ„ï¼šæ²¡æœ‰è¿«åˆ‡çš„éœ€æ±‚æ¥å…¥å¾®å‰ç«¯ï¼Œåªä¼šå¸¦æ¥é¢å¤–çš„è´Ÿæ‹…ï¼Œæˆ‘ä»¬è¦çŸ¥é“æˆ‘ä»¬ä½¿ç”¨å¾®å‰ç«¯æ˜¯ä¸ºäº†ä»€ä¹ˆï¼Ÿ**

## äºŒã€å¾®å‰ç«¯æŠ€æœ¯é€‰å‹

å¾®å‰ç«¯å®ç°æ–¹æ¡ˆå¯¹æ¯”

| æŠ€æœ¯æ–¹æ¡ˆ | æè¿° | æŠ€æœ¯æ ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | å•ç‹¬æ„å»º / éƒ¨ç½² | æ„å»ºé€Ÿåº¦ | SPA ä½“éªŒ | é¡¹ç›®ä¾µå…¥æ€§ | å­¦ä¹ æˆæœ¬ | é€šä¿¡éš¾åº¦ |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| iframe | æ¯ä¸ªå¾®åº”ç”¨ç‹¬ç«‹å¼€å‘éƒ¨ç½²ï¼Œé€šè¿‡ iframeçš„æ–¹å¼å°†è¿™äº›åº”ç”¨åµŒå…¥åˆ°çˆ¶åº”ç”¨ç³»ç»Ÿä¸­ | æ— é™åˆ¶ | 1\. æŠ€æœ¯æ ˆæ— å…³ï¼Œå­åº”ç”¨ç‹¬ç«‹æ„å»ºéƒ¨ç½²  
2\. å®ç°ç®€å•ï¼Œå­åº”ç”¨ä¹‹é—´è‡ªå¸¦æ²™ç®±ï¼Œå¤©ç„¶éš”ç¦»ï¼Œäº’ä¸å½±å“ | ä½“éªŒå·®ã€è·¯ç”±æ— æ³•è®°å¿†ã€é¡µé¢é€‚é…å›°éš¾ã€æ— æ³•ç›‘æ§ã€ä¾èµ–æ— æ³•å¤ç”¨ï¼Œå…¼å®¹æ€§ç­‰éƒ½å…·æœ‰å±€é™æ€§ï¼Œèµ„æºå¼€é”€å·¨å¤§ï¼Œé€šä¿¡å›°éš¾ | æ”¯æŒ | æ­£å¸¸ | ä¸æ”¯æŒ | é«˜ | ä½ | é«˜ |
| Nginx è·¯ç”±è½¬å‘ | é€šè¿‡Nginxé…ç½®å®ç°ä¸åŒè·¯å¾„æ˜ å°„åˆ°ä¸åŒåº”ç”¨ | æ— é™åˆ¶ | ç®€å•ã€å¿«é€Ÿã€æ˜“é…ç½® | åœ¨åˆ‡æ¢åº”ç”¨æ—¶è§¦å‘å‘é¡µé¢åˆ·æ–°ï¼Œé€šä¿¡ä¸æ˜“ | æ”¯æŒ | æ­£å¸¸ | ä¸æ”¯æŒ | æ­£å¸¸ | ä½ | é«˜ |
| Npm é›†æˆ | å°†å¾®åº”ç”¨æŠ½ç¦»æˆåŒ…çš„æ–¹å¼ï¼Œå‘å¸ƒNpmä¸­ï¼Œç”±çˆ¶åº”ç”¨ä¾èµ–çš„æ–¹å¼ä½¿ç”¨ï¼Œæ„å»ºæ—¶å€™é›†æˆè¿›é¡¹ç›®ä¸­ | æ— é™åˆ¶ | 1\. ç¼–è¯‘é˜¶æ®µçš„åº”ç”¨ï¼Œåœ¨é¡¹ç›®è¿è¡Œé˜¶æ®µæ— éœ€åŠ è½½ï¼Œä½“éªŒæµç•…  
2.å¼€å‘ä¸æ¥å…¥æˆæœ¬ä½ï¼Œå®¹æ˜“ç†è§£ | 1\. å½±å“ä¸»åº”ç”¨ç¼–è¯‘é€Ÿåº¦å’Œæ‰“åŒ…åçš„ä½“ç§¯  
2\. ä¸æ”¯æŒåŠ¨æ€ä¸‹å‘ï¼ŒnpmåŒ…æ›´æ–°åï¼Œéœ€è¦é‡æ–°æ›´æ–°åŒ…ï¼Œä¸»åº”ç”¨éœ€è¦é‡æ–°å‘å¸ƒéƒ¨ç½² | ä¸æ”¯æŒ | æ…¢ | æ”¯æŒ | é«˜ | é«˜ | æ­£å¸¸ |
| é€šç”¨ä¸­å¿ƒè·¯ç”±åŸºåº§å¼ | å¾®åº”ç”¨å¯ä»¥ä½¿ç”¨ä¸åŒæŠ€æœ¯æ ˆï¼›å¾®åº”ç”¨ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸ä¾èµ–ã€‚ç»Ÿä¸€ç”±åŸºåº§å·¥ç¨‹è¿›è¡Œç®¡ç†ï¼ŒæŒ‰ç…§DOMèŠ‚ç‚¹çš„æ³¨å†Œã€æŒ‚è½½ã€å¸è½½æ¥å®Œæˆã€‚ | æ— é™åˆ¶ | å­åº”ç”¨ç‹¬ç«‹æ„å»ºï¼Œç”¨æˆ·ä½“éªŒå¥½ï¼Œå¯æ§æ€§å¼ºï¼Œé€‚åº”å¿«é€Ÿè¿­ä»£ | å­¦ä¹ ä¸å®ç°çš„æˆæœ¬æ¯”è¾ƒé«˜ï¼Œéœ€è¦é¢å¤–å¤„ç†ä¾èµ–å¤ç”¨ | æ”¯æŒ | æ­£å¸¸ | æ”¯æŒ | é«˜ | é«˜ | æ­£å¸¸ |
| ç‰¹å®šä¸­å¿ƒè·¯ç”±åŸºåº§å¼ | å¾®åº”ç”¨ä¸šåŠ¡çº¿ä¹‹é—´ä½¿ç”¨ç›¸åŒæŠ€æœ¯æ ˆï¼›åŸºåº§å·¥ç¨‹å’Œå¾®åº”ç”¨å¯ä»¥å•ç‹¬å¼€å‘å•ç‹¬éƒ¨ç½²ï¼›å¾®åº”ç”¨æœ‰èƒ½åŠ›å¤ç”¨åŸºåº§å·¥ç¨‹çš„å…¬å…±åŸºå»ºã€‚ | ç»Ÿä¸€æŠ€æœ¯æ ˆ | å­åº”ç”¨ç‹¬ç«‹æ„å»ºï¼Œç”¨æˆ·ä½“éªŒå¥½ï¼Œå¯æ§æ€§å¼ºï¼Œé€‚åº”å¿«é€Ÿè¿­ä»£ | å­¦ä¹ ä¸å®ç°çš„æˆæœ¬æ¯”è¾ƒé«˜ï¼Œéœ€è¦é¢å¤–å¤„ç†ä¾èµ–å¤ç”¨ | æ”¯æŒ | æ­£å¸¸ | æ”¯æŒ | é«˜ | é«˜ | æ­£å¸¸ |
| webpack5 æ¨¡å—è”é‚¦ | webpack5 æ¨¡å—è”é‚¦ å»ä¸­å¿ƒæ¨¡å¼ã€è„±ç¦»åŸºåº§æ¨¡å¼ã€‚æ¯ä¸ªåº”ç”¨æ˜¯å•ç‹¬éƒ¨ç½²åœ¨å„è‡ªçš„æœåŠ¡å™¨ï¼Œæ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥å¼•ç”¨å…¶ä»–åº”ç”¨ï¼Œä¹Ÿèƒ½è¢«å…¶ä»–åº”ç”¨æ‰€å¼•ç”¨ | ç»Ÿä¸€æŠ€æœ¯æ ˆ | åŸºäºwebpack5ï¼Œæ— éœ€å¼•å…¥æ–°æ¡†æ¶ï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œåƒå¼•å…¥ç¬¬ä¸‰æ–¹åº“ä¸€æ ·æ–¹ä¾¿ï¼Œå„ä¸ªåº”ç”¨çš„èµ„æºéƒ½å¯ä»¥ç›¸äº’å…±äº«åº”ç”¨é—´æ¾è€¦åˆï¼Œå„åº”ç”¨å¹³è¡Œçš„å…³ç³» | éœ€è¦å‡çº§Webpack5æŠ€æœ¯æ ˆå¿…é¡»ä¿æŒä¸€è‡´æ”¹é€ æ—§é¡¹ç›®éš¾åº¦å¤§ | æ”¯æŒ | æ­£å¸¸ | æ”¯æŒ | ä½ | ä½ | æ­£å¸¸ |

å¯¹äºé€‰æ‹©å›°éš¾åŒå­¦æ¥è¯´ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹çº¬åº¦è¿›è¡Œæ–¹æ¡ˆæŠ€æœ¯çš„é€‰å‹

| å‚è€ƒçº¬åº¦ | æ˜¯å¦èƒ½æ”¯æŒæœªæ¥çš„è¿­ä»£ |
| --- | --- |
| ç¨³å®šæ€§ | è¯¥æ–¹æ¡ˆæ˜¯å¦ç»å†äº†ç¤¾åŒºçš„è€ƒéªŒï¼Œæœ‰è¾ƒå¤šçš„æˆç†Ÿæ¡ˆä¾‹ï¼ŒåŒæ—¶ä¿æŒè¾ƒé«˜çš„ æ´»è·ƒæ€§ |
| å¯æ‹“å±•æ€§ | æ”¯æŒå®šåˆ¶åŒ–å¼€å‘ï¼Œæä¾›è¾ƒé«˜çš„å¯æ‹“å±•èƒ½åŠ›ï¼ŒåŒæ—¶æˆæœ¬å¯ä»¥åœ¨æ¥å—èŒƒå›´å†… |
| å¯æ§æ€§ | å‘ç”Ÿé—®é¢˜åï¼Œèƒ½å¤Ÿåœ¨ç¬¬ä¸€æ—¶é—´å†…è¿›è¡Œé—®é¢˜æ’æŸ¥ï¼Œä»¥æœ€å¿«çš„å“åº”é€Ÿåº¦æ¥å¤„ç†é—®é¢˜ï¼Œä¿®å¤çš„æ–¹æ¡ˆæ˜¯å¦ä¼šä¾èµ–äºå¤–éƒ¨ç¯å¢ƒ |

å¸‚é¢æ¡†æ¶å¯¹æ¯”ï¼š

-   [magic-microservices](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fbytedance%2Fmagic-microservices "https://github.com/bytedance/magic-microservices") ä¸€æ¬¾åŸºäº Web Components çš„è½»é‡çº§çš„å¾®å‰ç«¯å·¥å‚å‡½æ•°ã€‚
-   [icestark](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fice-lab%2Ficestark "https://github.com/ice-lab/icestark") é˜¿é‡Œå‡ºå“ï¼Œæ˜¯ä¸€ä¸ªé¢å‘å¤§å‹ç³»ç»Ÿçš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆ
-   [single-spa](https://link.juejin.cn/?target=https%3A%2F%2Fsingle-spa.js.org%2F "https://single-spa.js.org/") æ˜¯ä¸€ä¸ªå°†å¤šä¸ªå•é¡µé¢åº”ç”¨èšåˆä¸ºä¸€ä¸ªæ•´ä½“åº”ç”¨çš„JavaScript å¾®å‰ç«¯æ¡†æ¶
-   [qiankun](https://link.juejin.cn/?target=https%3A%2F%2Fqiankun.umijs.org%2Fzh%2Fguide "https://qiankun.umijs.org/zh/guide") èš‚èšé‡‘æœå‡ºå“ï¼ŒåŸºäº single-spa åœ¨ single-spa çš„åŸºç¡€ä¸Šå°è£…
-   [EMP](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FefoxTeam%2Femp%2Fwiki "https://github.com/efoxTeam/emp/wiki") YYå‡ºå“ï¼ŒåŸºäºWebpack5 Module Federation é™¤äº†å…·å¤‡å¾®å‰ç«¯çš„èƒ½åŠ›å¤–ï¼Œè¿˜å®ç°äº†è·¨åº”ç”¨çŠ¶æ€å…±äº«ã€è·¨æ¡†æ¶ç»„ä»¶è°ƒç”¨çš„èƒ½åŠ›
-   [MicroApp](https://link.juejin.cn/?target=https%3A%2F%2Fzeroing.jd.com%2F "https://zeroing.jd.com/") äº¬ä¸œå‡ºå“ï¼Œä¸€æ¬¾åŸºäºWebComponentçš„æ€æƒ³ï¼Œè½»é‡ã€é«˜æ•ˆã€åŠŸèƒ½å¼ºå¤§çš„å¾®å‰ç«¯æ¡†æ¶

ç»¼åˆä»¥ä¸Šæ–¹æ¡ˆå¯¹æ¯”ä¹‹åï¼Œæˆ‘ä»¬ç¡®å®šé‡‡ç”¨äº† `qiankun` ç‰¹å®šä¸­å¿ƒè·¯ç”±åŸºåº§å¼çš„å¼€å‘æ–¹æ¡ˆï¼ŒåŸå› å¦‚ä¸‹ï¼š

-   ä¿è¯æŠ€æœ¯æ ˆç»Ÿä¸€ Vueã€å¾®åº”ç”¨ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ã€‚
-   å‹å¥½çš„â€œå¾®å‰ç«¯æ–¹æ¡ˆâ€œï¼Œä¸æŠ€æœ¯æ ˆæ— å…³æ¥å…¥ç®€å•ã€åƒiframeä¸€æ ·ç®€å•
-   æ”¹é€ æˆæœ¬ä½ï¼Œå¯¹ç°æœ‰å·¥ç¨‹ä¾µå…¥åº¦ã€ä¸šåŠ¡çº¿è¿ç§»æˆæœ¬ä¹Ÿè¾ƒä½ã€‚
-   å’ŒåŸæœ‰å¼€å‘æ¨¡å¼åŸºæœ¬æ²¡æœ‰ä¸åŒï¼Œå¼€å‘äººå‘˜å­¦ä¹ æˆæœ¬è¾ƒä½ã€‚
-   qiankun çš„å¾®å‰ç«¯æœ‰ 3 å¹´ä½¿ç”¨åœºæ™¯ä»¥åŠ Issue é—®é¢˜è§£å†³ç§¯ç´¯ï¼Œç¤¾åŒºä¹Ÿæ¯”è¾ƒæ´»è·ƒï¼Œåœ¨è¸©å‘çš„è·¯ä¸Šæ›´å®¹æ˜“è‡ªæ•‘ï½

## ä¸‰ã€ä½ éœ€è¦æ˜ç¡®çš„

> å¾®å‰ç«¯å¹¶ä¸æ˜¯ä¸‡èƒ½çš„â€è§£è¯â€œï¼Œæ²¡æœ‰æ­£ç¡®æ²»ç†ï¼Œæ‰€æœ‰çš„ codebase çš„å½’å®¿éƒ½æ˜¯â€å±å±±â€

-   **qiankunä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆï¼**
    
-   **qiankunä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆï¼ï¼**
    
-   **qiankunä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆï¼ï¼ï¼**
    

**1.å¾®å‰ç«¯çš„è¿è¡Œæ—¶å®¹å™¨**

-   qiankun æ‰€å¸®ä½ è§£å†³çš„è¿™ä¸€å—å®é™…ä¸Šæ˜¯å¾®å‰ç«¯çš„è¿è¡Œæ—¶å®¹å™¨ï¼Œè¿™æ˜¯æ•´ä¸ªå¾®å‰ç«¯å·¥ç¨‹åŒ–é‡Œé¢å…¶ä¸­ä¸€ä¸ªç¯èŠ‚
-   ä»è¿™ä¸ªè§’åº¦æ¥è®² qiankun ä¸ç®—æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯å¾®å‰ç«¯è¿è¡Œæ—¶å®¹å™¨çš„ä¸€ä¸ªå®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œå½“ä½ ç”¨äº† qiankun ä¹‹åï¼Œä½ å‡ ä¹èƒ½è§£å†³æ‰€æœ‰çš„å¾®å‰ç«¯è¿è¡Œæ—¶å®¹å™¨çš„é—®é¢˜ï¼Œä½†æ˜¯æ›´å¤šçš„ä¸€äº›æ¶‰åŠå·¥ç¨‹å’Œå¹³å°çš„é—®é¢˜ï¼Œåˆ™éœ€è¦æˆ‘ä»¬å»æ€è€ƒä¸å¤„ç†ã€‚
-   æˆ‘ä»¬çš„ç‰ˆæœ¬ç®¡æ§ã€é…ç½®ä¸‹å‘ã€ç›‘æ§å‘å¸ƒï¼Œå®‰å…¨æ£€æµ‹ã€ç­‰ç­‰è¿™äº›æ€ä¹ˆåšï¼Œéƒ½ä¸æ˜¯ qiankun ä½œä¸ºä¸€ä¸ªåº“æ‰€èƒ½è§£ç­”çš„ï¼Œè¿™äº›é—®é¢˜å¾—æ ¹æ®å…·ä½“æƒ…å†µï¼Œæ¥é€‰æ‹©é€‚åˆè‡ªå·±çš„è§£å†³æ–¹æ¡ˆ **2\. è¿ç§»æˆæœ¬**
-   å¯¹äºè€æ—§é¡¹ç›®çš„æ¥å…¥ï¼Œå¾ˆéš¾åšåˆ°é›¶æˆæœ¬è¿ç§»ï¼Œåœ¨å¼€å‘çš„æ—¶å€™è¦é¢„ç•™è¶³å¤Ÿçš„è¸©å‘ï¼Œé­”æ”¹ä»£ç çš„æ—¶é—´ã€‚å¦‚æœæ˜¯å·²ç»ç»´æŒå‡ å¹´å †å çš„å±å±±éœ€è¦åšå¥½å› ä¸ºä¸è§„èŒƒç¼–ç ï¼Œæ‰€äº§ç”Ÿçš„å„ç§å¥‡æ€ªçš„å…¼å®¹æ€§é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™ä½ ç”šè‡³ä¼šæ€€ç–‘ï¼Œâ€œå¾®å‰ç«¯æ˜¯å¦çœŸçš„æœ‰å¿…è¦?" **3\. æŠ€æœ¯æ ˆçš„é€‰æ‹©**
-   å¾®å‰ç«¯çš„æ ¸å¿ƒä¸æ˜¯å¤šæŠ€æœ¯å…±å­˜ï¼Œè€Œæ˜¯åˆ†è§£å¤æ‚åº¦ï¼Œæå‡åä½œæ•ˆç‡ï¼Œæ”¯æŒçµæ´»æ‰©å±•ï¼Œèƒ½æŠŠâ€œä¸€å †å¤æ‚çš„äº‹æƒ…â€å˜æˆâ€œç®€å•çš„ä¸€ä»¶äº‹æƒ…â€ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æ— è„‘ä½¿ç”¨çš„ï¼Œå¹¿ä¸œè¯æ¥è¯´â€œå¤šä¸ªé¦™ç‚‰å¤šåªé¬¼â€ï¼Œæ¯å¤šä¸€ä¸ªæŠ€æœ¯æ ˆéƒ½ä¼šå¢åŠ ï¼šç»´æŠ¤æˆæœ¬ï¼Œå…¼å®¹æˆæœ¬ï¼Œèµ„æºå¼€é”€æˆæœ¬ï¼Œè¿™äº›éƒ½ä¼šæ— å½¢çš„æ‹–ç´¯ç”Ÿäº§åŠ›ã€‚
-   åŸºåº§åº”ç”¨ä¸å¾®åº”ç”¨ä¹‹é—´ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨ç›¸åŒçš„æŠ€æœ¯æ ˆï¼Œç›¸åŒçš„æŠ€æœ¯æ ˆå¯ä»¥å®ç°å…¬å…±ä¾èµ–åº“ã€UIåº“ç­‰æŠ½ç¦»ï¼Œå‡å°‘èµ„æºå¼€é”€ï¼Œæå‡åŠ è½½é€Ÿåº¦ï¼Œæœ€é‡è¦çš„æ˜¯ï¼šâ€œå‡å°‘å†²çªçš„æœ€å¥½æ–¹å¼å°±æ˜¯ç»Ÿä¸€â€ï¼Œé€šè¿‡çº¦æŸæŠ€æœ¯æ ˆå¯ä»¥å°½å¯èƒ½çš„å‡å°‘é¡¹ç›®ä¹‹é—´çš„å†²çªï¼Œå‡å°‘å·¥ä½œé‡ä¸ç»´æŠ¤æˆæœ¬ã€‚

**4\. å¾®å‰ç«¯åˆå°è¯•**

-   å¯¹äºå¾®å‰ç«¯çš„æ¥å…¥æœ€å¥½çš„æ—¶å€™å°±æ˜¯ï¼Œåˆšå¼€å§‹ä¸ä¹…æˆ–é‡è¦æ€§ä¸æ˜¯ç‰¹åˆ«å¼ºçš„é¡¹ç›®ï¼Œä¸€æ–¹é¢é¡¹ç›®å…·å¤‡å…¼å®¹å¾®å‰ç«¯çš„å·¥ç¨‹èƒ½åŠ›ï¼Œå¦ä¸€æ–¹é¢é¡¹ç›®ä½¿ç”¨å¾®å‰ç«¯æ–¹æ¡ˆçš„æˆæœ¬æœ€ä½ï¼Œä¸éœ€è¦æ”¹å¤ªå¤šä»£ç 
-   å¯¹äºè€æ—§é¡¹ç›®çš„æ¥å…¥å»ºè®®è¿˜æ˜¯ä»è¾¹ç¼˜ç®€å•çš„æ¨¡ç‰ˆå…¥æ‰‹ï¼Œé€æ­¥åˆ†è§£ã€‚

**7\. æ ‡å‡†åŒ–æ‰èƒ½æå‡ç”Ÿäº§åŠ›**

-   æ··ä¹±çš„é¡¹ç›®ä¼šæ‹–ç´¯ç”Ÿäº§æ•ˆç‡ï¼ŒåŒæ—¶æ··ä¹±çš„å¾®å‰ç«¯ä¹Ÿä¼šåŠ å‰§å†…è€—ï¼Œæ‰€ä»¥åªæœ‰æ ‡å‡†åŒ–æ‰èƒ½æå‡ç”Ÿäº§åŠ›ã€‚
-   è§£å†³å¾®å‰ç«¯çš„æ¥å…¥é—®é¢˜æ˜¯æœ€ç®€å•çš„ï¼Œä½†æ˜¯å¾®å‰ç«¯æ¥å…¥åçš„ï¼šå·¥ç¨‹åŒ–ï¼Œåº”ç”¨ç›‘æ§ï¼Œåº”ç”¨è§„èŒƒï¼Œåº”ç”¨ç®¡ç†æ‰æ˜¯å¾®å‰ç«¯ä¸­å›°éš¾çš„åœ°æ–¹ï¼Œå¦‚æœä½ åªæ˜¯æƒ³ç®€å•çš„åµŒå…¥ä¸€ä¸ªåº”ç”¨ï¼Œæˆ‘æ¨èä½ çš„ä½¿ç”¨ â€iframeâ€œ

**9\. qiankun ä¸æ”¯æŒ Vite ï¼ï¼ï¼**

-   [ğŸš€ Link github æœªæ¥æ˜¯å¦è€ƒè™‘æ”¯æŒ vite](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fumijs%2Fqiankun%2Fissues%2F1257 "https://github.com/umijs/qiankun/issues/1257")
-   ä¸å»ºè®®å°è¯•å»æ”¹å˜ç›®å‰çš„ qiankunï¼ŒViteçš„æ”¹é€ æˆæœ¬çœŸçš„å¤ªé«˜äº†ï¼Œè™½ç„¶webpack æ¯”Viteæ…¢ï¼Œä½†æ˜¯ç»è¿‡æ‹†åˆ†çš„åº”ç”¨å†…å®¹å·²ç»å¾ˆå°äº†ï¼Œä¸ä¼šå¯¹é¡¹ç›®æœ‰å¤ªå¤§çš„æ‹–ç´¯ã€‚

**10\. qiankunå¹¶ä¸éš¾**

-   å¯¹äºqiankunçš„å­¦ä¹ å…¶å®å¤§å®¶ä¸ç”¨å¾ˆæ‹…å¿ƒï¼Œå¥½åƒä¸€å¬å¾®å‰ç«¯å°±å¾ˆéš¾çš„æ ·å­ã€‚å› ä¸º qiankun çœŸçš„å¾ˆç®€å•æ»¡æ‰“æ»¡ç®— 10ä¸ªAPI éƒ½æ²¡æœ‰ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€èµ·èµ°è¿›qiankunçš„ä¸–ç•Œå§ï½ï½
-   [ğŸš€ Link qiankun å®˜ç½‘æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Fwww.notion.so%2Fqiankun-b3c5400cf09947d2b0ede7cf523d0030%23085e131f03d143c6a3005f331583caac "https://www.notion.so/qiankun-b3c5400cf09947d2b0ede7cf523d0030#085e131f03d143c6a3005f331583caac")

## å››ã€å¾®åº”ç”¨æ‹†åˆ†è§„åˆ™

> å¾®åº”ç”¨çš„æ‹†ä¸åˆæ€è€ƒï¼šæ‹†çš„æ˜¯ç³»ç»Ÿå¤æ‚åº¦ï¼Œåˆçš„æ˜¯ç³»ç»Ÿå¤ç”¨åº¦ æ ¸å¿ƒåŸåˆ™ï¼šé«˜å†…èšï¼Œä½è€¦åˆ

å¾®åº”ç”¨çš„æ‹†è§£æ²¡æœ‰å…·ä½“è§„åˆ™ï¼Œä½†æ˜¯ä»¥ä¸‹è§„åˆ™åº”è¯¥å¯ä»¥ç»™ä½ åœ¨è¿›è¡Œç³»ç»Ÿæ‹†åˆ†æ—¶æä¾›ä¸€äº›ä¾æ®ã€‚

1.  **â€œå°½é‡å‡å°‘å½¼æ­¤çš„é€šä¿¡å’Œä¾èµ–â€œ**ï¼Œå¾®å‰ç«¯çš„é€šä¿¡äº¤äº’ã€é“¾æ¥è·³è½¬ç­‰æ“ä½œæ‰€å¸¦æ¥ç­‰æˆæœ¬å…¶å®æ˜¯å¾ˆå¤§çš„ï¼Œæ‰€ä»¥åœ¨æ‹†åˆ†çš„æ—¶å€™å°½é‡â€œå®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸ä¾èµ–â€
    
2.  å¾®åº”ç”¨çš„æ‹†åˆ†çš„æ—¶å€™**åˆ‡å¿Œâ€œç›²ç›®ç»†è‡´æ‹†åˆ†â€**ï¼Œè¿‡åº¦æ‹†åˆ†ä¼šå¯¼è‡´ â€œåšçš„å¾ˆç‰›é€¼ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨çš„å›°å±€â€ï¼Œå¾®åº”ç”¨çš„æ‹†åˆ†å¹¶ä¸æ˜¯ä¸€æ­¥åˆ°ä½çš„ï¼Œæˆ‘ä»¬è¦æ ¹æ®å®é™…æƒ…å†µé€æ­¥æ‹†åˆ†ã€‚å¦‚æœä¸€å¼€å§‹ä¸çŸ¥é“åº”è¯¥åˆ’åˆ†å¤šç»†ï¼Œå¯ä»¥å…ˆç²—ç²’åº¦åˆ’åˆ†ï¼Œç„¶åéšç€éœ€æ±‚çš„å‘å±•ï¼Œé€æ­¥æ‹†åˆ†ã€‚
    
    -   å¦‚ï¼šç°åœ¨æœ‰ä¸€ä¸ªå”®åç®¡ç†ç³»ç»Ÿï¼Œæˆ‘ä»¬æŒ‰ä¸šåŠ¡çº¿æ‹†åˆ†ä¸ºï¼šå®¢æœç®¡ç†ï¼Œåº“å­˜ç®¡ç†ï¼Œç‰©æµç®¡ç†ï¼Œæœªæ¥å®¢æœç®¡ç†éœ€æ±‚åŠŸèƒ½æŒç»­åºå¤§å†æ‹†è§£ä¸ºï¼šæ™ºèƒ½å®¢æœã€ç”µè¯å®¢æœã€åœ¨çº¿å®¢æœã€‚è€Œè¿™äº›å®¢æœï¼Œåˆå¯ä»¥åµŒå…¥ä¾›åº”å•†ç®¡ç†ä¸­å¿ƒï¼Œå•†å“ç®¡ç†ä¸­å¿ƒ ç­‰é¡¹ç›®ä½¿ç”¨ã€‚
3.  åœ¨æ‹†åˆ†çš„æ—¶å€™æˆ‘ä»¬åº”è¯¥å°½é‡è€ƒè™‘æœªæ¥åœºæ™¯ï¼šæ¸å˜å¼æŠ€æœ¯æ ˆè¿ç§»ï¼Œå‰ç«¯åº”ç”¨èšåˆã€å¤šç³»ç»Ÿä¸šåŠ¡å¤ç”¨ï¼Œå¦‚ä½•åšä¸šåŠ¡è§£è€¦å’Œä»£ç å¤ç”¨ã€‚
    
4.  åº”ç”¨ä¹‹é—´åº”è¯¥å°½é‡è§£è€¦ï¼Œå­åº”ç”¨çš„äº‹æƒ…å°±åº”è¯¥ç”±å­åº”ç”¨æ¥åšã€‚
    
    -   å¦‚ï¼šå­åº”ç”¨çš„ä¸€äº›æ ‡è¯†ï¼Œå¦‚ï¼šè·¯ç”±å‰ç¼€ï¼Œåº”ç”¨åç§°ï¼Œæ ¹èŠ‚ç‚¹å®¹å™¨åç§°ï¼Œä¾èµ–åº“çš„ä½¿ç”¨
    -   éœ€è¦æ˜ç¡®ä»€ä¹ˆæ˜¯å­åº”ç”¨åº”è¯¥ç»´æŠ¤çš„ï¼Œä»€ä¹ˆæ˜¯çˆ¶åº”ç”¨åº”è¯¥ç»´æŠ¤çš„ï¼Œå¦‚æœä»€ä¹ˆèµ„æºéƒ½ä¸€è‚¡è„‘çš„ä½¿ç”¨çˆ¶åº”ç”¨ä¸‹å‘ï¼Œåˆ™ä¼šå¯¼è‡´åº”ç”¨ä¹‹é—´è€¦åˆä¸¥é‡ã€‚

**å»ºè®®æŒ‰ç…§ä¸šåŠ¡åŸŸæ¥åšæ‹†åˆ†**

1.  ä¿æŒæ ¸å¿ƒä¸šåŠ¡çš„ç‹¬ç«‹æ€§ï¼ŒæŠŠæ— å…³çš„å­ä¸šåŠ¡æ‹†åˆ†è§£è€¦ã€‚ä¸šåŠ¡ä¹‹é—´å¼€å‘äº’ä¸å½±å“ï¼Œä¸šåŠ¡ä¹‹é—´å¯æ‹†è§£å¾®åº”ç”¨ï¼Œå•ç‹¬æ‰“åŒ…ï¼Œå•ç‹¬éƒ¨ç½²ã€‚
2.  ä¸šåŠ¡å…³è”ç´§å¯†çš„åŠŸèƒ½å•å…ƒåº”è¯¥åšæˆä¸€ä¸ªå¾®åº”ç”¨ã€åä¹‹å…³è”ä¸ç´§å¯†çš„å¯ä»¥è€ƒè™‘æ‹†åˆ†æˆå¤šä¸ªå¾®åº”ç”¨ï¼Œåˆ¤æ–­ä¸šåŠ¡å…³è”æ˜¯å¦ç´§å¯†çš„æ ‡å‡†ï¼šçœ‹è¿™ä¸ªå¾®åº”ç”¨ä¸å…¶ä»–å¾®åº”ç”¨æ˜¯å¦æœ‰é¢‘ç¹çš„é€šä¿¡éœ€æ±‚ã€‚
3.  å¦‚æœæœ‰å¯èƒ½è¯´æ˜è¿™ä¸¤ä¸ªå¾®åº”ç”¨æœ¬èº«å°±æ˜¯æœåŠ¡äºåŒä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼Œåˆå¹¶æˆä¸€ä¸ªå¾®åº”ç”¨å¯èƒ½ä¼šæ›´åˆé€‚ã€‚
4.  åˆ†æå¹³å°å·®å¼‚ï¼Œå¹³å°å·®å¼‚å¤§å¯ä»¥æ ¹æ®å¹³å°ç‰¹æ€§æ‹†åˆ†
5.  åˆ†æé¡µé¢ç»“æ„ï¼Œå¦‚æœç»“æ„æ¸…æ™°ï¼Œå¯ä»¥æ ¹æ®ç»“æ„æ‹†åˆ†
6.  åˆ†æäº§å“ä¸šåŠ¡ï¼Œå°†äº§å“é€»è¾‘è€¦åˆåº¦é«˜çš„åŠŸèƒ½åˆå¹¶åˆ°ä¸€èµ·

## äº”ã€å¼•å…¥qiankun - åœ¨ä¸»åº”ç”¨ä¸­æ³¨å†Œå¾®åº”ç”¨

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97d5e4583ef24a68995328f1ef0025df~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

**é€‰æ‹©åŸºåº§çš„æ¨¡å¼ï¼Ÿ**

1.  **é€šç”¨ä¸­å¿ƒè·¯ç”±åŸºåº§å¼ï¼šåªæœ‰å…¬å…±åŠŸèƒ½çš„ä¸»åº”ç”¨**(èœå•æ ã€ç™»å½•ã€é€€å‡º...)ä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘
2.  **ç‰¹å®šä¸­å¿ƒè·¯ç”±åŸºåº§å¼ï¼š ä¸€ä¸ªå«ä¸šåŠ¡ä»£ç çš„é¡¹ç›®**ä½œä¸ºåŸºåº§ï¼Œæ‰€æœ‰æ–°åŠŸèƒ½ä½œä¸ºå­åº”ç”¨å¼•å…¥

ä»¥ä¸‹æ¡ˆä¾‹æ˜¯ä»¥VueæŠ€æœ¯æ ˆä½œä¸ºåº”ç”¨æŠ€æœ¯æ ˆï¼Œå»ºè®®åº”ç”¨ä¹‹é—´è¿˜æ˜¯ç»Ÿä¸€æŠ€æœ¯æ ˆï¼Œé™ä½ç»´æŠ¤ã€ä¸Šæ‰‹ã€å­¦ä¹ æˆæœ¬ã€‚è¶Šæ˜¯ä¸åŒæŠ€æœ¯ã€ä¸åŒåº“çš„ç‰ˆæœ¬ä¸åŒéœ€è¦åšçš„å¤„ç†å°±è¶Šæ›´å¤šã€‚

## **qiankun æ³¨å†Œå¾®åº”ç”¨çš„æ–¹å¼ï¼š**

### **ğŸ’«è‡ªåŠ¨æ¨¡å¼ï¼šä½¿ç”¨ registerMicroApps + startï¼Œè·¯ç”±å˜åŒ–åŠ è½½å¾®åº”ç”¨**

-   å½“å¾®åº”ç”¨ä¿¡æ¯æ³¨å†Œå®Œä¹‹åï¼Œä¸€æ—¦æµè§ˆå™¨çš„ url å‘ç”Ÿå˜åŒ–ï¼Œä¾¿ä¼šè‡ªåŠ¨è§¦å‘ qiankun çš„åŒ¹é…

1.  é¦–æ¬¡loadåº”ç”¨ï¼Œåˆ›å»ºå­åº”ç”¨å®ä¾‹ï¼Œæ¸²æŸ“ã€‚
2.  åˆ‡åˆ°å…¶ä»–å­åº”ç”¨ååˆ‡å›ï¼Œä¼šé‡æ–°åˆ›å»ºæ–°çš„å­åº”ç”¨å®ä¾‹å¹¶æ¸²æŸ“ã€‚
3.  ä¹‹å‰çš„å­åº”ç”¨å®ä¾‹ qiankun ç›´æ¥ä¸è¦äº†ï¼Œå³ä½¿ä½ æ²¡æœ‰æ‰‹åŠ¨é”€æ¯å®ä¾‹ã€‚
4.  é‡‡ç”¨è¿™ç§æ¨¡å¼çš„è¯ ä¸€å®šè¦åœ¨å­åº”ç”¨æš´éœ²çš„ unmount é’©å­é‡Œæ‰‹åŠ¨é”€æ¯å®ä¾‹ï¼Œä¸ç„¶ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

-   activeRule -Â `string | (location: Location) => boolean | Array<string | (location: Location) => boolean>`Â å¿…é€‰ï¼Œå¾®åº”ç”¨çš„æ¿€æ´»è§„åˆ™ã€‚
    
-   æ”¯æŒç›´æ¥é…ç½®å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²æ•°ç»„ï¼Œå¦‚Â `activeRule: '/app1'`Â æˆ–Â `activeRule: ['/app1', '/app2']`ï¼Œå½“é…ç½®ä¸ºå­—ç¬¦ä¸²æ—¶ä¼šç›´æ¥è·Ÿ url ä¸­çš„è·¯å¾„éƒ¨åˆ†åšå‰ç¼€åŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸè¡¨æ˜å½“å‰åº”ç”¨ä¼šè¢«æ¿€æ´»ã€‚
    
-   æ”¯æŒé…ç½®ä¸€ä¸ª active function å‡½æ•°æˆ–ä¸€ç»„ active functionã€‚å‡½æ•°ä¼šä¼ å…¥å½“å‰ location ä½œä¸ºå‚æ•°ï¼Œå‡½æ•°è¿”å› true æ—¶è¡¨æ˜å½“å‰å¾®åº”ç”¨ä¼šè¢«æ¿€æ´»ã€‚å¦‚Â `location => location.pathname.startsWith('/app1')`
    

1.  **è‡ªåŠ¨æŒ‚è½½ï¼šregisterMicroApps + start**

```
yarn add qiankun // psï¼šåªéœ€è¦ä¸»åº”ç”¨å®‰è£…å³å¯
å¤åˆ¶ä»£ç 
```

```
// ä¸»åº”ç”¨/scr/main.js 
import { registerMicroApps, start } from 'qiankun';

// 1. è·å–å¾®åº”ç”¨é…ç½®
const MICRO_CONFIG = [
  {
    name: 'vue app', // åº”ç”¨çš„åå­— å¿…å¡« å”¯ä¸€
    entry: '//localhost:7100', // é»˜è®¤ä¼šåŠ è½½è¿™ä¸ªhtml è§£æé‡Œé¢çš„js åŠ¨æ€çš„æ‰§è¡Œ ï¼ˆå­åº”ç”¨å¿…é¡»æ”¯æŒè·¨åŸŸï¼‰fetch
    container: '#yourContainer', // æŒ‚è½½å…·ä½“å®¹å™¨ ID
     // 3. æ ¹æ®è·¯ç”±åŒ¹é…ï¼Œæ¿€æ´»çš„å­åº”ç”¨
    activeRule: '/yourActiveRule',
    props: {
        xxxx: '/' // ä¸‹å‘ç»™å­åº”ç”¨
    }
  }
]

// 2. æ³¨å†Œå¾®åº”ç”¨
registerMicroApps(MICRO_CONFIG)

start() // å¯åŠ¨å¾®æœåŠ¡
å¤åˆ¶ä»£ç 
```

**activeRule è§„åˆ™ç¤ºä¾‹ï¼šæ­¤å¤„æ‹¿å®˜ç½‘çš„ä¸¾ä¾‹ï½** ctiveRuleï¼š`'/app1'`

-   **âœ…Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp1 "https://app.com/app1")[app.com/app1](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp1 "https://app.com/app1")**
-   **âœ…Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp1%2Fanything%2Feverything "https://app.com/app1/anything/everything")[app.com/app1/anythiâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp1%2Fanything%2Feverything "https://app.com/app1/anything/everything")**
-   ğŸš«Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp2 "https://app.com/app2")[app.com/app2](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp2 "https://app.com/app2")activeRuleï¼š

activeRuleï¼š`'/users/:userId/profile'`

-   **âœ…Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fusers%2F123%2Fprofile "https://app.com/users/123/profile")[app.com/users/123/pâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fusers%2F123%2Fprofile "https://app.com/users/123/profile")**
-   **âœ…Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fusers%2F123%2Fprofile%2Fsub-profile%2F "https://app.com/users/123/profile/sub-profile/")[app.com/users/123/pâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fusers%2F123%2Fprofile%2Fsub-profile%2F "https://app.com/users/123/profile/sub-profile/")**
-   ğŸš«Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fusers%2F%2Fprofile%2Fsub-profile%2F "https://app.com/users//profile/sub-profile/")[app.com/users//profâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fusers%2F%2Fprofile%2Fsub-profile%2F "https://app.com/users//profile/sub-profile/")
-   ğŸš«Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fusers%2Fprofile%2Fsub-profile%2F "https://app.com/users/profile/sub-profile/")[app.com/users/profiâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fusers%2Fprofile%2Fsub-profile%2F "https://app.com/users/profile/sub-profile/")

activeRuleï¼š`'/pathname/#/hash'`

-   **âœ…Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%2F%23%2Fhash "https://app.com/pathname/#/hash")[app.com/pathname/#/â€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%2F%23%2Fhash "https://app.com/pathname/#/hash")**
-   **âœ…Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%2F%23%2Fhash%2Froute%2Fnested "https://app.com/pathname/#/hash/route/nested")[app.com/pathname/#/â€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%2F%23%2Fhash%2Froute%2Fnested "https://app.com/pathname/#/hash/route/nested")**
-   ğŸš«Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%23%2Fhash%2Froute%2Fnested "https://app.com/pathname#/hash/route/nested")[app.com/pathname#/hâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%23%2Fhash%2Froute%2Fnested "https://app.com/pathname#/hash/route/nested")
-   ğŸš«Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%23%2Fanother-hash "https://app.com/pathname#/another-hash")[app.com/pathname#/aâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%23%2Fanother-hash "https://app.com/pathname#/another-hash")

activeRuleï¼š`['/pathname/#/hash', '/app1']`

-   **âœ…Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%2F%23%2Fhash%2Froute%2Fnested "https://app.com/pathname/#/hash/route/nested")[app.com/pathname/#/â€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%2F%23%2Fhash%2Froute%2Fnested "https://app.com/pathname/#/hash/route/nested")**
    
-   **âœ…Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp1%2Fanything%2Feverything "https://app.com/app1/anything/everything")[app.com/app1/anythiâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp1%2Fanything%2Feverything "https://app.com/app1/anything/everything")**
    
-   ğŸš«Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%2Fapp1 "https://app.com/pathname/app1")[app.com/pathname/apâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fpathname%2Fapp1 "https://app.com/pathname/app1")
    
-   ğŸš«Â [](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp2 "https://app.com/app2")[app.com/app2](https://link.juejin.cn/?target=https%3A%2F%2Fapp.com%2Fapp2 "https://app.com/app2")
    
-   ğŸ’¡ å½“å¾®åº”ç”¨ä¿¡æ¯æ³¨å†Œå®Œä¹‹åï¼Œä¸€æ—¦æµè§ˆå™¨çš„ url å‘ç”Ÿå˜åŒ–ï¼Œä¾¿ä¼šè‡ªåŠ¨è§¦å‘ qiankun çš„åŒ¹é…é€»è¾‘ã€‚ æ‰€æœ‰ activeRule è§„åˆ™åŒ¹é…ä¸Šçš„å¾®åº”ç”¨å°±ä¼šè¢«æ’å…¥åˆ°æŒ‡å®šçš„ container ä¸­ï¼ŒåŒæ—¶ä¾æ¬¡è°ƒç”¨å¾®åº”ç”¨æš´éœ²å‡ºçš„ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚
    

### **ğŸ’ªæ‰‹åŠ¨æ¨¡å¼ï¼šä½¿ç”¨ loadMicroApp æ‰‹åŠ¨æ³¨å†Œå¾®åº”ç”¨**

1.  æ¯ä¸ªå­åº”ç”¨éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„å®ä¾‹IDï¼Œreloadæ—¶ä¼šå¤ç”¨ä¹‹å‰çš„å®ä¾‹
2.  å¦‚æœéœ€è¦å¸è½½åˆ™éœ€è¦æ‰‹åŠ¨å¸è½½ **xxxMicroApp.unmount()**

ç”±äºregisterMicroAppsçš„ç‰¹æ€§ï¼Œä¼šå¯¼è‡´è·¯ç”±çš„keep alive å¤±æ•ˆï¼Œæ•…æœ¬æ–‡ä½¿ç”¨ loadMicroAp + router.beforeEach è¿›è¡Œæ¥è¾¾åˆ°è‡ªåŠ¨æ³¨å†Œçš„ç›®çš„ã€‚

å¦‚æœå¾®åº”ç”¨ä¸æ˜¯ç›´æ¥è·Ÿè·¯ç”±å…³è”çš„æ—¶å€™ï¼Œä½ å¯ä»¥é€‰æ‹©æ‰‹åŠ¨åŠ è½½å¾®åº”ç”¨çš„æ–¹å¼ä¼šæ›´åŠ çµæ´»ã€‚

**æ‰‹åŠ¨æŒ‚è½½: loadMicroApps**

```
// ä»»æ„é¡µé¢éƒ½å¯ä»¥æ³¨å†Œ

import { loadMicroApp } from 'qiankun';

// è·å–åº”ç”¨é…ç½®å¹¶æ‰‹åŠ¨æŒ‚è½½ï¼ŒæŒ‚è½½åè¿”å›æŒ‚è½½å¯¹è±¡
this.microApp = loadMicroApp({
    name: 'vue app', // åº”ç”¨çš„åå­— å¿…å¡« å”¯ä¸€
    entry: '//localhost:7100', // é»˜è®¤ä¼šåŠ è½½è¿™ä¸ªhtml è§£æé‡Œé¢çš„js åŠ¨æ€çš„æ‰§è¡Œ ï¼ˆå­åº”ç”¨å¿…é¡»æ”¯æŒè·¨åŸŸï¼‰fetch
    container: '#yourContainer', // æŒ‚è½½å…·ä½“å®¹å™¨ ID
    activeRule: '/yourActiveRule', // æ ¹æ®è·¯ç”± æ¿€æ´»çš„å­åº”ç”¨
    props: {
        xxxx: '/' // ä¸‹å‘ç»™å­åº”ç”¨
    }
})

this.microApp.unmount() // æ‰‹åŠ¨é”€æ¯ï½
å¤åˆ¶ä»£ç 
```

## å…­ã€å¾®åº”ç”¨æŒ‚è½½èŠ‚ç‚¹

> å¾®åº”ç”¨å¯ä»¥æŒ‚è½½åœ¨é¡µé¢çš„ä»»æ„ä½ç½®ï¼Œå¾®åº”ç”¨ã€å¾®é¡¹ç›®ã€å¾®é¡µé¢ã€å¾®ç»„ä»¶ï¼Œä¸€åˆ‡çš†æœ‰å¯èƒ½ã€‚

-   å¾®åº”ç”¨ä¸¤ç§å¸¸è§çš„æŒ‚è½½åœºæ™¯

**ç¬¬ä¸€ç§ï¼šè·¯ç”±é¡µå†…æŒ‚è½½ï¼ŒæŠŠå­åº”ç”¨å†…åµŒé¡µå…¥ä½¿ç”¨** ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/275121d9fb1e4c46890185f1bf8fee46~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

```
// ä¸»åº”ç”¨/src/views/About.vue
<template>
  <div class="about">
    <div id="sub-app-container"></div>
  </div>
</template>
å¤åˆ¶ä»£ç 
```

**ç¬¬äºŒç§ï¼šæ ¹DOMä¸­ä¸ä¸»åº”ç”¨åŒçº§æŒ‚è½½ï¼Œåˆ‡æ¢çš„æ—¶å€™éšè—åº”ç”¨ï¼Œæ˜¾ç¤ºå½“å‰åº”ç”¨** ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/32192c83af23413eaa58fd981d2cd1e0~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

```
// ä¸»åº”ç”¨/scr/App.vue
<template>
    <div id="app">
        <!-- ä¸åŒçš„å¾®åº”ç”¨ -->
        <div v-show="location.hash.startsWith('#/operation')" id="sub-operation-container"></div>
        <div v-show="location.hash.startsWith('#/inventory')" id="sub-inventory-container"></div>
    </div>
</template>
å¤åˆ¶ä»£ç 
```

## ä¸ƒã€åº”ç”¨åŠ è½½è§£ææµç¨‹å›¾

> ç®€æ˜“çš„å›¾ç¤ºäº†qiankunæ˜¯å¦‚ä½•é€šè¿‡ import-html-entry åŠ è½½å¾®åº”ç”¨çš„

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98841372345c42289a2a34c409626d60~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

ç®€æ˜“æµç¨‹ï¼š

1.  qiankun ä¼šç”¨ åŸç”Ÿfetchæ–¹æ³•ï¼Œè¯·æ±‚å¾®åº”ç”¨çš„ entry è·å–å¾®åº”ç”¨èµ„æºï¼Œç„¶åé€šè¿‡ response.text æŠŠè·å–å†…å®¹è½¬ä¸ºå­—ç¬¦ä¸²ã€‚
2.  å°† HTML å­—ç¬¦ä¸²ä¼ å…¥ [processTpl](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fkuitos%2Fimport-html-entry%2Fblob%2F76df4b3737d54112f6bf2dfabcd01709079468e4%2Fsrc%2Fprocess-tpl.js%23L58 "https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fkuitos%2Fimport-html-entry%2Fblob%2F76df4b3737d54112f6bf2dfabcd01709079468e4%2Fsrc%2Fprocess-tpl.js%23L58") å‡½æ•°ï¼Œè¿›è¡Œ HTML æ¨¡æ¿è§£æï¼Œé€šè¿‡æ­£åˆ™åŒ¹é… HTML ä¸­å¯¹åº”çš„ javaScriptï¼ˆå†…è”ã€å¤–è”ï¼‰ã€cssï¼ˆå†…è”ã€å¤–è”ï¼‰ã€ä»£ç æ³¨é‡Šã€entryã€ignore æ”¶é›†å¹¶æ›¿æ¢ï¼Œå»é™¤ `html/head/body` ç­‰æ ‡ç­¾ï¼Œå…¶ä»–èµ„æºä¿æŒåŸæ ·
3.  å°†æ”¶é›†çš„ `styles` å¤–é“¾URLå¯¹è±¡é€šè¿‡ fetch è·å– cssï¼Œå¹¶å°† css å†…å®¹ä»¥ `<style>` çš„æ–¹å¼æ›¿æ¢åˆ°åŸæ¥ linkæ ‡ç­¾çš„ä½ç½®
4.  æ”¶é›† script å¤–é“¾å¯¹è±¡ï¼Œå¯¹äºå¼‚æ­¥æ‰§è¡Œçš„ JavaScript èµ„æºä¼šæ‰“ä¸Š `async` æ ‡è¯† ï¼Œä¼šä½¿ç”¨ [requestIdleCallback](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fkuitos%2Fimport-html-entry%2Fblob%2F76df4b3737d54112f6bf2dfabcd01709079468e4%2Fsrc%2Findex.js%23L104 "https://github.com/kuitos/import-html-entry/blob/76df4b3737d54112f6bf2dfabcd01709079468e4/src/index.js#L104") æ–¹æ³•å»¶è¿Ÿæ‰§è¡Œã€‚
5.  æ¥ä¸‹æ¥ä¼šåˆ›å»ºä¸€ä¸ªåŒ¿åè‡ªæ‰§è¡Œå‡½æ•°åŒ…è£¹ä½è·å–åˆ°çš„ js å­—ç¬¦ä¸²ï¼Œæœ€åé€šè¿‡ eval å»åˆ›å»ºä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡æ‰§è¡Œ js ä»£ç ï¼Œé€šè¿‡ä¼ å…¥ proxy æ”¹å˜ window æŒ‡å‘ï¼Œå®Œæˆ JavaScript æ²™ç®±éš”ç¦»ã€‚[æºç ä½ç½®](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fkuitos%2Fimport-html-entry%2Fblob%2F76df4b3737d54112f6bf2dfabcd01709079468e4%2Fsrc%2Findex.js%23L45 "https://github.com/kuitos/import-html-entry/blob/76df4b3737d54112f6bf2dfabcd01709079468e4/src/index.js#L45")ã€‚
6.  ç”±äº qiankun æ˜¯è‡ªæ‰§è¡Œå‡½æ•°æ‰§è¡Œå¾®åº”ç”¨çš„ JavaScriptï¼Œå› æ­¤åœ¨åŠ è½½åçš„å¾®åº”ç”¨ä¸­æ˜¯çœ‹ä¸åˆ° JavaScript èµ„æºå¼•ç”¨çš„ï¼Œåªæœ‰ä¸€ä¸ªèµ„æºè¢«æ‰§è¡Œæ›¿æ¢çš„æ ‡è¯†ã€‚
7.  å½“ä¸€åˆ‡å‡†å¤‡å°±ç»ªçš„æ—¶å€™ï¼Œæ‰§è¡Œå¾®åº”ç”¨çš„ JavaScript ä»£ç ï¼Œæ¸²æŸ“å‡ºå¾®åº”ç”¨

## å…«ã€å¾®åº”ç”¨æ¥å…¥ä¸‰æ­¥èµ°

**ç¬¬ä¸€æ­¥ï¼šå¾®åº”ç”¨çš„å…¥å£æ–‡ä»¶ ä¿®æ”¹ **webpack\_public\_path****

-   åœ¨Â `src`Â ç›®å½•æ–°å¢Â `public-path.js`
-   `webpack`Â é»˜è®¤çš„Â `publicPath`Â ä¸ºÂ `""` ç©ºå­—ç¬¦ä¸²ï¼Œä¼šåŸºäºå½“å‰è·¯å¾„æ¥åŠ è½½èµ„æºã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨ä¸»åº”ç”¨ä¸­åŠ è½½å¾®åº”ç”¨èµ„æºçš„æ—¶å€™ä¼šå¯¼è‡´èµ„æºä¸¢å¤±ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è®¾ç½®Â `__webpack_public_path__` çš„å€¼

```
// å¾®åº”ç”¨/src/const/public-path.js
if (window.__POWERED_BY_QIANKUN__) {
    __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
} 
å¤åˆ¶ä»£ç 
```

**ç¬¬äºŒæ­¥ï¼šå¾®åº”ç”¨webpack æ–°å¢é…ç½®**

-   **webpack** é…ç½®ä¿®æ”¹ PS: **[ä»€ä¹ˆæ˜¯ umd æ¨¡å—ï¼Ÿ](https://juejin.cn/post/6844903927104667662 "https://juejin.cn/post/6844903927104667662")**

```
const { name } = require('./package.json')

module.exports = {
  devServer: {
      port: 8081, // çˆ¶åº”ç”¨é…ç½®å¾®åº”ç”¨ç«¯å£ï¼Œè¦ä¸å¾®åº”ç”¨ç«¯å£ä¸€è‡´
      disableHostCheck: true, // å…³é—­ä¸»æœºæ£€æŸ¥ï¼Œä½¿å¾®åº”ç”¨å¯ä»¥è¢« fetch
      headers: {
          'Access-Control-Allow-Origin': '*' //å› ä¸ºqiankunå†…éƒ¨è¯·æ±‚éƒ½æ˜¯fetchæ¥è¯·æ±‚èµ„æºï¼Œæ‰€ä»¥å­åº”ç”¨å¿…é¡»å…è®¸è·¨åŸŸ
      }
  },
  configureWebpack: {
      output: {
          library: `${name}-[name]`, // å¾®åº”ç”¨çš„åŒ…åï¼Œè¿™é‡Œä¸ä¸»åº”ç”¨ä¸­æ³¨å†Œçš„å¾®åº”ç”¨åç§°ä¸€è‡´
          libraryTarget: 'umd', // è¿™é‡Œè®¾ç½®ä¸ºumdæ„æ€æ˜¯åœ¨ AMD æˆ– CommonJS çš„ require ä¹‹åå¯è®¿é—®ã€‚
          jsonpFunction: `webpackJsonp_${name}` // webpackç”¨æ¥å¼‚æ­¥åŠ è½½chunkçš„JSONP å‡½æ•°ã€‚
      }
  }
}
å¤åˆ¶ä»£ç 
```

**ç¬¬ä¸‰æ­¥ï¼šå¾®åº”ç”¨æ·»åŠ ç”Ÿå‘½å‘¨æœŸ**

> å¾®åº”ç”¨éœ€è¦åœ¨è‡ªå·±çš„å…¥å£æ–‡ä»¶ï¼Œæ·»åŠ Â `bootstrap`ã€`mount`ã€`unmount`Â ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä¾›ä¸»åº”ç”¨åœ¨é€‚å½“çš„æ—¶æœºè°ƒç”¨ã€‚

-   main.js æ³¨å†Œå¾®åº”ç”¨ï¼Œå¢åŠ åˆ¤æ–­è®©å­åº”ç”¨å°±ç®—è„±ç¦»äº†çˆ¶åº”ç”¨ä¹Ÿå¯ä»¥ç‹¬ç«‹è¿è¡Œ
-   PSï¼šqiankun ç”Ÿå‘½å‘¨æœŸå‡½æ•°éƒ½å¿…é¡»æ˜¯ Promiseï¼Œä½¿ç”¨ async ä¼šè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡

```
// å¾®åº”ç”¨/scr/main.js

import './public-path.js'
import Vue from 'vue'
import App from './App.vue'
import router from './router'
import store from './store'

let instance = null

// 1. å°†æ³¨å†Œæ–¹æ³•ç”¨å‡½æ•°åŒ…è£¹ï¼Œä¾›åç»­ä¸»åº”ç”¨ä¸ç‹¬ç«‹è¿è¡Œè°ƒç”¨
function render(props = {}) {
  const { container } = props
  instance = new Vue({
    router,
    store,
    render: h => h(App),
  }).$mount(container ? container.querySelector('#app-micro') : '#app-micro')
}

// åˆ¤æ–­æ˜¯å¦åœ¨ä¹¾å¤ç¯å¢ƒä¸‹ï¼Œéä¹¾å¤ç¯å¢ƒä¸‹ç‹¬ç«‹è¿è¡Œ
if (!window.__POWERED_BY_QIANKUN__) {
  render()
}

// 2. å¯¼å‡ºçš„ç”Ÿå‘½å‘¨æœŸ
/**
 * bootstrap åªä¼šåœ¨å¾®åº”ç”¨åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹æ¬¡å¾®åº”ç”¨é‡æ–°è¿›å…¥æ—¶ä¼šç›´æ¥è°ƒç”¨ mount é’©å­ï¼Œä¸ä¼šå†é‡å¤è§¦å‘ bootstrapã€‚
 * é€šå¸¸æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›å…¨å±€å˜é‡çš„åˆå§‹åŒ–ï¼Œæ¯”å¦‚ä¸ä¼šåœ¨ unmount é˜¶æ®µè¢«é”€æ¯çš„åº”ç”¨çº§åˆ«çš„ç¼“å­˜ç­‰ã€‚
 */
export async function bootstrap() {
  console.log('[vue] vue app bootstraped')
}

/**
 * åº”ç”¨æ¯æ¬¡è¿›å…¥éƒ½ä¼šè°ƒç”¨ mount æ–¹æ³•ï¼Œé€šå¸¸æˆ‘ä»¬åœ¨è¿™é‡Œè§¦å‘åº”ç”¨çš„æ¸²æŸ“æ–¹æ³•
 */
export async function mount(props) {
  console.log('[vue] props from main framework', props)
  render(props);
}

/**
 * åº”ç”¨æ¯æ¬¡ åˆ‡å‡º/å¸è½½ ä¼šè°ƒç”¨çš„æ–¹æ³•ï¼Œé€šå¸¸åœ¨è¿™é‡Œæˆ‘ä»¬ä¼šå¸è½½å¾®åº”ç”¨çš„åº”ç”¨å®ä¾‹
 */
export async function unmount() {
  instance.$destroy()
  instance.$el.innerHTML = ''
  instance = null
}

/**
 * å¯é€‰ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä»…ä½¿ç”¨ loadMicroApp æ–¹å¼åŠ è½½å¾®åº”ç”¨æ—¶ç”Ÿæ•ˆ
 */
export async function update(props) {
  console.log('update props', props)
}
å¤åˆ¶ä»£ç 
```

**å°ç»“** ç»å†è¿™å‡ æ­¥ï¼Œqiankun çˆ¶åº”ç”¨ä¸å¾®åº”ç”¨å°±æ¥å…¥å®Œæˆäº†ã€‚å½“çˆ¶åº”ç”¨å®ŒæˆåŠ è½½å¾®åº”ç”¨çš„æ—¶å€™ï¼Œå¾®åº”ç”¨å°±ä¼šéµå¾ªå¯¹åº”çš„è§£æ è§„åˆ™ï¼Œæ’å…¥åˆ°çˆ¶åº”ç”¨çš„HMTLä¸­äº†ã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3dcd94e768447cb86cfede1173213b3~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

## ä¹ã€é¢„åŠ è½½å¾®åº”ç”¨

**é¢„å…ˆè¯·æ±‚å­åº”ç”¨çš„ HTMLã€JSã€CSS ç­‰é™æ€èµ„æºï¼Œç­‰åˆ‡æ¢å­åº”ç”¨æ—¶ï¼Œå¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–è¿™äº›é™æ€èµ„æºï¼Œä»è€ŒåŠ å¿«æ¸²æŸ“å­åº”ç”¨ã€‚**

1.  **registerMicroApps æ¨¡å¼ä¸‹åœ¨ `start` æ–¹æ³•é…ç½®é¢„åŠ è½½åº”ç”¨**
    
    ```
    import { registerMicroApps, start } from 'qiankun';
    
    registerMicroApps([...AppsConfig])
    
    start({ prefetch: "all" }) // é…ç½®é¢„åŠ è½½
    å¤åˆ¶ä»£ç 
    ```
    
    -   prefetch -Â `boolean | 'all' | string[] | (( apps: RegistrableApp[] ) =>Â {Â criticalAppNames: string[]; minorAppsName: string[]Â })`Â - å¯é€‰ï¼Œæ˜¯å¦å¼€å¯é¢„åŠ è½½ï¼Œé»˜è®¤ä¸ºÂ `true`ã€‚
        
        é…ç½®ä¸ºÂ `true`Â åˆ™ä¼šåœ¨ç¬¬ä¸€ä¸ªå¾®åº”ç”¨ mount å®Œæˆåå¼€å§‹é¢„åŠ è½½å…¶ä»–å¾®åº”ç”¨çš„é™æ€èµ„æº
        
        é…ç½®ä¸ºÂ `all`Â åˆ™ä¸»åº”ç”¨Â `start`Â åå³å¼€å§‹é¢„åŠ è½½æ‰€æœ‰å¾®åº”ç”¨é™æ€èµ„æº
        
        é…ç½®ä¸ºÂ `string[]`Â åˆ™ä¼šåœ¨ç¬¬ä¸€ä¸ªå¾®åº”ç”¨ mounted åå¼€å§‹åŠ è½½æ•°ç»„å†…çš„å¾®åº”ç”¨èµ„æº
        
        é…ç½®ä¸ºÂ `function`Â åˆ™å¯å®Œå…¨è‡ªå®šä¹‰åº”ç”¨çš„èµ„æºåŠ è½½æ—¶æœº (é¦–å±åº”ç”¨åŠæ¬¡å±åº”ç”¨)
        
2.  **loadMicroApps æ¨¡å¼ä¸‹**
    
    ```
    import { prefetchApps } from 'qiankun';
    
    export const MICRO_PREFETCH_APPS = [
        { name: 'vue-child', entry: '//localhost:7101/' },
        { name: 'vue-app', entry: '//localhost:8081/' }
    ]
    
    prefetchApps(MICRO_PREFETCH_APPS)
    å¤åˆ¶ä»£ç 
    ```
    
    -   ç¬”è€…ç”¨çš„æ¨¡å¼å°±æ˜¯ loadMicroApps æ¨¡å¼ï¼Œ**ä¸ºäº†æ—¥åç»´æŠ¤çš„ä¾¿æºæ€§ï¼Œæ”¹é€ ä¸€ä¸‹ï¼š**ï¼Œæ–°å¢ isPreload å­—æ®µç»´æŠ¤æ˜¯å¦å¼€å¯é¢„åŠ è½½ï¼Œè¿™æ ·æœ‰å…³äºå¾®åº”ç”¨çš„ä¿¡æ¯éƒ½åœ¨æ­¤ jsæ–‡ä»¶ç»´æŠ¤ï¼Œé¿å…æ•£å¼¹å¼ä¿®æ”¹ã€‚
    
    ```
    // åŸºåº§/src/const/micro/application-list.js
    
    export const MICRO_CONFIG =  [
        {
            name: 'you app name', // åº”ç”¨çš„åå­—
            entry: '//localhost:7286/', // é»˜è®¤ä¼šåŠ è½½è¿™ä¸ªhtml è§£æé‡Œé¢çš„js åŠ¨æ€çš„æ‰§è¡Œ ï¼ˆå­åº”ç”¨å¿…é¡»æ”¯æŒè·¨åŸŸï¼‰fetch
            container: '#yuo-container-container', // å®¹å™¨id
            activeRule: '/your-prefix', // æ ¹æ®è·¯ç”±æ¿€æ´»çš„è·¯å¾„
            isPreload: true, // !! æ˜¯å¦å¼€å¯é¢„åŠ è½½ !!
        }
    ]
    å¤åˆ¶ä»£ç 
    ```
    
    ```
    import { prefetchApps } from 'qiankun';
    import { MICRO_CONFIG } from '@/const/micro/application-list.js';
    
    // è·å–é…ç½®çš„ isPreload å­—æ®µï¼Œå¹¶ç”ŸæˆåŠ è½½å¯¹åº”çš„æ ¼å¼
    const MICRO_PREFETCH_APPS = MICRO_CONFIG.reduce(
        (total, { isPreload, name, entry }) => (isPreload ? [...total, { name, entry }] : total),
        []
    )
    // é¢„åŠ è½½åº”ç”¨
    prefetchApps(MICRO_PREFETCH_APPS)
    å¤åˆ¶ä»£ç 
    ```
    

## åã€è·¯ç”±æ¨¡å¼é€‰æ‹©ä¸æ”¹é€ 

## ğŸ‘‰ æˆ‘ä»¬åº”è¯¥æ€ä¹ˆé€‰æ‹©è·¯ç”±ï¼Ÿ

> æœ€å¥½çš„è·¯ç”±æ¨¡å¼å°±æ˜¯ä¸»åº”ç”¨ã€å­åº”ç”¨éƒ½ç»Ÿä¸€æ¨¡å¼ï¼Œå¯ä»¥å‡å°‘ä¸åŒæ¨¡å¼ä¹‹é—´çš„å…¼å®¹å·¥ä½œ

æœ¬æ–‡é€‰æ‹©ç»Ÿä¸€ä¸ºï¼š çˆ¶å­è·¯ç”±hash æ¨¡å¼

| ä¸»æ¨¡å¼ | å­æ¨¡å¼ | æ¨è | æ¥å…¥å½±å“ | è§£å†³æ–¹æ¡ˆ | å¤‡æ³¨ |
| --- | --- | --- | --- | --- | --- |
| hash | hash | å¼ºçƒˆæ¨è | æ—  |  |  |
| hash | history | ä¸æ¨è | æœ‰ | history.pushState | æ”¹é€ æˆæœ¬å¤§ |
| history | history | å¼ºçƒˆæ¨è | æ—  |  |  |
| history | hash | æ¨è | æ—  |  |  |

PS: æ¯ä¸ªæ¨¡å¼ä¹‹é—´çš„ç»„åˆå¹¶ä¸æ˜¯æ¥å…¥å°±å¯ä»¥å®Œæˆçš„ï¼Œéƒ½éœ€è¦ä¸€äº›æ”¹é€ ï¼Œå¦‚ï¼šå¢åŠ è·¯ç”±å‰ç¼€ï¼Œè·¯ç”±é…ç½®baseè®¾ç½®ï¼Œä¸åŒçš„æ¨¡å¼activeRuleçš„è§„åˆ™éƒ½ä¸åŒ

## âš’ è·¯ç”±æ”¹é€ å·¥ä½œ

### **æ–°å¢å¾®åº”ç”¨è·¯ç”±å‰ç¼€**

> æ–°å¢å‰ç¼€ä¸æ˜¯å¾®åº”ç”¨å¿…é¡»çš„ï¼Œä½†æ˜¯ä¸ºäº†ä» URL ä¸Šä¸å…¶ä»–åº”ç”¨éš”ç¦»ï¼Œä¹Ÿæ˜¯ä¸ºäº†æ¥å…¥æ—§åº”ç”¨çš„æ—¶å€™ï¼Œèƒ½è®© activeRule æ–¹æ³•èƒ½è¯†åˆ«å¹¶æ¿€æ´»åº”ç”¨ï¼Œæ•…æ–°å¢è·¯ç”±å‰ç¼€ã€‚

**çˆ¶åº”ç”¨è·¯ç”±è¡¨**

```
[
    // ä¸»åº”ç”¨ router.jsï¼šå¦‚æœæƒ³åŒ¹é…ä»»æ„è·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ (*)ï¼š
    {
        path: '/your-prefix',
        name: 'Home',
        component: Home
    },
     // ç‰¹å®šé¡µé¢å…œåº• ä¼šåŒ¹é…ä»¥ `/your-prefix` å¼€å¤´çš„ä»»æ„è·¯å¾„
     // å¦‚ï¼š/your-prefix/404 ï¼Œ /your-prefix/no-permission ....
    {
        path: '/your-prefix/*',
        name: 'Home',
        component: Home
    }
]
å¤åˆ¶ä»£ç 
```

PSï¼šå­åº”ç”¨è·¯ç”±åˆ‡æ¢ï¼Œç”±äºåº”ç”¨ä¸è·¯ç”±éƒ½æ˜¯é€šè¿‡ URL æ³¨å†Œä¸é”€æ¯çš„ï¼Œå½“å­åº”ç”¨è·¯ç”±è·³è½¬åœ°å€ï¼Œæ— æ³•ä¸çˆ¶åº”ç”¨çš„è·¯ç”±åœ°å€åŒ¹é…ä¸Šçš„æ—¶å€™é¡µé¢ä¼šé”€æ¯ï¼Œéœ€è¦æ³¨æ„è·¯ç”±åŒ¹é…ï¼Œæˆ–è€…å¢åŠ è·¯ç”±å…œåº•ã€‚

**å­åº”ç”¨ hash æ¨¡å¼**

```
// hash æ¨¡å¼ä¸èƒ½ä½¿ç”¨baseï¼Œåªèƒ½æ”¹å‰ç¼€
new VueRouter({
    mode: 'hash',
    routes: [
        {
            //å¢åŠ è·¯ç”±å‰ç¼€åˆ¤æ–­
            path: `${ window.__POWERED_BY_QIANKUN__ ? 'your-prefix' : ''}/login`,
            component: _import('login/index.vue')
        }
    ]
})
å¤åˆ¶ä»£ç 
```

**å­åº”ç”¨ history æ¨¡å¼**

```
new VueRouter({
    mode: 'history',
    // **é’ˆå¯¹å­åº”ç”¨æ˜¯ historyæ¨¡å¼çš„æ—¶å€™ï¼Œåªç”¨è®¾ç½® router base å°±å¥½äº†ï¼Œä¸ç”¨åƒhash è¿™ä¹ˆéº»çƒ¦** 
    base: window.__POWERED_BY_QIANKUN__ ? 'your-prefix' : null,
    routes: [
        {
            path: '/login',
            component: _import('login/index.vue')
        }
    ]
})
å¤åˆ¶ä»£ç 
```

## åä¸€ã€ ğŸ“ æ—§é¡¹ç›®è·¯ç”±æ¥å…¥æ”¹é€ 

> ä½†æ˜¯ç”±äºç¬”è€…æ˜¯æ¥å…¥çš„æ˜¯æ—§é¡¹ç›®å¹¶ä¸”åˆæ˜¯ hash è·¯ç”±æ¨¡å¼æƒ³é¡ºåˆ©æ¥å…¥ï¼Œä¸€ä¸ªä¸ªåŠ ä¸‰å…ƒåˆ™æ”¹åŠ¨å¤ªå¤šè·¯ç”±è¡¨äº†ï¼Œä¸ºäº†å‡å°‘å¯¹äºæ—§é¡¹ç›®æ¥å…¥æ—¶çš„å½±å“ä»…åœ¨ä»¥ä¸‹ä¸‰å¤„åšä¿®æ”¹ï¼ˆpsï¼šå› ä¸ºæ‡’ï¼‰

## 1\. hashè·¯ç”±æ¨¡å¼ï¼šæ ¼å¼åŒ–è·¯ç”±è¡¨å¯¹è±¡ï¼Œå¾®è·¯ç”±è¡¨è·¯å¾„ï¼Œåˆ«åï¼Œé‡å®šå‘å¢åŠ å‰ç¼€åŒºåˆ†åº”ç”¨

-   è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨é€’å½’å‡½æ•°éœ€è¦ç»™è·¯ç”±åŠ¨æ€å¢åŠ å‰ç¼€ã€path ã€redirectã€alias è¿™ä¸ªä¸‰ç§çŠ¶æ€éœ€è¦åŠ¨æ€å¤„ç†ä¸€ä¸‹

1.  è·¯ç”±è¡¨æ•°æ®

```
const routes = [
    {
        path: '/home',
        name: 'home',
        component: Home
    },
    {
        path: '/about',
        name: 'about',
        redirect: 'home',
        component: () => import('../views/About.vue')
    },
{
        path: '/about',
        name: 'about',
        alias: '/user/about',
        component: () => import('../views/About.vue')
    }
]
å¤åˆ¶ä»£ç 
```

-   2.  æ ¼å¼åŒ–è·¯ç”±æ–¹æ³•

```
let SUN_ROUTER_PATH_LIST = [] // æ‰€æœ‰è¢«æ ¼å¼åŒ–çš„è·¯ç”±éƒ½è®°å½•ä¸€ä¸‹

// 1. æ ¼å¼åŒ–è·¯ç”±å™¨å‚æ•° é€’å½’æ ¼å¼åŒ–
export function formatRouterParams(parameter) {
    // åˆ¤æ–­å¦‚æœä¸æ˜¯ qiankun ç¯å¢ƒå†…å®¹åˆ™åŸæ ·è¿”å›
    if (!window.__POWERED_BY_QIANKUN__) {
        return parameter.data
    }
    
    // é€’å½’å‡½æ•°ï¼šdataï¼šæ•°æ®æºï¼Œparamsï¼šéœ€è¦æ›¿æ¢çš„å‚æ•°ï¼ˆæ•°ç»„ã€å­—ç¬¦ä¸²ï¼‰ï¼Œvalueéœ€è¦æ›¿æ¢çš„å€¼ï¼ˆå‡½æ•°ï¼‰ï¼ŒdeepKeyï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦é€’å½’çš„å‚æ•°å
    const recursionData = ({ data, params, value, deepKey }) => {
        return data.reduce((total, item) => {
            item = formatData({ item, params, value })
            // åˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­é€’å½’
            if (deepKey && item[deepKey] && Array.isArray(item[deepKey])) {
                item[deepKey] = recursionData({
                    data: item[deepKey],
                    params,
                    value,
                    deepKey
                })
            }
            return [...total, item]
        }, [])
    }
    return recursionData(parameter)
}

// 2. æ ¼å¼åŒ–è·¯ç”±æ•°æ®å¢åŠ å‰ç¼€
export function formatData({ item, params, value }) {
    if (!item) return
    
    // å¦‚æœparamsæ˜¯æ•°ç»„ï¼š[path, ...more] éå†å¢åŠ å‰ç¼€
    if (Array.isArray(params)) {
        params.forEach(key => {
            if (Object.prototype.hasOwnProperty.call(item, key)) {
                item[key] = geRouterValue(value, item[key])
            }
        })
    } else if (params) {
        item[params] = geRouterValue(value, item[params])
    }

    // è®°å½•æ ¼å¼åŒ–è·¯ç”±è·¯å¾„
    SUN_ROUTER_PATH_LIST.push(item)
    return item
}

// 3. åˆ¤æ–­valueæ˜¯å‡½æ•°è¿˜æ˜¯å€¼ï¼Œå¦‚æœæ˜¯å‡½æ•°åˆ™è°ƒç”¨å‡½æ•° è¿”å›å¯¹åº”çš„value å€¼
export function geRouterValue(value, key) {
    return typeof value === 'function' ? value(key) : value
}
å¤åˆ¶ä»£ç 
```

2.  è°ƒç”¨é€’å½’æ–¹æ³•ç»Ÿä¸€æ›¿æ¢å¾®åº”ç”¨è·¯ç”±è¡¨

```
const BASE_ROUTER_PATH = 'your-prefix'

const router = new VueRouter({
    mode: 'hash',
    // è°ƒç”¨æ–¹æ³•æ ¼å¼åŒ–è·¯ç”±è¡¨å‚æ•°ï¼ï¼ï¼
    routes: formatRouterParams({
        data: route,
        deepKey: 'children',
        params: ['path', 'redirect', 'alias'],
        value: value => { // value æ ¼å¼åŒ–çš„æ–¹æ³•
            if (window.__POWERED_BY_QIANKUN__ && typeof value === 'string') {
                 const path = value[0] === '/' ? value : `/${value}`
                 return BASE_ROUTER_PATH + path
            }
            return value
        }
    })
})
å¤åˆ¶ä»£ç 
```

éå†ç»“æœè¿”å›-è·¯ç”±è¡¨ï¼Œç»Ÿä¸€å¢åŠ â€œyour-prefixâ€å‰ç¼€å•¦

```
[
    {
        "path": "your-prefix/home",
        "name": "home",
        "component": "Home"
    },
    {
        "path": "your-prefix/about",
        "name": "about",
        "redirect": "your-prefix/home",
        "component": ""
    },
    {
        "path": "your-prefix/about",
        "name": "about",
        "alias": "your-prefix/user/about",
        "component": ""
    }
]
å¤åˆ¶ä»£ç 
```

## **2\. router.beforeEach**

> è·³è½¬çš„æ—¶å€™è°ƒç”¨æ£€æŸ¥è·³è½¬å‡½æ•°ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å¢åŠ å‰ç¼€

```
// è·¯ç”±å…¨å±€å®ˆå« 
// ps: åœ¨å†…éƒ¨åˆ¤æ–­ï¼Œå¦‚æœè·³è½¬çš„è·¯ç”±ä¸å½“å‰å­åº”ç”¨æ— å…³ï¼Œç›´æ¥æ”¾è¡Œå³å¯
router.beforeEach((to, from, next) => {
    checkLink(to, next, () => {
        next()
    })
})
å¤åˆ¶ä»£ç 
```

-   ç®€å•æ¥è¯´ï¼š å¦‚æœæ˜¯åœ¨ qiankun ç¯å¢ƒä¸­ï¼Œå¹¶ä¸”ä¸æ˜¯è·³è½¬å…¶ä»–å¾®åº”ç”¨çš„pathï¼Œ å¹¶ä¸”è·³è½¬ä¸æ˜¯æ ¼å¼åŒ–å‰ç¼€çš„è·¯å¾„ï¼Œå¹¶ä¸”å½“å‰æ‹¼æ¥çš„åœ°å€ä¸æ ¼å¼åŒ–çš„è·¯ç”±åœ°å€æ˜¯ä¸€è‡´çš„æ‰æ‹¼æ¥ next

```
// LINK_MICRO_APP_LIST, SUN_ROUTER_PATH_LIST å˜é‡ä¸Šæ–‡æœ‰è®°å½•

const { name } = require('../../package.json')
export const BASE_ROUTER_PATH = `/${name}` // æ­¤å¤„ç¬”è€…ç”¨äº† package.json çš„ name åšä¸º â€œyour-prefixâ€ æ–¹ä¾¿åæœŸç»´æŠ¤

// è·³è½¬çš„æ—¶å€™æ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å¢åŠ å‰ç¼€
export function checkLink(to, next, callback) {
    // æ˜¯å¦å­˜åœ¨qinakunç¯å¢ƒä¸­
    const IS_HAVE_QIANKUN = window.__POWERED_BY_QIANKUN__
    // æ˜¯å¦è·³è½¬å…¶ä»–å¾®åº”ç”¨
    const IS_JUMP_TO_MICRO_APP = Object.values(LINK_MICRO_APP_LIST).includes(to.path)
    // æ˜¯å¦è·³è½¬çš„æ˜¯æ ¹è·¯å¾„
    const IS_BASE_PATH_SYMBOL = to.path === '/'
    // æ ¹è·¯å¾„æ˜¯å¦åŒ¹é…ä¸€è‡´
    const IS_HAVE_BASE_ROUTER_PATH = getBasePath(to.path, '/') === getBasePath(BASE_ROUTER_PATH, '/')
    // åˆ¤æ–­ä»¥ä¸Šæƒ…å†µæ¥ç¡®å®šæ˜¯å¦éœ€è¦ç»™è·¯ç”±åŠ¨æ€å¢åŠ å‰ç¼€
    const IS_ADD_PREFIX = IS_HAVE_QIANKUN && !IS_JUMP_TO_MICRO_APP && !IS_HAVE_BASE_ROUTER_PATH
    if (IS_ADD_PREFIX || IS_BASE_PATH_SYMBOL) {
        const path = `${BASE_ROUTER_PATH}${to.path}`
        // å½“å‰æ‹¼æ¥çš„åœ°å€ä¸ å½“å‰æ ¼å¼åŒ–çš„è·¯ç”±æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´æ‰æ˜¯è·³è½¬å†…éƒ¨è·¯ç”±
        if (SUN_ROUTER_PATH_LIST.some(e => [e.path, e.redirect, e.alias].includes(path))) {
            next({ path })
        }
    }
    // æ‰§è¡Œå›è°ƒå‡½æ•°
    callback && callback()
}

// è·å–å½“å‰çš„åŸºç¡€è·¯å¾„  å¦‚: getBasePath('/user/age/xxx', '/') => '/user'
export function getBasePath(path, prefix = '') {
    if (!path) return
    const pathArray = String(path).split('/').filter(item => item)
    const basePath = prefix + pathArray[0]
    return basePath
}
å¤åˆ¶ä»£ç 
```

## 3.æ”¹å†™router.push OR router.replace

```
// å› ä¸ºæ”¹å˜äº†next()çš„åœ°å€, pushæ–¹æ³•ä¼šæç¤ºæŠ¥é”™ï¼Œè¿™é‡Œè¿‡æ»¤ä¸€ä¸‹ï½
const originalPush = VueRouter.prototype.push
VueRouter.prototype.push = function push(location) {
    return originalPush.call(this, location).catch(err => err)
}
å¤åˆ¶ä»£ç 
```

ps: **å…¶å¯ä»¥ç›´æ¥åœ¨pushä¸­æ”¹å†™ï¼Œ çœç•¥ router.befroeEach**

```
const originalPush = VueRouter.prototype.push

VueRouter.prototype.push = function push(location) {
    const IS_JUMP_TO_MICRO_APP = Object.values(LINK_MICRO_APP_LIST).includes(location.path)
    const IS_HAVE_QIANKUN = window.__POWERED_BY_QIANKUN__
    const IS_BASE_PATH_SYMBOL = location.path === '/'
    const IS_HAVE_BASE_ROUTER_PATH = getBasePath(location.path, '/') === BASE_ROUTER_PATH
    const IS_ADD_PREFIX = IS_HAVE_QIANKUN && !IS_JUMP_TO_MICRO_APP && !IS_BASE_PATH_SYMBOL && !IS_HAVE_BASE_ROUTER_PATH

    if (IS_ADD_PREFIX) {
        location.path = `${BASE_ROUTER_PATH}${location.path}`
    }
    return originalPush.call(this, location)
}
å¤åˆ¶ä»£ç 
```

## 4\. è·¯ç”±è·³è½¬è®°å½•

**è·³è½¬æ–¹å¼: è·¯ç”±è·³è½¬ä¸æ­£å¸¸ä½¿ç”¨æ— å¼‚**

-   ps: åœ¨çˆ¶åº”ç”¨æ˜¯historyæ¨¡å¼ï¼Œå­åº”ç”¨æ˜¯ hashæ¨¡å¼çš„æ—¶å€™ å­åº”ç”¨éœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹URLé‡å®šå‘åˆ‡æ¢ history.pushState

**è·³è½¬å…¶ä»–å¾®åº”ç”¨**

1.  ç”±äºæˆ‘ä»¬çš„åº”ç”¨ä¹‹é—´å¼åˆ†ç¦»çš„ï¼Œæ‰€ä»¥è·³è½¬å¤–éƒ¨åº”ç”¨çš„è·¯ç”±ä¹Ÿæ˜¯åˆ†ç¦»çš„ï¼Œ**å¦‚æœåœ¨é¡¹ç›®ä¸­å­—é¢é‡å›ºå®šå†™æ­»é£é™©å¤ªå¤§äº†ï¼Œå¦‚æœå¤–éƒ¨åº”ç”¨å‘ç”Ÿä¸€ç‚¹æ”¹å˜ï¼Œéœ€è¦æ”¹é¡¹ç›®é‡Œçš„è·¯å¾„çš„æ—¶å€™å°†ä¼šæ˜¯ä¸€ä¸ªå™©æ¢¦**ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»Ÿä¸€ä½¿ç”¨åœ¨å„è‡ªçš„å¾®åº”ç”¨ç»´æŠ¤ä¸€ä¸ªå¸¸é‡åˆ—è¡¨å»å¤„ç†è®°å½•åº”ç”¨ä¹‹é—´çš„è·³è½¬ï¼Œæ–¹ä¾¿å…¨å±€ç»Ÿä¸€ç®¡ç†ã€‚æ­¤å¤„ä»…ç¬”è€…ä¸€ç‚¹æ‹™è§ï¼Œå¦‚æœ‰æ›´å¥½å»ºè®®è¯·å¤šå¤šå‘è¡¨ã€‚
2.  PSï¼šæ­¤å¤„è·³è½¬çš„å¸¸é‡åˆ—è¡¨å…¶å®ä¹Ÿå¯ä»¥æ”¾åˆ°åŸºåº§åº”ç”¨å»ç»´æŠ¤ï¼Œä½†æ˜¯æœ€ä½³é€‰æ‹©æ˜¯æœ‰è¿ç»´å¹³å°å»ç»´æŠ¤åº”ç”¨ä¹‹é—´è·³è½¬å…³ç³»ä¼šæ›´å¥½ï½

```
// å¾®åº”ç”¨/scr/const/link-micro-app-list
export const LINK_MICRO_APP_LIST = {
    CHILD_VUE: '/child/vue', // vue å¾®åº”ç”¨åœ°å€
    CHILD_REACT: '/child/react', // react å¾®åº”ç”¨åœ°å€
    USER_INFO: '/user/info' // è·³è½¬çˆ¶åº”ç”¨ç”¨æˆ·ä¿¡æ¯é¡µåœ°å€
}
å¤åˆ¶ä»£ç 
```

**ä½¿ç”¨åœºæ™¯ï¼š**

```
// å¾®åº”ç”¨/router.js

// 1. åˆ¤æ–­æ˜¯å¦è·³è½¬å…¶ä»–åº”ç”¨
const IS_JUMP_TO_MICRO_APP = Object.values(LINK_MICRO_APP_LIST).includes(to.path)

// 2. å®šä¹‰è·¯ç”±çš„æ—¶å€™é€šè¿‡è·¯ç”±åˆ—è¡¨åœ°å€è·å–
let routes = [
    {
        path: '/about',
        name: 'about',
        // åˆ«å é‡å®šå‘ å‡¡æ˜¯è·³è½¬å…¶ä»–åº”ç”¨çš„éƒ½åº”è¯¥åœ¨è¿™é‡Œç»Ÿä¸€ç®¡ç† ï¼ï¼ï¼
        redirect: LINK_MICRO_APP_LIST['CHILD_VUE'], 
        component: () => import('../views/About.vue')
    }
]

// router.beforeEach
router.beforeEach((to, from, next) => {
    if (IS_JUMP_TO_MICRO_APP) {
        next(false) // ç¦æ­¢è·³è½¬å…¶ä»–ying yon
    }
  // ... more code
})
å¤åˆ¶ä»£ç 
```

## åäºŒã€ å¾®åº”ç”¨ä¸è·¯ç”±ä¹‹é—´ å¦‚ä½• keep alive

-   **registerMicroAppsæ¨¡å¼ä¸‹ï¼Œä¸ºä»€ä¹ˆåˆ‡æ¢è·¯ç”±ä¼šå¯¼è‡´åº”ç”¨é‡è½½ï¼Ÿ**
    -   è¯¦æƒ…å¯ä»¥çœ‹ä¸Šæ–‡ **â€œäº”ã€å¼•å…¥qiankun - åœ¨ä¸»åº”ç”¨ä¸­æ³¨å†Œå¾®åº”ç”¨â€**
    -   URL æ”¹å˜æ—¶åº”ç”¨åŒ¹é…åˆ‡æ¢ï¼Œè·¯ç”±çš„åˆ‡æ¢ä¼šå¯¼è‡´åº”ç”¨çš„å¸è½½ä¸åŠ è½½
        -   ä¾‹ï¼šA åˆ° Bï¼Œ è§¦å‘A unmount â‡’ åˆ¤æ–­ B æ˜¯å¦åŠ è½½è¿‡ï¼Œå·²åŠ è½½åˆ™è§¦å‘ mountï¼ŒæœªåŠ è½½åˆ™è§¦å‘ bootstrap â‡’ mount
    -   å¦‚æœå­åº”ç”¨æŒ‚è½½åœ¨å†…éƒ¨è·¯ç”±ï¼Œè·¯ç”±è·³è½¬ä¹Ÿå°†è§¦å‘åº”ç”¨çš„é‡è½½
    -   åº”ç”¨åˆ‡æ¢å¯¼è‡´é‡è½½ï¼Œå¯¼è‡´ç»„ä»¶çŠ¶æ€ä¸¢å¤±ï¼Œä¸ºäº†ä¿æŒåº”ç”¨å®ä¾‹ä¸è¢«åŠ è½½ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨çš„æ§åˆ¶åº”ç”¨çš„æ³¨å†Œä¸é”€æ¯
-   æ–¹æ¡ˆä¸€ï¼š**loadMicroApp**
    -   ä¼˜ç‚¹ï¼šåœ¨ä¸€ä¸ªé¡µé¢ä¸­å¯ä»¥åŒæ—¶æŒ‚è½½å¤šä¸ªå¾®åº”ç”¨
    -   ç¼ºç‚¹ï¼šæ— æ³•æ ¹æ®è·¯ç”±åŒ¹é…è§„åˆ™æ¥æŒ‚è½½åº”ç”¨
    -   é€‚ç”¨åœºæ™¯ï¼šå½“éœ€è¦åœ¨ä¸€ä¸ªé¡µé¢ä¸­åŒæ—¶æŒ‚è½½2ä¸ªä»¥ä¸Šå­åº”ç”¨ï¼Œå¹¶ä¸”å­åº”ç”¨çš„æŒ‚è½½ä¸éœ€è¦é€šè¿‡è·¯ç”±åŒ¹é…æ¥å®ç°ã€‚
    -   PSï¼šåœ¨åŸºåº§ä¸­å…³é—­æ ‡ç­¾é¡µæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨appçš„unmounté’©å­é”€æ¯åº”ç”¨ï¼Œä¸ç„¶å†æ¬¡æ–°å»ºé¡µç­¾è¿›å…¥æ—¶è¿˜æ˜¯ä»¥å‰çš„å®ä¾‹

loadMicroAppä¸èƒ½æ ¹æ®è·¯ç”±è§„åˆ™æ¥æŒ‚è½½åº”ç”¨ä¸æ˜¯qiankunçš„é—®é¢˜ï¼Œæ˜¯æˆ‘ä»¬çš„é—®é¢˜ï½

**ä½¿ç”¨ router.**afterEach** + loadMicroApp çš„è§£å†³åº”ç”¨ keep aliveï¼Œæ€è·¯æ˜¯é€šè¿‡åˆ¤æ–­è·¯ç”±å®ˆå«çš„åœ°å€ï¼Œå¦‚æœæ˜¯ç¬¦åˆæ¿€æ´»è§„åˆ™çš„åˆ™æ¿€æ´»åº”ç”¨**

**1\. ä¸»åº”ç”¨ router è·¯ç”±å®ˆå«**

```
// ä¸»åº”ç”¨/src/router/index.js
// 1. å…¨å±€åç½®é’©å­è°ƒç”¨å¾®åº”ç”¨åŠ è½½æ–¹æ³•
// ä¸ºä»€ä¹ˆç¬”è€…ä¼šåœ¨è¿™é‡Œè°ƒç”¨å‘¢ï¼Œå…¶å®æ˜¯ç¬”è€…åˆ©ç”¨äº†JavaScriptæœºåˆ¶çš„å®ä»»åŠ¡ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†åœ¨è·¯ç”±é¡µè·å–æ˜¯å¾®åº”ç”¨çš„å®¹å™¨æ˜¯å¦æŒ‚è½½äº†å¾®åº”ç”¨ï¼Œå› ä¸ºæœ‰æ—¶å€™å¾®åº”ç”¨ä¼šå› ä¸ºä½œè€…ç³»ç»Ÿçš„è·¯ç”±åˆ‡æ¢è€Œè¢«æ›¿æ¢æ‰ï¼Œæ‰€ä»¥ç”¨è¿™ä¸ªæ–¹å¼è§£å†³
router.afterEach(to => {
    setTimeout(() => { // setTimeout æ˜¯å®ä»»åŠ¡çš„ä¸€ç§
        microApplicationLoading(to.path) // æŠŠå½“å‰è·³è½¬çš„è·¯å¾„ä¼ å…¥
    })
})
å¤åˆ¶ä»£ç 
```

**2\. åˆ¤æ–­å¾®åº”ç”¨åŠ è½½çš„æ–¹æ³• microApplicationLoading**

-   åº”ç”¨è¡¨

```
// **src/const/micro/application-list.js** 
export const microApplicationList [
    {
        name: 'you app name', // åº”ç”¨çš„åå­—
        entry: '//localhost:7286/', // é»˜è®¤ä¼šåŠ è½½è¿™ä¸ªhtml è§£æé‡Œé¢çš„js åŠ¨æ€çš„æ‰§è¡Œ ï¼ˆå­åº”ç”¨å¿…é¡»æ”¯æŒè·¨åŸŸï¼‰fetch
        container: '#yuo-container-container', // å®¹å™¨id
        activeRule: '/your-prefix', // æ ¹æ®è·¯ç”±æ¿€æ´»çš„è·¯å¾„
        **isPreload: true, // !! æ˜¯å¦å¼€å¯é¢„åŠ è½½ !!
        isRouteStart: true, // æ˜¯å¦éœ€è¦è·¯ç”±å¯åŠ¨**
        props: { // ä¸‹å‘å­åº”ç”¨çš„èµ„æº
            router: router,
            store: store,
            parentEventHub: parentEventHub
        }
    }
]
å¤åˆ¶ä»£ç 
```

-   åŠ è½½å¾®åº”ç”¨æ–¹æ³•

```
// ä¸»åº”ç”¨/src/const/micro/qianun-utils.js
// åŠ è½½å¾®åº”ç”¨æ–¹æ³•
import { loadMicroApp } from 'qiankun'

export async function microApplicationLoading(path) {
    // 1. æ ¹æ®è·¯ç”±åœ°å€åŠ è½½å½“å‰åº”ç”¨é…ç½®
    let currentActiveMicroConfig = await store.dispatch('d2admin/micro/GET_FIND_MICRO_CONFIG', path)

    // 2. ä» vuex è·å–ç¼“å­˜çš„å¾®åº”ç”¨åˆ—è¡¨
    const microApplicationList = store.getters['d2admin/micro/microApplicationList']

    // 3. å¦‚æœæ²¡æœ‰åŒ¹é…åº”ç”¨é…ç½®åˆ™ä»£è¡¨è·³è½¬çš„ä¸æ˜¯å¾®åº”ç”¨ or å¾®åº”ç”¨é…ç½®ä¸éœ€è¦è·¯ç”±å¯åŠ¨çš„å±æ€§
    if (!currentActiveMicroConfig || !currentActiveMicroConfig.isRouteStart) {
        return
    }

    // 4. æ ¹æ®åº”ç”¨é…ç½® è·å–ç¼“å­˜çš„åº”ç”¨
    const cacheMicro = microApplicationList.get(currentActiveMicroConfig.activeRule)

    // 5. åˆ¤æ–­å½“å‰æŒ‚è½½çš„æ˜¯å¦æœ‰å†…å®¹
    const containerNode = getContainerNode(currentActiveMicroConfig.container)
    const isNoTNodeContents = containerNode !== -1 && !containerNode

    // 6. å¦‚æœæ²¡æœ‰domèŠ‚ç‚¹ or æ²¡æœ‰ç¼“å­˜åº”ç”¨é…ç½® æ³¨å†Œä¸€ä¸‹
    if (isNoTNodeContents || !cacheMicro) {

        // å¦‚æœæœ‰ç¼“å­˜åº”ç”¨é…ç½®ï¼Œä½†æ˜¯å®¹å™¨æ²¡æœ‰åº”ç”¨æŒ‚è½½ï¼Œå…ˆå¸è½½ç¼“å­˜åº”ç”¨å†æ³¨å†Œå¾®åº”ç”¨
        if (cacheMicro) {
            cacheMicro.unmount()
            cacheMicro.unmountPromise.then(() => {
                loadRouterMicroApp(currentActiveMicroConfig)
            })
            return
        }

        // åŠ è½½åº”ç”¨
        loadRouterMicroApp(currentActiveMicroConfig)
    }
}

// åŠ è½½å¾®åº”ç”¨
export function loadRouterMicroApp(currentApp) {
    const micro = loadMicroApp(currentApp)
    micro.mountPromise.then(() => {
        // æŒ‚è½½å®Œæˆ è®¾ç½®ä¸€ä¸‹vuexå¾®åº”ç”¨åˆ—è¡¨
        store.dispatch('d2admin/micro/SET_MICRO_APPLICATION_LIST', {
            key: currentApp.activeRule,
            value: micro
        })
    })
}

// è·å–å®¹å™¨èŠ‚ç‚¹
export function getContainerNode(container) {
    const containerNode = container && document.querySelector(container)
    
    if (containerNode) {
        return containerNode.childNodes.length
    }
    
    return -1
}
å¤åˆ¶ä»£ç 
```

**vuex æ–¹æ³• è®°å½•ä¸€ä¸‹æ³¨å†Œåº”ç”¨å¯¹è±¡**

```
// ä¸»åº”ç”¨/src/store/modules/d2admin/modules/micro.js
import MICRO_CONFIG from '@/const/micro/application-list.js '

export default {
    state: {
        microApplicationList: new Map([]) // å·²ç»æ³¨å†Œçš„å¾®åº”ç”¨åˆ—è¡¨
    },
    getters: {
        microApplicationList(state) {
            return state.microApplicationList
        }
    },
    actions: {
        // è®¾ç½®å¾®åº”ç”¨ç¨‹åºåˆ—è¡¨
        SET_MICRO_APPLICATION_LIST({ state, dispatch }, { key, value }) {
            state.microApplicationList.set(key, value)
        },
        // é€šè¿‡è·¯å¾„è·å–å¾®åº”ç”¨é…ç½®
        GET_FIND_MICRO_CONFIG({ state }, path) {
            return MICRO_CONFIG.find(e => {
                return getPathPrefix(path, '/') === getPathPrefix(e.activeRule, '/')
            })
        }
    }
}

// è·å–å½“å‰çš„åŸºç¡€è·¯å¾„  å¦‚: getPathPrefix('/user/age/xxx', '/') => '/user'
export function getPathPrefix(path, prefix = '') {
    if (!path) return
    const pathArray = String(path).split('/').filter(item => item)
    const basePath = prefix + pathArray[0]
    return basePath
}
å¤åˆ¶ä»£ç 
```

**[ğŸš€ Link: æ›´å¤šçš„ keep-alive è§£å†³æ–¹æ¡ˆ](https://juejin.cn/post/6856569463950639117#heading-11 "https://juejin.cn/post/6856569463950639117#heading-11")**

## åä¸‰ã€æ²™ç®±æ¨¡å¼

## CSSæ²™ç®±

> å¾®å‰ç«¯å¯¹äºæ ·å¼éš”ç¦»é—®é¢˜ï¼Œç›®å‰ç›¸å…³é…å¥—è¿˜ä¸æ˜¯å¾ˆæˆç†Ÿ

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c50761ad4084d1184aa84dbf98da052~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

-   ç”±äºå¾®å‰ç«¯åœºæ™¯ä¸‹ï¼Œä¸åŒæŠ€æœ¯æ ˆçš„å­åº”ç”¨ä¼šè¢«é›†æˆåˆ°åŒä¸€ä¸ªè¿è¡Œæ—¶ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åœ¨æ¡†æ¶å±‚ç¡®ä¿å„ä¸ªå­åº”ç”¨ä¹‹é—´ä¸ä¼šå‡ºç°æ ·å¼äº’ç›¸å¹²æ‰°çš„é—®é¢˜ã€‚ä¸åŒäº JavaScript çš„éš”ç¦»ï¼Œç›®å‰ CSS éš”ç¦»åœ¨è¡Œä¸šå†…è¿˜ä¸å®Œå…¨çš„æˆç†Ÿï¼Œä½†æ˜¯â€œç”²ä¹‹èœœç³–ï¼Œä¹™ä¹‹ç ’éœœâ€œï¼Œæ¯ä¸ªæ–¹æ¡ˆéƒ½æœ‰ç€ä¸åŒçš„ä¼˜åŠ¿ä¸åŠ£åŠ¿ã€‚
-   æ ·å¼éš”ç¦»æœ‰ç€å„ç§æ–¹æ¡ˆ
    -   BEM ï¼ˆBlock Element Moduleï¼‰è§„èŒƒ
    -   CSS-Modules æ„å»ºæ—¶ç”Ÿæˆå„è‡ªçš„ä½œç”¨åŸŸ
    -   CSS in JS ä½¿ç”¨ JS è¯­è¨€å†™ CSS
    -   Shadow DOM æ²™ç®±éš”ç¦»
    -   experimentalStyleIsolation ç»™æ‰€æœ‰çš„æ ·å¼é€‰æ‹©å™¨å‰é¢éƒ½åŠ äº†å½“å‰æŒ‚è½½å®¹å™¨
    -   Dynamic Stylesheet åŠ¨æ€æ ·å¼è¡¨
    -   postcss å¢åŠ å‘½åç©ºé—´
-   ä½†æ˜¯å³ä½¿æ˜¯æœ‰ç€å¦‚æ­¤å¤šçš„æ ·å¼éš”ç¦»æ–¹æ¡ˆï¼Œcss è¿˜æ˜¯ä¼šæœ‰ä¸€å †é—®é¢˜ç­‰ç€ä½ å»å¤„ç†ã€‚ä¾‹å¦‚ï¼š
    -   ä¸åŒåº”ç”¨ä¾èµ–äº†åŒä¸€ä¸ªUIåº“ï¼Œä¸åŒç‰ˆæœ¬çš„æƒ…å†µ
    -   å­åº”ç”¨ï¼Œæ ·å¼ä¸¢å¤±æˆ–åº”ç”¨åˆ°äº†ä¸»é¡¹ç›®çš„æ ·å¼
    -   å¾®åº”ç”¨æ„è¿è¡Œæ—¶è¶Šç•Œä¾‹å¦‚ **body æ„å»º DOM çš„åœºæ™¯ï¼ˆå¼¹çª—ã€æŠ½å±‰ã€popover ç­‰è¿™ç§æ’å…¥åˆ°ä¸»åº”ç”¨body çš„dom å…ƒç´ ï¼‰**ï¼Œå¿…å®šä¼šå¯¼è‡´æ„å»ºå‡ºæ¥çš„ DOM æ— æ³•åº”ç”¨å­åº”ç”¨çš„æ ·å¼çš„æƒ…å†µã€‚

> æœ¬æ–‡é‡‡å–çš„æ ·å¼éš”ç¦»çš„æœ€ä½³å®è·µæ˜¯ï¼šé‡‡ç”¨çº¦å®šå¼éš”ç¦»ï¼Œç”¨Â CSS å‘½åç©ºé—´ã€‚å¤‡é€‰ï¼šCSS Moduleã€css-in-js ç­‰å·¥ç¨‹åŒ–æ‰‹æ®µï¼Œå»ºç«‹çº¦æŸï¼šå¦‚ï¼šé¿å…å†™å…¨å±€æ ·å¼ï¼Œå­åº”ç”¨ä¸èƒ½ä¾µå…¥(å¦‚åŠ¨æ€å¢åŠ å…¨å±€æ ·å¼ç­‰)ä¿®æ”¹é™¤æœ¬åº”ç”¨å¤–çš„æ ·å¼ï¼Œå­åº”ç”¨æ ·å¼å†™åœ¨ä»¥å­åº”ç”¨åä½œä¸ºå‘½åç©ºé—´çš„ç±»é‡Œç­‰ã€‚

1.  **é»˜è®¤æ²™ç®±**
    
    -   qiankunæ˜¯é»˜è®¤å¼€å¯æ²™ç®±éš”ç¦»çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹æ²™ç®±å¯ä»¥ç¡®ä¿å•å®ä¾‹åœºæ™¯å­åº”ç”¨ä¹‹é—´çš„æ ·å¼éš”ç¦»ï¼Œä½†æ˜¯æ— æ³•ç¡®ä¿ä¸»åº”ç”¨è·Ÿå­åº”ç”¨ã€æˆ–è€…å¤šå®ä¾‹åœºæ™¯çš„å­åº”ç”¨æ ·å¼éš”ç¦»
2.  **ä¸¥æ ¼æ ·å¼éš”ç¦»çš„æ²™ç®±æ¨¡å¼**
    
    ```
    start({
     Â sandbox: {
     Â  Â strictStyleIsolation: true // ä¸¥æ ¼æ²™ç®±æ¨¡å¼
      }
    })
    å¤åˆ¶ä»£ç 
    ```
    
    qiankun ä¼šä¸ºæ¯ä¸ªå¾®åº”ç”¨çš„å®¹å™¨åŒ…è£¹ä¸Šä¸€ä¸ª [shadow dom](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FWeb_Components%2FUsing_shadow_DOM "https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_shadow_DOM") èŠ‚ç‚¹ï¼Œä»è€Œç¡®ä¿å¾®åº”ç”¨çš„æ ·å¼ä¸ä¼šå¯¹å…¨å±€é€ æˆå½±å“ï¼ŒåŸºäº ShadowDOM çš„ä¸¥æ ¼æ ·å¼éš”ç¦»å¹¶ä¸æ˜¯ä¸€ä¸ªå¯ä»¥æ— è„‘ä½¿ç”¨çš„æ–¹æ¡ˆï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½éœ€è¦æ¥å…¥åº”ç”¨åšä¸€äº›é€‚é…åæ‰èƒ½æ­£å¸¸åœ¨ ShadowDOM ä¸­è¿è¡Œèµ·æ¥
    
    ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c87e93e79d994b0b81f0b09c402a53b0~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)
    
3.  **qiankun è¿˜æä¾›äº†ä¸€ä¸ªå®éªŒæ€§çš„æ ·å¼éš”ç¦»ç‰¹æ€§ experimentalStyleIsolation**
    
    -   å½“ experimentalStyleIsolation è¢«è®¾ç½®ä¸º true æ—¶ï¼Œqiankun ä¼šæ”¹å†™å­åº”ç”¨æ‰€æ·»åŠ çš„æ ·å¼ä¸ºæ‰€æœ‰æ ·å¼è§„åˆ™å¢åŠ ä¸€ä¸ªç‰¹æ®Šçš„é€‰æ‹©å™¨è§„åˆ™æ¥é™å®šå…¶å½±å“èŒƒå›´
    
    ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b2039abc091421eb56f389a70e00e29~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)
    
4.  **BEM ï¼ˆBlock Element Moduleï¼‰è§„èŒƒå‘½åçº¦æŸ**
    
    -   **B**Â -Â `Block`Â ä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸€ä¸ªæœ¬èº«å°±æœ‰æ„ä¹‰çš„ç‹¬ç«‹å®ä½“ æ¯”å¦‚ï¼š`header`ã€`menu`ã€`container`
    -   **E**Â -Â `Element`Â å…ƒç´ ,å—çš„ä¸€éƒ¨åˆ†ä½†æ˜¯è‡ªèº«æ²¡æœ‰ç‹¬ç«‹çš„å«ä¹‰ æ¯”å¦‚ï¼š`header title`ã€`container input`
    -   **M**Â -Â `Modifier`Â ä¿®é¥°ç¬¦ï¼Œå—æˆ–è€…å…ƒç´ çš„ä¸€äº›çŠ¶æ€æˆ–è€…å±æ€§æ ‡å¿— æ¯”å¦‚ï¼š`small`ã€`checked`
    
    ç‰¹å®šè§„åˆ™é“¾æ¥ï¼š
    
    -   '-' ä¸­åˆ’çº¿ ï¼šä»…ä½œä¸ºè¿å­—ç¬¦ä½¿ç”¨ï¼Œè¡¨ç¤ºæŸä¸ªå—æˆ–è€…æŸä¸ªå­å…ƒç´ çš„å¤šå•è¯ä¹‹é—´çš„è¿æ¥ç¬¦å·ã€‚
    -   \_\_ åŒä¸‹åˆ’çº¿ï¼šåŒä¸‹åˆ’çº¿ç”¨æ¥è¿æ¥å—å’Œå—çš„å­å…ƒç´ 
    -   \_ å•ä¸‹åˆ’çº¿ï¼šå•ä¸‹åˆ’çº¿ç”¨æ¥æè¿°ä¸€ä¸ªå—æˆ–è€…å—çš„å­å…ƒç´ çš„ä¸€ç§çŠ¶
    
    ```
    æ¨¡å—ï¼š            .Block
    æ¨¡å—å¤šå•è¯ï¼š       .Header-Block
    æ¨¡å—_çŠ¶æ€ï¼š        .Block_Modifier
    æ¨¡å—__å­å…ƒç´ ï¼š     .Block__Element
    æ¨¡å—__å­å…ƒç´ _çŠ¶æ€ï¼š .Block__Element_Modifier
    å¤åˆ¶ä»£ç 
    ```
    
5.  **CSS Modules**
    
    -   æŒ‡çš„æ˜¯æˆ‘ä»¬åƒ import js ä¸€æ ·å»å¼•å…¥æˆ‘ä»¬çš„ css ä»£ç ï¼Œä»£ç ä¸­çš„æ¯ä¸€ä¸ªç±»åéƒ½æ˜¯å¼•å…¥å¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œå³å¯åœ¨ä½¿ç”¨æ—¶æ˜ç¡®æŒ‡å®šæ‰€å¼•ç”¨çš„ css æ ·å¼ã€‚å¹¶ä¸” CSS Modules åœ¨æ‰“åŒ…çš„æ—¶å€™ä¼šè‡ªåŠ¨å°†ç±»åè½¬æ¢æˆ hash å€¼ï¼Œå®Œå…¨æœç» css ç±»åå†²çªçš„é—®é¢˜ã€‚
6.  **CSS In JS**
    
    -   CSS in JSï¼Œæ„æ€å°±æ˜¯ä½¿ç”¨ js è¯­è¨€å†™ cssï¼Œå®Œå…¨ä¸éœ€è¦äº›å•ç‹¬çš„ css æ–‡ä»¶ï¼Œæ‰€æœ‰çš„ css ä»£ç å…¨éƒ¨æ”¾åœ¨ç»„ä»¶å†…éƒ¨ï¼Œä»¥å®ç° css çš„æ¨¡å—åŒ–
7.  **postcss å¢åŠ å‘½åç©ºé—´**
    
    ```
    npm i postcss-plugin-namespace -D
    å¤åˆ¶ä»£ç 
    ```
    
    -   é…ç½®postcss
    
    1.  åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º`postcss.config.js`æ–‡ä»¶
        
        è¯¥æ’ä»¶ä¼šå°†å…¨å±€æ‰€æœ‰classå‰åŠ ä¸Šç»Ÿä¸€å‰ç¼€ï¼Œå¹¶è¿‡æ»¤æ‰ignoreå†…çš„æ ‡ç­¾ï¼›ignoreå†…å¯ä»¥å†™å­—ç¬¦ä¸²ï¼Œå¯ä»¥å†™æ­£åˆ™è¡¨è¾¾å¼ã€‚ä½†æ¯æ¬¡ç¼–è¯‘å‰éƒ½ä¼šè¿è¡Œï¼Œæ‰€ä»¥å¯èƒ½ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´
        
        æ³¨æ„ï¼šå¦‚æœç”¨`/body/`è¿™æ ·çš„æ­£åˆ™ï¼Œä¼šå°†æ‰€æœ‰å¸¦bodyçš„classéƒ½è¿‡æ»¤æ‰ï¼Œæ¯”å¦‚`el-drawer__body`ã€`el-dialog__body`ç­‰ã€‚
        
    
    ```
    module.exports = ctx => {
        return {
            plugins: [
                require('postcss-plugin-namespace')('#your-prefix', {
                    ignore: ['html', /body/]
                })
            ]
        }
    }
    å¤åˆ¶ä»£ç 
    ```
    
    -   public/index.html
    
    ```
    <html id="your-prefix"></html>
    å¤åˆ¶ä»£ç 
    ```
    

## JavaScript æ²™ç®±

qiankunæ¡†æ¶ä¸ºäº†å®ç° JavaScriptéš”ç¦»ï¼Œæä¾›äº†ä¸‰ç§ä¸åŒåœºæ™¯ä½¿ç”¨çš„æ²™ç®±ï¼Œåˆ†åˆ«æ˜¯Â **`snapshotSandbox`**ã€**`proxySandbox`**ã€**`legacySandbox`**

-   å¿«ç…§æ²™ç®±(snapshotSandbox)ï¼š`qiankun`çš„å¿«ç…§æ²™ç®±æ˜¯åŸºäº`diff`æ¥å®ç°çš„ï¼Œä¸»è¦ç”¨äºä¸æ”¯æŒ`window.Proxy`çš„ä½ç‰ˆæœ¬æµè§ˆå™¨(IE æµè§ˆå™¨)ï¼Œè€Œä¸”ä¹Ÿåªé€‚åº”å•ä¸ªçš„å­åº”ç”¨
-   ä»£ç†æ²™ç®±(proxySandbox)ï¼š`qiankun`åŸºäº`es6`çš„`Proxy`å®ç°äº†ä¸¤ç§åº”ç”¨åœºæ™¯ä¸åŒçš„æ²™ç®±ï¼Œ
    -   ä¸€ç§æ˜¯`legacySandbox`(å•ä¾‹)
    -   ä¸€ç§æ˜¯`proxySandbox`(å¤šä¾‹)
-   PSï¼š**qiankun é»˜è®¤å¼€å¯æ²™ç®±æ¨¡å¼**
    -   ä½†æ˜¯qiankunç›®å‰è¿˜æ˜¯æœ‰ä¸€äº›ç¼ºé™·ï¼š **ç»™æŸä¸ªå†…ç½®å¯¹è±¡æ·»åŠ å±æ€§æˆ–æ–¹æ³•ä¼šå¯¼è‡´çªç ´æ²™ç®±é™åˆ¶ï¼Œæ±¡æŸ“éƒ½å…¨å±€çš„windowå±æ€§**
        
    -   **æ²™ç®±ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œæ²™ç®±åªæœ‰ä¸€å±‚çš„åŠ«æŒï¼Œä¾‹å¦‚ Date.prototype.xxx è¿™æ ·çš„æ”¹åŠ¨æ˜¯ä¸ä¼šè¢«è¿˜åŸçš„**
        

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c2f54fbb067941e39786ea9c50f24d21~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

```
    // ç¤ºä¾‹
    // 1. å­åº”ç”¨-æ”¹å†™äº† setItem æ–¹æ³•
    window.localStorage.setItem = function() {
      console.log('Hi child')
    }

    // 2. å…„å¼Ÿåº”ç”¨-è°ƒç”¨ setItem
    console.log(window.localStorage.setItem) // Æ’ () {console.log('Hi child')} æ±¡æŸ“äº†å…¨å±€

    // 3. ä¸»åº”ç”¨-è°ƒç”¨ setItem
    console.log(window.localStorage.setItem) // Æ’ () {console.log('Hi child')} æ±¡æŸ“äº†å…¨å±€
å¤åˆ¶ä»£ç 
```

-   **å¾®åº”ç”¨æŒ‚è½½windowçš„ æ˜¯ proxy ä»£ç†å‡ºæ¥çš„ windowï¼Œå¹¶ä¸æ˜¯çœŸå®çš„windowï¼Œæ‰€ä»¥ä¿®æ”¹ä¼šè¢«éš”ç¦»æ‰**

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83e790b37e654278bd4f21d5148f65ff~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

```
// 1. ä¸»åº”ç”¨
window.user = {
    my: {
        name: 'I m your father'
    }
}

// 2. å¾®åº”ç”¨ è¿™é‡Œç¬¬ä¸€æ¬¡è¾“å‡ºè¿˜æ˜¯ä¼šç»§æ‰¿çˆ¶çš„ æ•°æ®
console.log(window.user)  // {my: {name: "I m your father"}}

window.user = { // æ”¹å˜æ•°æ®
    my: {
        name: 'child'
    }
}

console.log(window.user)  // {my: {name: "child"}}

// 3. å…„å¼Ÿåº”ç”¨ å› ä¸ºæœ‰æ²™ç®±éš”ç¦»ä¸ä¼šå½±å“åˆ° window
console.log(window.user)  // {my: {name: "I m your father"}}
å¤åˆ¶ä»£ç 
```

å¾®å‰ç«¯ä¸­æœ€å¤šçš„é—®é¢˜å°±æ˜¯åœ¨æ²™ç®±ä¸­äº†ï¼Œæ— è®ºæ˜¯ CSS è¿˜æ˜¯ JavaScript æ²™ç®±éƒ½ä¸æ˜¯åå…¨åç¾çš„ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡å„ç§çº¦æŸæ¥é¿å…æ²™ç®±å‡ºç°é—®é¢˜çš„å¯èƒ½ã€‚ä¾‹å¦‚ï¼šå»ºç«‹å›¢é˜Ÿå‰ç¼€ï¼Œå‘½åç©ºé—´ CSSã€äº‹ä»¶ã€æœ¬åœ°å­˜å‚¨å’Œ Cookieï¼Œä»¥é¿å…å†²çªå¹¶æ˜ç¡®æ‰€æœ‰æƒã€‚

**ç¬”è€…æ•´ç†äº†ä¸€ä¸‹ç»å¸¸å‡ºç°é—®é¢˜çš„åœºæ™¯ã€‚**

1.  ç”±äº qiankun æ²™ç®±çš„ç¼ºé™·ï¼Œwindow å¯¹è±¡å¹¶ä¸æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œå­åº”ç”¨çš„ window åˆæ˜¯åŸºäºçˆ¶åº”ç”¨çš„ï¼Œç»å¸¸å¯¼è‡´çš„æ˜¯ï¼šçˆ¶åº”ç”¨çš„ä¾èµ–åº“å·²ç»æŒ‚åˆ°windowä¸Šäº†ï¼Œå­åº”ç”¨å†æŒ‚è½½çš„æ—¶å€™å°±æŠ¥é”™äº†
2.  å¾®å‰ç«¯æµ·çº³ç™¾å·çš„ç‰¹æ€§ï¼Œå½“ä¸åŒæŠ€æœ¯æ ˆçš„åº”ç”¨è¢«é›†åˆåœ¨åŒä¸€ä¸ªâ€è¿è¡Œæ—¶ç¯å¢ƒâ€œçš„æ—¶å€™ï¼Œå¾®åº”ç”¨ä¹‹é—´ä¼šå‡ºç°æ ·å¼äº’æ‰°çš„é—®é¢˜ï¼Œä¾èµ–ç‰ˆæœ¬å†²çªçš„é—®é¢˜
3.  ä»£ç åœ¨æ²™ç®±å†…è¿è¡Œé”™è¯¯çš„é—®é¢˜ï¼Œä¸»è¦æ˜¯ BOMï¼ŒDOM çš„ API ä½¿ç”¨å†²çªï¼Œå› ä¸ºæ— æ³•éš”ç¦»æ‰€ä»¥ä¼šæœ‰æ”¹å†™çš„å±æœº
4.  qiankun ä¼šå°†å¾®åº”ç”¨çš„ JS/CSS å†…å®¹éƒ½è®°å½•åœ¨å…¨å±€å˜é‡ä¸­ï¼Œå¦‚æœä¸€ç›´é‡å¤çš„æŒ‚è½½åº”ç”¨æ²¡æœ‰å¸è½½ï¼Œä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡å¤šï¼Œå¯¼è‡´é¡µé¢å¡é¡¿ã€‚
5.  ç»™ body ã€ document ç­‰ç»‘å®šçš„äº‹ä»¶ï¼Œå¿…é¡»åœ¨ unmount å‘¨æœŸæ¸…é™¤ï¼Œä½¿ç”¨ document.body.addEventListener æˆ–è€… document.body.onClick æ·»åŠ çš„äº‹ä»¶å¹¶ä¸ä¼šè¢«æ²™ç®±ç§»é™¤ï¼Œä¼šå¯¹å…¶ä»–çš„é¡µé¢äº§ç”Ÿå½±å“
6.  ç¬¬ä¸‰æ–¹å¼•å…¥çš„ JS ä¸ç”Ÿæ•ˆï¼Œæœ‰äº› JS æ–‡ä»¶æœ¬èº«æ˜¯ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œæˆ–è€…ä¼šåŠ¨æ€çš„åˆ›å»º scipt æ ‡ç­¾ï¼Œä½†æ˜¯æ‰€æœ‰è·å–èµ„æºçš„è¯·æ±‚æ˜¯è¢«ä¹¾å¤åŠ«æŒå¤„ç†ï¼Œæ‰€ä»¥éƒ½ä¸ä¼šæ­£å¸¸æ‰§è¡Œï¼Œä¹Ÿä¸ä¼šåœ¨ window ä¸‹é¢æŒ‚è½½ç›¸åº”çš„å˜é‡
7.  ç”±äºæ˜¯ç›¸åŒçš„ window å¯¹è±¡ï¼Œä¸ä¼šæœ‰åº”ç”¨ä¹‹é—´çš„éš”ç¦»ï¼ŒlocalStorageã€sessionStorageã€cookie ç­‰å¯¹è±¡äº’ç›¸å†²çªè¦†ç›–
8.  æ”¹å˜å…¨å±€å˜é‡ window/location çš„é»˜è®¤è¡Œä¸ºï¼Œé€šè¿‡ document æ“ä½œ Layout çš„ DOMï¼Œè¿™äº›æœ¬èº«éƒ½æ˜¯ä¸€äº›ä¸æ¨èçš„åšæ³•

## åå››ã€localStorageã€sessionStorageåº”ç”¨ä¹‹é—´çš„ä½¿ç”¨

-   **å› ä¸ºçˆ¶å­åº”ç”¨éƒ½æ˜¯åŒä¸€ä¸ª windowï¼Œæ‰€ä»¥ localStorageã€sessionStorageã€cookie, è¿™äº›æ–¹æ³•å°±ä¼šé€ æˆæ•°æ®è¦†ç›–é—®é¢˜**
-   æ­£å¸¸è¯»å–å³å¯ï¼Œå› ä¸ºæ— è®ºçˆ¶å­åº”ç”¨ï¼Œå­˜å‚¨çš„ç›¸å…³ä¿¡æ¯éƒ½ä»¥çˆ¶åº”ç”¨çš„åœ°å€è¿›è¡Œå­˜å‚¨ã€‚
-   éœ€è¦æ³¨æ„å¾®åº”ç”¨ä¹‹é—´æ•°æ®å†²çªã€æ•°æ®è¦†ç›–é—®é¢˜ï¼Œè¿™é‡Œæ”¹å†™ä¸€ä¸ª setItem getItme è§£å†³è¿™ä¸ªé—®é¢˜

PS:

-   æ­¤æ–¹æ¡ˆåªæ˜¯é’ˆå¯¹éš¾ä»¥æ”¹åŠ¨çš„è€é¡¹ç›®å»åšçš„ï¼Œä¸æ¨èå»æ”¹å˜ window çš„æ–¹æ³•ï¼Œå¦‚æœæ‚¨æœ‰è¿™ä¸ªéœ€æ±‚åˆ™åº”è¯¥å»æŠ½ç¦»æˆä¸€ä¸ªç±»æˆ–å‡½æ•°å»åšã€‚
-   å­é¡¹ç›®çš„æ”¹åŠ¨åŸ window çš„ prototype qiankun çš„æ²™ç®±æ— æ³•å¤„ç†éš”ç¦»
-   ç›®å‰ä¸æ”¯æŒ sessionStorage\[â€œkeyNameâ€\] = valueï¼Œ sessionStorage.keyName = value è¿™ç§å†™æ³•ï¼Œå¦‚æœæƒ³ä½¿ç”¨ä»¥ä¸Šæ–¹æ³•å¯ä»¥ä½¿ç”¨ proxy or defineProperty æ”¹å†™æœ¬æ–‡ä¸å†èµ˜è¿°
-   åŠ¨æ€ç»™ getItemã€setItemæ–¹æ³•åŠ å‰ç¼€ï¼Œè¿™æ ·åœ¨æ¥å…¥æ—§é¡¹ç›®çš„æ—¶å€™ä¸ä¼šè¿™ä¹ˆç—›è‹¦ï¼Œå–å·§æ–¹å¼ï¼Œä¸æ¨è

```
//å®šä¹‰éœ€è¦éå†çš„å¸¸é‡
const storageMap = [
  {
    storage: sessionStorage,
    method: 'getItem'
  },
  {
    storage: sessionStorage,
    method: 'setItem'
  },
  {
    storage: localStorage,
    method: 'getItem'
  },
  {
    storage: localStorage,
    method: 'setItem'
  }
]

// æ”¹å†™æ–¹æ³•
function formatItem(storage, method) {
  storage[method] = function(key, value, isGlobal = false) { // isGlobal æ˜¯å¦å­˜å‚¨oræŸ¥æ‰¾å…¨å±€
    if (window.__POWERED_BY_QIANKUN__ && !isGlobal) { // å¦‚æœæ˜¯qiankunåˆ™è¿½åŠ å‰ç¼€
      key = BASE_ROUTER_PATH + key
    }
    Object.getPrototypeOf(storage)[method].call(this, key, value) // å¼•ç”¨åŸæ–¹æ³•æ”¹åŠ¨æœ€å°åŒ–
  }
}

// éå†æ–¹æ³•
storageMap.forEach(({ storage, method }) => {
  formatItem(storage, method)
})
å¤åˆ¶ä»£ç 
```

## åäº”ã€èµ„æºå…±äº«

![https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d381aa6a6e34b11bf0c9ae59dcc85f4~tplv-k3u1fbpfcp-zoom-1.image](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f71322ec729d4f7482bf4c952dc95fb6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

å¯¹äºåº”ç”¨ä¹‹é—´çš„èµ„æºå…±äº«ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªä¸å¾®å‰ç«¯çš„æ¦‚å¿µæ˜¯æœ‰çŸ›ç›¾çš„ã€‚

å¾®å‰ç«¯çš„æ¦‚å¿µï¼š

-   ã€ŒæŠ€æœ¯æ ˆæ— å…³ã€ï¼š ä¸»æ¡†æ¶ä¸é™åˆ¶æ¥å…¥åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œå­åº”ç”¨å…·å¤‡å®Œå…¨è‡ªä¸»æƒ
-   ã€Œç‹¬ç«‹å¼€å‘ ç‹¬ç«‹éƒ¨ç½²ã€ï¼š å­åº”ç”¨ä»“åº“ç‹¬ç«‹ï¼Œå¯ç‹¬ç«‹å¼€å‘ï¼Œéƒ¨ç½²å®Œæˆåä¸»æ¡†æ¶è‡ªåŠ¨å®ŒæˆåŒæ­¥æ›´æ–°
-   ã€Œç‹¬ç«‹è¿è¡Œã€ï¼š æ¯ä¸ªå­åº”ç”¨ä¹‹é—´çŠ¶æ€éš”ç¦»ï¼Œè¿è¡Œæ—¶çŠ¶æ€ä¸å…±äº«ï¼Œä¸è¦å…±äº«è¿è¡Œæ—¶ï¼Œå³ä½¿æ‰€æœ‰å›¢é˜Ÿéƒ½ä½¿ç”¨ç›¸åŒçš„æ¡† æ¶ã€‚æ„å»ºè‡ªåŒ…å«çš„ç‹¬ç«‹åº”ç”¨ç¨‹åºã€‚ä¸è¦ä¾èµ–å…±äº«çŠ¶æ€æˆ–å…¨å±€å˜é‡ã€‚

çŸ›ç›¾æ€è€ƒï¼š

1.  ã€ŒæŠ€æœ¯æ ˆæ— å…³ã€æ˜¯æ¶æ„ä¸Šçš„å‡†ç»³ï¼Œå…·ä½“åˆ°å®ç°æ—¶ï¼Œå¯¹åº”çš„å°±æ˜¯ï¼šåº”ç”¨ä¹‹é—´ä¸åº”è¯¥æœ‰ä»»ä½•ç›´æ¥æˆ–é—´æ¥çš„æŠ€æœ¯æ ˆã€ä¾èµ–ã€ä»¥åŠå®ç°ä¸Šçš„è€¦åˆã€‚
2.  æŒ‰ç…§ç†æƒ³çš„æƒ…å†µï¼šæˆ‘ä»¬å¸Œæœ›å¾®å‰ç«¯å°½å¯èƒ½ç‹¬ç«‹è§£è€¦ï¼Œä½†æ˜¯ä¸åŒå¾®åº”ç”¨ä¹‹é—´å¯èƒ½å­˜åœ¨å¤§é‡ç›¸åŒçš„é‡å¤çš„èµ„æºä¾èµ–ï¼Œåœ¨åˆ†ç§’å¿…äº‰çš„ä»Šå¤©ï¼Œæ¯ä¸€ä¸ªèµ„æºçš„å¼€é”€éƒ½ä¸å®¹å°è§‘ï¼Œå¦‚æœæŠŠä¸€äº›å¯å¤ç”¨çš„èµ„æºç›´æ¥å…±äº«å‡ºå»ï¼Œé‚£å²‚ä¸æ˜¯å¯ä»¥é«˜æ•ˆé™ä½èµ„æºçš„å¼€é”€äº†å—ã€‚
3.  å½“æˆ‘ä»¬æŠŠèµ„æºå…±äº«å‡ºå»çš„æ—¶ï¼Œä¹Ÿç»™åº”ç”¨å¸¦æ¥äº†ä¾èµ–å†—ä½™ï¼Œå¾®åº”ç”¨æŠŠå…¬å…±èµ„æºå¼•å…¥çš„åŒæ—¶ï¼Œä¹ŸæŠŠæœªæ¥çš„å¤æ‚æ€§ä¹Ÿç»™å¼•å…¥è¿›æ¥äº†ã€‚

## **1\. å…±äº«æ¨¡å—æ–¹å¼**

ä»¥ä¸‹æ˜¯ç¬”è€…æ•´ç†çš„å…±äº«æ¨¡å—çš„æ–¹å¼ï¼Œ

### npm ä¾èµ–

-   æŠ½ç¦»ç›¸å…³ä»£ç ï¼ˆutilsã€ç»„ä»¶..) å°†å…¶æ‰“åŒ…å¹¶ä¸Šä¼  npm åº“ï¼Œç„¶ååœ¨éœ€è¦çš„å¾®åº”ç”¨ä¸­ä»¥æœ¬åœ°ä¾èµ–æˆ– npm link çš„æ–¹å¼å®‰è£…ä¾èµ–ï¼Œä»¥ npm çš„æ–¹å¼è¾¾åˆ°èµ„æºå…±äº«çš„ç›®çš„ã€‚ä½†æ˜¯å…¶æœ¬è´¨åªæ˜¯ä»£ç å±‚é¢çš„å…±äº«ä¸å¤ç”¨ï¼Œæ¯ä¸ªåº”ç”¨æ„å»ºçš„çš„æ—¶å€™è¿˜æ˜¯ä¼šæŠŠä¾èµ–åŒ…ä¸€èµ·æ‰“åŒ…
-   å¹¶ä¸” npm ç®¡ç†ï¼Œæ¯æ¬¡ npm æ›´æ–°çš„æ—¶å€™éƒ½è¦åœ¨å„å¾®åº”ç”¨è¿›è¡Œé‡æ–°æ„å»ºå‘å¸ƒã€‚

### git submodule or git subtree

-   [ğŸš€ Link git submodule](https://link.juejin.cn/?target=https%3A%2F%2Fgit-scm.com%2Fbook%2Fzh%2Fv2%2FGit-%25E5%25B7%25A5%25E5%2585%25B7-%25E5%25AD%2590%25E6%25A8%25A1%25E5%259D%2597 "https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%AD%90%E6%A8%A1%E5%9D%97")
-   subtree å’Œ submodule çš„ç›®çš„éƒ½æ˜¯ç”¨äº git å­ä»“åº“ç®¡ç†ï¼ŒäºŒè€…çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œsubtree å±äºæ‹·è´å­ä»“åº“ï¼Œè€Œ submodule å±äºå¼•ç”¨å­ä»“åº“ã€‚
-   ä»–ä»¬å…è®¸ä½ å°†ä¸€ä¸ª Git ä»“åº“å½“ä½œå¦å¤–ä¸€ä¸ª Git ä»“åº“çš„å­ç›®å½•ã€‚è¿™å…è®¸ä½ å…‹éš†å¦å¤–ä¸€ä¸ªä»“åº“åˆ°ä½ çš„é¡¹ç›®ä¸­å¹¶ä¸”ä¿æŒä½ çš„æäº¤ç›¸å¯¹ç‹¬ç«‹
-   åˆ›å»ºä¸€ä¸ª libs çš„é¡¹ç›®è¿›è¡Œç®¡ç†ç»´æŠ¤ï¼Œé‡Œé¢å­˜æ”¾å„ç§å…¬ç”¨çš„æ–¹æ³•ï¼Œç»„ä»¶ï¼Œå›¾ç‰‡ç­‰ï¼Œå¹¶ä¸”åŒæ­¥åˆ°gitlabä¸Š
-   `git submodule` å’Œ `git subtree` éƒ½æ˜¯å¾ˆå¥½çš„å­ä»“åº“ç®¡ç†æ–¹æ¡ˆï¼Œä½†ç¼ºç‚¹æ˜¯æ¯æ¬¡å­åº”ç”¨å˜æ›´åï¼Œèšåˆåº“è¿˜å¾—åŒæ­¥ä¸€æ¬¡å˜æ›´ï¼Œè€ƒè™‘åˆ°å¹¶ä¸æ˜¯æ‰€æœ‰äººéƒ½ä¼šä½¿ç”¨è¯¥èšåˆä»“åº“ï¼Œå­ä»“åº“ç‹¬ç«‹å¼€å‘æ—¶å¾€å¾€ä¸ä¼šä¸»åŠ¨åŒæ­¥åˆ°èšåˆåº“ï¼Œä½¿ç”¨èšåˆåº“çš„åŒå­¦å°±å¾—ç»å¸¸åšåŒæ­¥çš„æ“ä½œï¼Œæ¯”è¾ƒè€—æ—¶è€—åŠ›ï¼Œä¸ç®—ç‰¹åˆ«å®Œç¾ã€‚

### webpack Externals

-   [ğŸš€ Link git Externals](https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.docschina.org%2Fconfiguration%2Fexternals%2F "https://webpack.docschina.org/configuration/externals/")
-   é…ç½® webpack è¾“å‡ºçš„ bundle ä¸­æ’é™¤ä¾èµ–ï¼Œæ¢å¥è¯è¯´é€šè¿‡åœ¨ Externals å®šä¹‰çš„ä¾èµ–ï¼Œæœ€ç»ˆè¾“å‡ºçš„ bundle ä¸å­˜åœ¨è¯¥ä¾èµ–ï¼Œ
-   externals å‰ææ˜¯ä¾èµ–éƒ½è¦æœ‰ cdn æˆ– æ‰¾åˆ°å®ƒå¯¹åº”çš„ JS æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š[jQuery](https://link.juejin.cn/?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3DjQuery%26spm%3D1001.2101.3001.7020 "https://so.csdn.net/so/search?q=jQuery&spm=1001.2101.3001.7020").min.js ä¹‹ç±»çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›ä¾èµ–æ’ä»¶å¾—è¦æ˜¯æ”¯æŒ umd æ ¼å¼çš„æ‰è¡Œã€‚
-   é€šè¿‡è¿™ç§å½¢å¼åœ¨å¾®å‰ç«¯åŸºåº§åº”ç”¨åŠ è½½å…¬å…±æ¨¡å—ï¼Œå¹¶å°†å¾®åº”ç”¨å¼•ç”¨åŒæ ·æ¨¡å—çš„Externals ç§»é™¤æ‰ï¼Œå°±å¯ä»¥å®ç°æ¨¡å—å…±äº«äº† ä½†æ˜¯å­˜åœ¨å¾®åº”ç”¨æŠ€æœ¯æ ˆå¤šæ ·åŒ–ä¸ç»Ÿä¸€çš„æƒ…å†µï¼Œå¯èƒ½æœ‰çš„ä½¿ç”¨ Vue3ï¼Œæœ‰çš„ä½¿ç”¨ React å¼€å‘ï¼Œä½† externals å¹¶æ— æ³•æ”¯æŒ`å¤šç‰ˆæœ¬å…±å­˜`çš„æƒ…å†µ

> qiankunä¸å»ºè®®å…±äº«ä¾èµ–ï¼Œæ‹…å¿ƒåŸå‹é“¾æ±¡æŸ“ç­‰é—®é¢˜ï¼Œå¦‚æœä¸€å®šè¦ä½¿ç”¨ï¼šæ¨èä½¿ç”¨webpackçš„ [Externals](https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.docschina.org%2Fconfiguration%2Fexternals%2F "https://webpack.docschina.org/configuration/externals/") æ¥å…±äº«ä¾èµ–åº“ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**[](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fumijs%2Fqiankun%2Fissues%2F627 "https://github.com/umijs/qiankun/issues/627")

-   å¦‚æœä¸»å­åº”ç”¨ä½¿ç”¨çš„æ˜¯**ç›¸åŒçš„åº“æˆ–è€…åŒ…ï¼ï¼ï¼** (`vueã€axiosã€vue-routerã€element` ç­‰) å¯ä»¥ç”¨ [externals](https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.docschina.org%2Fconfiguration%2Fexternals "https://webpack.docschina.org/configuration/externals") çš„æ–¹å¼æ¥å¼•å…¥ï¼Œå‡å°‘åŠ è½½é‡å¤åŒ…å¯¼è‡´èµ„æºæµªè´¹ï¼Œ**ä¸€ä¸ªé¡¹ç›®ä½¿ç”¨äº†ä¹‹åï¼Œå¦ä¸€ä¸ªé¡¹ç›®ä½¿ç”¨ä¸å†é‡å¤åŠ è½½ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨è¿™ä¸ªæ–‡ä»¶**ã€‚

**ä½¿ç”¨åŸç†ï¼š**

-   `qiankun` å°†å­é¡¹ç›®çš„å¤–é“¾ `script` æ ‡ç­¾ï¼Œå†…å®¹è¯·æ±‚åˆ°ä¹‹åï¼Œä¼šè®°å½•åˆ°ä¸€ä¸ªå…¨å±€å˜é‡ä¸­ï¼Œä¸‹æ¬¡å†æ¬¡ä½¿ç”¨ï¼Œä»–ä¼šå…ˆä»è¿™ä¸ªå…¨å±€å˜é‡ä¸­å–ã€‚è¿™æ ·å°±ä¼šå®ç°å†…å®¹çš„å¤ç”¨ï¼Œåªè¦ä¿è¯ä¸¤ä¸ªé“¾æ¥çš„ `url` ä¸€è‡´å³å¯ã€‚

**ä½¿ç”¨æ–¹å¼ï¼š**

-   å¾®åº”ç”¨ä¹‹é—´ä½¿ç”¨
    
    -   åªè¦å­é¡¹ç›®é…ç½®äº†`webpack` çš„ [externals](https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.docschina.org%2Fconfiguration%2Fexternals%2F "https://webpack.docschina.org/configuration/externals/")ï¼Œå¹¶åœ¨ `index.html` ä¸­ä½¿ç”¨å¤–é“¾ `script` å¼•å…¥è¿™äº›å…¬å…±ä¾èµ–ï¼Œåªè¦è¿™äº›å…¬å…±ä¾èµ–URLä¸€è‡´å³å¯ï¼Œè¯·æ±‚çš„æ—¶å€™ä¼šä¼˜å…ˆä»ç¼“å­˜ä¸­è¯»å–ï¼Œç±»ä¼¼HTTPç¼“å­˜
-   å¾®åº”ç”¨ä½¿ç”¨åŸºåº§ä¾èµ–
    
    -   ç»™å¾®åº”ç”¨çš„å…¬å…±ä¾èµ–çš„åŠ ä¸Š `ignore` å±æ€§ï¼ˆè¿™æ˜¯è‡ªå®šä¹‰çš„å±æ€§ï¼Œéæ ‡å‡†å±æ€§ï¼‰ã€‚
    -   `qiankun` åœ¨å…¥å£è§£æçš„æ—¶å€™ä¼šåˆ¤æ–­å¦‚æœæœ‰è¿™ä¸ªå±æ€§å°±å¿½ç•¥ã€‚å­é¡¹ç›®ç‹¬ç«‹è¿è¡Œï¼Œè¿™äº› `js/css` ä»èƒ½è¢«åŠ è½½ï¼Œå¦‚æ­¤ï¼Œä¾¿å®ç°äº†â€œå­é¡¹ç›®å¤ç”¨ä¸»é¡¹ç›®çš„ä¾èµ–â€ã€‚

```
module.exports = { 
    configureWebpack: { 
        externals: { 
            'vue': 'Vue', 
            'vue-router': 'VueRouter', 
            'vuex': 'Vuex', 
            'element-ui': 'ELEMENT' 
        }
    }
}
å¤åˆ¶ä»£ç 
```

```
<link ignore rel="stylesheet" href="//cnd.com/antd.css">
<script ignore src="//cnd.com/antd.js"></script>
å¤åˆ¶ä»£ç 
```

PSï¼šä¸»é¡¹ç›®ä½¿ç”¨`externals` åï¼Œå­é¡¹ç›®å¯ä»¥å¤ç”¨å®ƒçš„ä¾èµ–ï¼Œä½†æ˜¯ä¸å¤ç”¨ä¾èµ–çš„å­é¡¹ç›®ä¼šæŠ¥é”™ã€‚

[ğŸš€ Link # \[Bug\]å…¬å…±ä¾èµ–æå–çš„æ—¶å€™ï¼Œqiankunï¼Œä»£ç†windowè®¿é—®å¹¶æ²¡æœ‰å…ˆè®¿é—®å¾®åº”ç”¨çš„windowï¼Œå†è®¿é—®ä¸»åº”ç”¨çš„window](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fumijs%2Fqiankun%2Fissues%2F718 "https://github.com/umijs/qiankun/issues/718")

### webpack DLL

-   [ğŸš€ Link webpack DLL](https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.docschina.org%2Fplugins%2Fdll-plugin%2F "https://webpack.docschina.org/plugins/dll-plugin/")
-   dll æ’ä»¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç›´æ¥å°†å·²å®‰è£…å¥½çš„ä¾èµ–åœ¨ node\_module ä¸­æ‰“åŒ…å‡ºæ¥ï¼Œç»“åˆ **add-asset-html-webpack-plugin** æ’ä»¶å¸®åŠ©æˆ‘ä»¬å°†ç”Ÿæˆæ‰“åŒ…å¥½çš„ js æ–‡ä»¶æ’å…¥åˆ° html ä¸­
-   å› ä¸ºä½¿ç”¨å…¬å…±ä¾èµ–ï¼Œæ„å‘³ç€æ‰€æœ‰ä½¿ç”¨å…¬å…±ä¾èµ–çš„åº”ç”¨ï¼Œå¿…é¡»ä½¿ç”¨åŒç‰ˆæœ¬çš„ä¾èµ–ï¼Œå¹¶ä¸” qiankun ä½¿ç”¨ dllplugin æå–å…¬å…±ä¾èµ–åï¼Œå¯¼è‡´ä¸åŒå­åº”ç”¨ä¸­çš„å…¨å±€ filterã€componentã€mixin ç›¸äº’å½±å“

### ä½¿ç”¨lernaç®¡ç†

-   [Lerna Â· æ˜¯ä¸€ä¸ªç®¡ç†å·¥å…·ï¼Œç”¨äºç®¡ç†åŒ…å«å¤šä¸ªè½¯ä»¶åŒ…ï¼ˆpackageï¼‰çš„ JavaScript é¡¹ç›® | Lerna ä¸­æ–‡æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Fwww.lernajs.cn%2F "https://www.lernajs.cn/")

### é€šè¿‡èšåˆç›®å½•

-   èšåˆç›®å½•ç›¸å½“äºæ˜¯ä¸€ä¸ªç©ºç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹ clone æ‰€æœ‰å­ä»“åº“ï¼Œå¹¶ .gitignoreï¼Œå­ä»“åº“çš„ä»£ç æäº¤éƒ½åœ¨å„è‡ªçš„ä»“åº“ç›®å½•ä¸‹è¿›è¡Œæ“ä½œï¼Œè¿™æ ·èšåˆåº“å¯ä»¥é¿å…åšåŒæ­¥çš„æ“ä½œã€‚

ä¸Šé¢çš„æ–¹æ¡ˆéƒ½æ˜¯ä¸šå†…æ¯”è¾ƒæˆç†Ÿçš„æ–¹æ¡ˆï¼Œè¿˜éœ€å¼€å‘è€…æ·±å…¥äº†è§£ï¼Œç¬”è€…é‡‡ç”¨çš„æ˜¯ï¼šNPMã€webpack externalã€‚å¯¹å¤–çš„ä¸”ç¨³å®šçš„ç»„ä»¶æˆ–å°è£…ï¼Œæ¨è `npm` åŒ…æ–¹å¼ã€‚

## 2\. é€šè¿‡ä¸»åº”ç”¨å…±äº«èµ„æºç»™å¾®åº”ç”¨

ä¸»åº”ç”¨çš„ä¸‹å‘èµ„æºçš„æ ¸å¿ƒå°±æ˜¯ï¼š**æ³¨å†Œçš„æ—¶å€™é€šè¿‡ props ä¸‹å‘**

### **props æ–¹å¼**

-   **çˆ¶åº”ç”¨æ³¨å†Œæ—¶æˆ–åŠ è½½æ—¶ï¼Œå°†ä¾èµ–é€šè¿‡ `props` ä¼ é€’ç»™å­åº”ç”¨ï¼Œå­åº”ç”¨åœ¨ `bootstrap` æˆ–è€… `mount` é’©å­å‡½æ•°ä¸­è·å–**
-   ä¸»åº”ç”¨æ³¨å†Œä¸‹å‘ï¼Œä»»ä½•ä½ æƒ³è¦çš„èµ„æºï¼Œä½†æ˜¯åˆ‡å‹¿æ— è„‘ä¸‹å‘èµ„æºï¼Œéœ€è¦è€ƒè™‘æ—¥åè§£è€¦æˆ–ç‹¬ç«‹è¿è¡Œçš„é—®é¢˜ã€‚

```
// ä¸»åº”ç”¨/src/const/micro/application-list.js
import { layout, assets, config, layout, public } from '/lib'

export default [{
    name: 'you-app-name', // åº”ç”¨çš„åå­—
    entry: '//localhost:7286/', // é»˜è®¤ä¼šåŠ è½½è¿™ä¸ªhtml è§£æé‡Œé¢çš„js åŠ¨æ€çš„æ‰§è¡Œ ï¼ˆå­åº”ç”¨å¿…é¡»æ”¯æŒè·¨åŸŸï¼‰fetch
    container: '#you-app-name-container', // å®¹å™¨id
    activeRule: '/you-app-name', // æ ¹æ®è·¯ç”±æ¿€æ´»çš„è·¯å¾„ï¼Œè¿™é‡Œæ³¨æ„è¦ä¸å­åº”ç”¨å¯¹åº”çš„ package ==> name æ–‡ä»¶ä¸€è‡´
    props: { // ä¸‹å‘å¾®åº”ç”¨çš„å…¥å£, å¦‚æœæ˜¯å›ºå®šç¡®è®¤çš„èµ„æºå¯ä»¥ç»´æŠ¤åœ¨åº”ç”¨æ³¨å†Œåˆ—è¡¨
        hideLayout: true, // æ˜¯å¦éšè—å­åº”ç”¨ä¾§è¾¹æ ã€å¯¼èˆªæ 
        defaultPath: '', // é»˜è®¤è·³è½¬åœ°å€
        commonComponent: {}, // ä¸‹å‘çš„ç»„ä»¶
        public: public, // çˆ¶äº²åº”ç”¨å…¬å…±æ–‡ä»¶
        assets: assets, // çˆ¶åº”ç”¨èµ„æºæ–‡ä»¶
        config: config, // çˆ¶åº”ç”¨é…ç½®æ–‡ä»¶
        layout: layout  // çˆ¶åº”ç”¨å¸ƒå±€ç»„ä»¶
    }
}]
å¤åˆ¶ä»£ç 
```

å¦‚æœæ˜¯åŠ¨æ€æ•°æ®å¯ä»¥æ³¨å†Œçš„æ—¶å€™ä¼ é€’ä¸‹å‘

```
import store from '@/store/index'
import router from '@/router'

// åœ¨å¾®åº”ç”¨ props å±æ€§ åŠ¨æ€ä¸‹å‘é…ç½®ã€‚
currentApp.props = {
  ...currentApp.props,
  router: router, // ä¸‹å‘çˆ¶åº”ç”¨è·¯ç”±
  store: store // ä¸‹å‘çˆ¶åº”ç”¨vuex
}

loadMicroApp(currentApp) // æ³¨å†Œåº”ç”¨çš„æ—¶å€™åœ¨å­åº”ç”¨å¯ä»¥åœ¨å¾®åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸­è·å–
å¤åˆ¶ä»£ç 
```

-   å¾®åº”ç”¨æ¥æ”¶

```
// å¾®åº”ç”¨ mount ä¸­æ¥æ”¶
import childStore from '@/store/index'
import childRouter from '@/router'

export async function mount(props) {
    render(props)
}

// åŠ¨æ€æŒ‚è½½ é€šè¿‡ this.$root.xxx ä½¿ç”¨ data çš„æ•°æ®
function render(props = {}) {
    // è·å–çˆ¶åº”ç”¨ä¸‹å‘çš„èµ„æºï¼Œå¹¶å­˜å‚¨åœ¨ data ä¸Š
    const { container, routerï¼Œstoreï¼Œlayout, config, assets, public, commonComponent } = props
    instance = new Vue({
        childRouter,
        childStore,
        data() {
            return {
                parentRouter: router, // çˆ¶åº”ç”¨è·¯ç”±
                parentVuex: store, // çˆ¶åº”ç”¨ vuex
                parentLayout: layout, // çˆ¶åº”ç”¨å¸ƒå±€ç»„ä»¶
                parentConfig: config, // çˆ¶åº”ç”¨é…ç½®æ–‡ä»¶
                parentAssets: assets, // çˆ¶åº”ç”¨èµ„æºæ–‡ä»¶
                parentPublic: public, // çˆ¶äº²åº”ç”¨å…¬å…±æ–‡ä»¶
                parentCommonComponent: commonComponent // ä¸‹å‘çš„ç»„ä»¶
            }
        },
        render: h => h(App)
    }).$mount(container ? container.querySelector('#you-micro') : '#you-micro')
}
å¤åˆ¶ä»£ç 
```

### window æ–¹å¼

-   å› ä¸ºä¸»é¡¹ç›®ä¼šå…ˆåŠ è½½ï¼Œç„¶åæ‰ä¼šåŠ è½½å­é¡¹ç›®ï¼Œæ‰€ä»¥ä¸€èˆ¬æ˜¯å­é¡¹ç›®å¤ç”¨ä¸»é¡¹ç›®çš„ç»„ä»¶ï¼Œåšæ³•ä¹Ÿå¾ˆç®€å•ï¼Œä¸»é¡¹ç›®åŠ è½½æ—¶ï¼Œå°†ç»„ä»¶æŒ‚è½½åˆ° `window` ä¸Šï¼Œå­é¡¹ç›®ç›´æ¥æ³¨å†Œå³å¯
-   ä½†æ˜¯ç¬”è€…è¿™é‡Œä¸æ¨èä»»ä½•ä¿®æ”¹ window çš„æ–¹å¼ï¼Œå› ä¸ºæ²™ç®±ç¼ºé™·çš„ç¼˜æ•…ï¼Œä¸æ‰“æ‰°å°±æ˜¯æœ€å¥½çš„å®‰æ’ï½

**ä¸»é¡¹ç›®å…¥å£æ–‡ä»¶ï¼š**

```
import HelloWorld from '@/components/HelloWorld.vue'
window.commonComponent = { HelloWorld };
å¤åˆ¶ä»£ç 
```

**å­é¡¹ç›®ç›´æ¥ä½¿ç”¨ï¼š**

```
components: {
  HelloWorld: window.__POWERED_BY_QIANKUN__ ? window.commonComponent.HelloWorld : import('@/components/HelloWorld.vue'))
}
å¤åˆ¶ä»£ç 
```

### **é¡¹ç›®é—´çš„ç»„ä»¶å…±äº«**

> å­é¡¹ç›®æœ¬èº«è‡ªå·±ä¹Ÿæœ‰è¿™ä¸ªç»„ä»¶ï¼Œå½“åˆ«çš„å­é¡¹ç›®å·²ç»åŠ è½½è¿‡äº†ï¼Œå°±å¤ç”¨åˆ«äººçš„ç»„ä»¶ï¼Œå¦‚æœåˆ«çš„å­é¡¹ç›®æœªåŠ è½½ï¼Œå°±ä½¿ç”¨è‡ªå·±çš„è¿™ä¸ªç»„ä»¶

é€‚ç”¨åœºæ™¯å°±æ˜¯é¿å…ç»„ä»¶çš„é‡å¤åŠ è½½ï¼Œè¿™ä¸ªç»„ä»¶å¯èƒ½å¹¶ä¸æ˜¯å…¨å±€çš„ï¼Œåªæ˜¯æŸä¸ªé¡µé¢ä½¿ç”¨ã€‚åšæ³•åˆ†ä¸‰æ­¥ï¼š

**1.ç”±äºå­é¡¹ç›®ä¹‹é—´çš„å…¨å±€å˜é‡ä¸å…±äº«ï¼Œä¸»é¡¹ç›®æä¾›ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨æ¥å­˜æ”¾ç»„ä»¶**

-   **é€šè¿‡ `props` ä¼ ç»™éœ€è¦å…±äº«ç»„ä»¶çš„å­é¡¹ç›®ã€‚**

```
// ä¸»åº”ç”¨
import HelloWorld from '@/components/HelloWorld.vue'

props: {
  commonComponent: {
    HelloWorld
  }
}
å¤åˆ¶ä»£ç 
```

**2.å­é¡¹ç›®æ‹¿åˆ°è¿™ä¸ªå˜é‡æŒ‚è½½åˆ° `window` ä¸Š**

```
export async function mount(props) {
  window.commonComponent = props.data.commonComponent
  render(props.data)
}
å¤åˆ¶ä»£ç 
```

**3.å­é¡¹ç›®ä¸­çš„å…±äº«ç»„ä»¶å†™æˆå¼‚æ­¥ç»„ä»¶ï¼Œå¼‚æ­¥ç»„ä»¶éœ€è¦è¿”å› Promise.resolve()**

```
components: {
   HelloWorld: async () => {
      if (!window.commonComponent) {
        window.commonComponent = {} // ç‹¬ç«‹è¿è¡Œæ—¶
      }
      const HelloWorld = window.commonComponent.HelloWorld
      return HelloWorld || (window.commonComponent.HelloWorld = import('@/components/HelloWorld.vue'))
   }
}
å¤åˆ¶ä»£ç 
```

## åå…­ã€åº”ç”¨é€šä¿¡

**é€šä¿¡è®¾è®¡åŸåˆ™**

-   è·¨åº”ç”¨é€šä¿¡ï¼šè§£è€¦æ˜“æ¥å…¥
-   å¼€æ”¾ä½†ä¸å¤±çº¦æŸï¼šé€šä¿¡æ”¶å£ï¼Œç»Ÿä¸€ç®¡ç†
-   ç®€å•æ˜“ç”¨ï¼šå­¦ä¹ æˆæœ¬ä½ï¼Œæ¥å£å°½å¯èƒ½å°‘
-   æ˜“äºç»´æŠ¤ï¼šåˆ†æ¨¡å—ç®¡ç†ï¼Œé¿å…é€šä¿¡å†²çª
-   å®¹æ˜“æ’æŸ¥ï¼šé“¾è·¯ç›‘æ§æ€§å¼ºï¼ŒåŠæ—¶è·Ÿè¸ªé—®é¢˜

**å¾®å‰ç«¯é€šä¿¡æ–¹å¼**

-   åŸºäº URL
    -   ä½¿ç”¨ç®€å•ã€é€šç”¨æ€§å¼ºï¼Œä½†èƒ½åŠ›è¾ƒå¼±ï¼Œä¸é€‚ç”¨å¤æ‚çš„ä¸šåŠ¡åœºæ™¯
-   åŸºäº Props
    -   åº”ç”¨ç»™å­åº”ç”¨ä¼ å€¼ã€‚é€‚ç”¨äºä¸»å­åº”ç”¨å…±äº«ç»„ä»¶ã€å…¬å…±æ–¹æ³•è°ƒç”¨ç­‰ã€‚
-   å‘å¸ƒ/è®¢é˜…æ¨¡å¼
    -   ä¸€å¯¹å¤šå…³ç³»ï¼Œè§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…æ˜¯æŠ½è±¡è€¦åˆçš„ã€‚ä½†æ˜¯æ•°æ®é“¾è·¯éš¾è·Ÿè¸ªã€‚
-   çŠ¶æ€ç®¡ç†æ¨¡å¼
    -   èƒ½å¤Ÿç»Ÿä¸€ç®¡ç†ï¼Œé“¾è·¯æ¸…æ™°ï¼Œæ˜“ç»´æŠ¤
-   åŸºäº `localStorage`ã€`sessionStorage` å®ç°çš„é€šä¿¡æ–¹å¼
    -   ä¸æ¨èï¼Œå› ä¸º JSON.stringify() ä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼Œå®ƒåªä¼šå¯¹Numberã€Stringã€Boooleanã€Arrayè½¬æ¢ï¼Œå¯¹äºundefinedã€functionã€NaNã€ regExpã€Date éƒ½ä¼šä¸¢å¤±æœ¬èº«çš„å€¼

åŸºäºURLã€Props ã€LocalStorage çš„æ–¹å¼å°±ä¸è®²è¿°äº†ä¸Šæ–‡éƒ½æœ‰å¯¹åº”çš„è¯´æ˜ï¼Œä»¥ä¸‹åªå¯¹ å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼ŒçŠ¶æ€ç®¡ç†æ¨¡å¼è¿›è¡Œè®²è§£

## å‘å¸ƒ/è®¢é˜…æ¨¡å¼ EventBus

ç¬”è€…è¿™é‡Œçš„è®¾è®¡æ¨¡å¼æ˜¯ï¼Œä¸»åº”ç”¨æ³¨å†Œ EventBusï¼Œç„¶åé€šè¿‡ props ä¸‹å‘å¾®åº”ç”¨ï¼Œè¿™æ ·å¾®åº”ç”¨æ—¢æœ‰ä¸»åº”ç”¨çš„EventBus ä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„ EventBus

-   ä¸»åº”ç”¨æ³¨å†Œ EventBus

```
Vue.prototype.$eventBus = new Vue()

export const parentEventBus = Vue.prototype.$eventBus
å¤åˆ¶ä»£ç 
```

-   é€šè¿‡ props ä¸‹å‘

```
// åœ¨å¾®åº”ç”¨ props å±æ€§ åŠ¨æ€ä¸‹å‘é…ç½®ã€‚
import { parentEventBus } from '@/main'

currentApp.props = {
    ...currentActiveMicroConfig.props,
    parentEventBus: parentEventBus // ä¸‹å‘ä¸»åº”ç”¨çš„ EventBus
}

loadMicroApp(currentApp)
å¤åˆ¶ä»£ç 
```

-   å­åº”ç”¨æ¥å—å¹¶æ³¨å†Œ

```
// å¾®åº”ç”¨ mount ä¸­æ¥æ”¶
export async function mount(props) {
    render(props)
}

// åŠ¨æ€æŒ‚è½½ é€šè¿‡ this.$root.xxx ä½¿ç”¨dataçš„æ•°æ®
function render(props = {}) {
    const { parentEventBus } = props
    Vue.prototype.$eventBus = new Vue() // å­åº”ç”¨çš„ç‹¬äº«çš„ EventBus
    Vue.prototype.$parentEventBus = parentEventBus // ä¸»åº”ç”¨ä¸‹å‘çš„ EventBus
    // æ³¨å†Œæ“ä½œçœç•¥ ...
}
å¤åˆ¶ä»£ç 
```

-   ä½¿ç”¨ è¿˜æ˜¯æ­£å¸¸ä½¿ç”¨

```
this.$parentEventBus.$off('you-event') // å…³é—­

this.$parentEventBus.$on('you-event', data => { // ç›‘å¬
  // xxxx code action
})

this.$parentEventBus.$emit('you-event', {...}) // å‘å¸ƒ
å¤åˆ¶ä»£ç 
```

## ä½¿ç”¨ qiankun initGlobalState

-   ä¸»åº”ç”¨

```
// src/const/micro/actions.js
import { initGlobalState } from 'qiankun'

export const initialState = {}

const actions = initGlobalState(initialState)

export default actions
å¤åˆ¶ä»£ç 
```

-   ä¸»åº”ç”¨ä½¿ç”¨

```
import actions from '@/const/micro/actions'

// è®¾ç½®
actions.setGlobalState({
   xxxxDataKey: xxxValue
})

// ç›‘å¬å…¨å±€
actions.onGlobalStateChange((state, prev) => {
  console.log(state, prev, 'å­åº”ç”¨çš„ state: å˜æ›´åçš„çŠ¶æ€; prev å˜æ›´å‰çš„çŠ¶æ€')
})
å¤åˆ¶ä»£ç 
```

-   å¾®åº”ç”¨

```
// src/const/micro/actions.js å°è£…ä¸€ä¸‹åˆ°æ—¶å€™å¼•å…¥ä½¿ç”¨æ–¹ä¾¿
function emptyAction() {
    // è­¦å‘Šï¼šæç¤ºå½“å‰ä½¿ç”¨çš„æ˜¯ç©º Action
    console.warn('Current execute action is empty!')
}

class Actions {
    // é»˜è®¤å€¼ä¸ºç©º Action
    actions = {
        onGlobalStateChange: emptyAction,
        setGlobalState: emptyAction
    }

    // è®¾ç½® actions
    setActions(actions) {
        this.actions = actions
    }

    // æ˜ å°„ç›‘å¬
    onGlobalStateChange(...args) {
        return this.actions.onGlobalStateChange(...args)
    }

    // æ˜ å°„è®¾ç½®
    setGlobalState(...args) {
        return this.actions.setGlobalState(...args)
    }
}

const actions = new Actions()
export default actions
å¤åˆ¶ä»£ç 
```

-   å¾®åº”ç”¨ä½¿ç”¨

```
import actions from './const/micro/actions'

export async function mount(props) {
    actions.setActions(props) // è®¾ç½®ä¸€ä¸‹ actions å¯¹è±¡
}

actions.onGlobalStateChange((state, prev) => {
  // ç›‘å¬å…¬å…±åº”ç”¨ä¸‹å‘ state: å˜æ›´åçš„çŠ¶æ€; prev å˜æ›´å‰çš„çŠ¶æ€
})
å¤åˆ¶ä»£ç 
```

## çŠ¶æ€ç®¡ç†æ¨¡å¼

-   åŸºäºçˆ¶åº”ç”¨çš„ vuex store ä¼ ç»™å­åº”ç”¨

```
// åœ¨å¾®åº”ç”¨ props å±æ€§ åŠ¨æ€ä¸‹å‘é…ç½®ã€‚
import store from '@/store/index'

currentApp.props = {
    ...currentActiveMicroConfig.props,
    store: store // ä¸‹å‘ä¸»åº”ç”¨çš„ store
}

loadMicroApp(currentApp)
å¤åˆ¶ä»£ç 
```

-   å­åº”ç”¨æ¥å—å¹¶ä½¿ç”¨

```
// å¾®åº”ç”¨ mount ä¸­æ¥æ”¶
export async function mount(props) {
    render(props)
}

// åŠ¨æ€æŒ‚è½½ é€šè¿‡ this.$root.xxx ä½¿ç”¨dataçš„æ•°æ®
function render(props = {}) {
    const { container, store } = props
    instance = new Vue({
        childStore,
        data() {
            return {
                parentVuex: store, // çˆ¶åº”ç”¨ vuex
            }
        },
        render: h => h(App)
    }).$mount(container ? container.querySelector('#you-micro') : '#you-micro')
}
å¤åˆ¶ä»£ç 
```

-   ä½¿ç”¨

```
this.$root.parentVuex.state.xxxx // è¯»

this.$root.parentVuex.commit('xxxx', {}) // å†™
å¤åˆ¶ä»£ç 
```

## åä¸ƒã€å¾®åº”ç”¨å†…å­˜æº¢å‡ºæ€è€ƒ

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/04c4660230c2422c8646dc9aca305740~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

-   qiankun ä¼šå°†å¾®åº”ç”¨çš„ JS/CSS å†…å®¹éƒ½è®°å½•åœ¨å…¨å±€å˜é‡ä¸­ï¼Œå¦‚æœä¸€ç›´é‡å¤çš„æŒ‚è½½åº”ç”¨æ²¡æœ‰å¸è½½ï¼Œä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡å¤šï¼Œå¯¼è‡´é¡µé¢å¡é¡¿
-   è™½ç„¶å®˜æ–¹æ²¡æœ‰æ˜ç¡®è¯´åå†…å­˜çš„æº¢å‡ºé—®é¢˜ï¼Œä½†æ˜¯ç¬”è€…åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨é‡å¤åŠ è½½åº”ç”¨çš„æ—¶å€™å´©æºƒè¿‡å‡ æ¬¡ï¼Œå‡ºäºå®‰å…¨æ€§æ€è€ƒè¿˜æ˜¯ä½¿ç”¨ä¸€äº›æ‰‹æ®µæ¥çº¦æŸå˜é‡çš„å¼€é”€å§ï½
    1.  å¾®åº”ç”¨å¸è½½çš„æ—¶å€™æ¸…ç©ºå¾®åº”ç”¨æ³¨å†Œçš„é™„åŠ å†…å®¹åŠ DOM å…ƒç´ ç­‰
    2.  è®¾ç½®è‡ªåŠ¨é”€æ¯æ—¶é—´ï¼Œå»é”€æ¯é‚£äº›é•¿æ—¶é—´æŒ‚è½½çš„åº”ç”¨ï¼Œ
    3.  è®¾ç½®æœ€å¤§è¿è¡Œåº”ç”¨æ•°é‡ï¼Œè¶…è¿‡è§„å®šçš„æ•°é‡çš„æ—¶å€™å§ç¬¬ä¸€ä¸ªåº”ç”¨é”€æ¯

**1\. å¸è½½æ—¶æ¸…ç©ºæ— ç”¨å®ä¾‹**

```
export async function unmount() { 
    instance.$destroy() 
    instance.$el.innerHTML = '' // å…³é”®
    instance = null 
    route = null
    // ... more
}
å¤åˆ¶ä»£ç 
```

**2\. è®¾ç½®è¿‡æœŸæ—¶é—´ä¸æœ€å¤§è¿è¡Œæ•°ï¼Œè¿™é‡Œçš„çš„å†…å®¹å¯ä»¥ç»“åˆä¸Šé¢çš„å†…å®¹æ¥çœ‹ï¼Œä¸Šæ–‡æœ‰å¯¹åº”çš„è¯´æ˜**

```
// src/const/micro/index.js
export const MAX_RUN_MICRO_NUMBER = 5 // æœ€å¤§è¿è¡Œå¾®åº”ç”¨æ•°é‡
å¤åˆ¶ä»£ç 
```

```
// ä¸»åº”ç”¨/src/const/micro/application-list.js

export default [{
    name: 'you-app-name', // åº”ç”¨çš„åå­—
    // ... micro app config
    // è‡ªåŠ¨é”€æ¯æ—¶é—´ å•ä½ï¼š3000ï¼ˆmsï¼‰ or (Infinity = æ°¸ä¹…ä¸ä¼šé”€æ¯ï¼‰
    unmountTime: '300000'
}]
å¤åˆ¶ä»£ç 
```

**æ³¨å†Œçš„æ—¶å€™è®°å½•æ—¶é—´**

```
// src/const/micro/qianun-utils.js
// æ³¨å†Œåº”ç”¨çš„æ–¹æ³•
export function loadRouterMicroApp(currentApp) {
    // 1. è¿”å›æ³¨å†Œåº”ç”¨å¯¹è±¡
    const micro = loadMicroApp(currentApp)
    // 2. å¾®åº”ç”¨æŒ‚è½½å®Œæˆ
    micro.mountPromise.then(() => {
        // 3. åœ¨åº”ç”¨å¯¹è±¡ï¼Œå¢åŠ å¼€å§‹æ—¶é—´å­—æ®µï¼Œè®°å½•å¾®åº”ç”¨æŒ‚è½½æ—¶é—´
        micro.createTime = new Date().getTime()
        // 4. åœ¨åº”ç”¨å¯¹è±¡ï¼Œå¢åŠ å¸è½½æ—¶é—´å­—æ®µ è®°å½•åº”ç”¨å¸è½½æ—¶é—´ï¼Œå¦‚æœæ—¶é—´æ˜¯ç©ºé»˜è®¤ æ°¸ä¸é”€æ¯
        micro.unmountTime = currentApp.unmountTime || 'Infinity'
        // 5. è®¾ç½®å½“å‰åº”ç”¨åˆ—è¡¨, è®°å½•æŒ‚è½½åº”ç”¨æŒ‚è½½ä¿¡æ¯ï¼ŒåæœŸè·¯ç”±ä¼šåŒ¹é…æ˜¯å¦æ˜¯å¦éœ€è¦å¸è½½
        store.dispatch('d2admin/micro/SET_MICRO_APPLICATION_LIST', {
            key: currentApp.activeRule,
            value: micro
        })
    })
}
å¤åˆ¶ä»£ç 
```

**è·¯ç”±å®ˆå«çš„æ—¶å€™åˆ¤æ–­æ˜¯å¦éœ€è¦å¸è½½**

```
router.afterEach(to => {
    microApplicationLoading(to.path)
})
å¤åˆ¶ä»£ç 
```

```
// ä¸»åº”ç”¨/src/const/micro/qianun-utils.js

// åŠ è½½å¾®åº”ç”¨æ–¹æ³•
export async function microApplicationLoading(path) {
    // 1. æ ¹æ®è·¯ç”±åœ°å€åŠ è½½å½“å‰åº”ç”¨é…ç½®
    let currentActiveMicroConfig = await store.dispatch('d2admin/micro/GET_FIND_MICRO_CONFIG', path)

    // 2. è·å–å¾®åº”ç”¨åˆ—è¡¨
    const microApplicationList = store.getters['d2admin/micro/microApplicationList']

    // 3. åˆ¤æ–­åº”ç”¨è¿è¡Œæ—¶é—´é”€æ¯åº”ç”¨
    store.dispatch('d2admin/micro/CHECK_UNMOUNT_MICRO', { microApplicationList, currentActiveMicroConfig })

    // ... code åé¢æ³¨å†Œåˆ¤æ–­æ“ä½œå°±çœç•¥äº†
}

å¤åˆ¶ä»£ç 
```

åˆ¤æ–­æ˜¯å¦æœ€å¤§å †æ ˆã€åˆ¤æ–­æ˜¯å¦è¶…æ—¶é”€æ¯

```
// ä¸»åº”ç”¨/src/store/modules/d2admin/modules/micro.js

export default {
    state: {
        microApplicationList: new Map([]),
    },
    actions: {
        // æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦éœ€è¦å¸è½½å¾®åº”ç”¨ ä¾æ®æ—¶é—´æ¥åˆ¤æ–­ microApplicationListï¼šç¼“å­˜å¾®åº”ç”¨åˆ—è¡¨ï¼ŒcurrentActiveMicroConfigï¼šå½“å‰URLåŒ¹é…çš„å¾®åº”ç”¨é…ç½®
        CHECK_UNMOUNT_MICRO({ state, dispatch }, { microApplicationList, currentActiveMicroConfig }) {
            // 1. åˆ¤æ–­æ—¶å€™æœ‰ç¼“å­˜åˆ—è¡¨
            if (!microApplicationList.size) {
                return
            }
            
            // 2. è·å–å½“å‰æ—¶é—´
            const currentTime = new Date().getTime()

            // 3. éå†ç¼“å­˜åº”ç”¨åˆ—è¡¨ï¼Œåˆ¤æ–­åº”ç”¨æ˜¯å¦éœ€è¦é”€æ¯äº†ï½
            Array.from(microApplicationList).forEach(([key, item]) => {
                // 4. è·å–åº”ç”¨è¿è¡Œæ—¶é—´
                const runningTime = currentTime - item.createTime
                // 5. è·å–åº”ç”¨å¸è½½æ—¶é—´
                const unmountTime = item.unmountTime

                // 6. å¦‚æœæœ‰å¾®åº”ç”¨é…ç½®ï¼Œè¿™è¯´æ˜è·³è½¬å°±æ˜¯å·²ç»æŒ‚è½½è¿‡çš„å¾®åº”ç”¨äº†ï¼Œåˆ·æ–°åº”ç”¨æ—¶é—´ä¸å–æ¶ˆåº”ç”¨é”€æ¯ï¼ˆç»­è´¹ä¸€ä¸‹ï¼Œé¿å…é”€æ¯æœ‰æ¿€æ´»é‡å¤å¼€é”€ï¼‰
                if (currentActiveMicroConfig) {
                    item.createTime = new Date().getTime()
                    // ï¼ï¼ï¼è®¾ç½®ä¸€ä¸‹å½“å‰ç¼“å­˜åº”ç”¨åˆ—è¡¨ï¼Œæ›´æ–°åº”ç”¨æ—¶é—´ï¼Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§å †æ ˆï¼Œæ˜¯å¦éœ€è¦æ¸…é™¤åº”ç”¨ï¼ï¼ï¼
                    dispatch('SET_MICRO_APPLICATION_LIST', {
                        key: item.activeRule,
                        value: item
                    })
                    return
                }
                
                // 7. å¦‚æœè¿è¡Œæ—¶å¤§äºé”€æ¯æ—¶é—´åˆ™é”€æ¯å¯¹åº”åº”ç”¨ï¼Œå¹¶ä¸”ä¸æ˜¯ Infinity å…³é”®å­—
                if (runningTime >= unmountTime && unmountTime !== 'Infinity') {
                    dispatch('DELETE_MICRO_APPLICATION_LIST', key)
                }
            })
        },
        
        // åˆ é™¤å¾®åº”ç”¨ç¨‹åºåˆ—è¡¨
        DELETE_MICRO_APPLICATION_LIST({ state }, key) {
            const micro = state.microApplicationList.get(key)
            micro && micro.unmount()
            state.microApplicationList.delete(key)
        },
        
        // è®¾ç½®å¾®åº”ç”¨ç¨‹åºåˆ—è¡¨
        SET_MICRO_APPLICATION_LIST({ state, dispatch }, { key, value }) {
            // åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§å †æ ˆï¼Œæ¸…é™¤åº”ç”¨
            dispatch('CLEAR_MICRO_STACK')
            state.microApplicationList.set(key, value)
        },
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç©ºå †æ ˆ
        CLEAR_MICRO_STACK({ state, dispatch }) {
            // åˆ¤æ–­æ˜¯å¦æ˜¯ Infinity æ— å †æ ˆé™åˆ¶
            if (MAX_RUN_MICRO_NUMBER === 'Infinity') {
                return
            }

            // åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§å †æ ˆ
            if (state.microApplicationList.size < MAX_RUN_MICRO_NUMBER) {
                return
            }

            // è·å–MAPçš„ç¬¬ä¸€ä¸ªåº”ç”¨é”€æ¯å¹¶åˆ é™¤vuexä¿¡æ¯
            const key = state.microApplicationList.keys().next().value
            dispatch('DELETE_MICRO_APPLICATION_LIST', key)
        }
    }
}
å¤åˆ¶ä»£ç 
```

## åå…«ã€åŒä¸€è·¯ç”±å¤šåº”ç”¨å…±å­˜

-   å¦‚æœä¸€ä¸ªé¡µé¢åŒæ—¶å±•ç¤ºå¤šä¸ªå¾®åº”ç”¨ï¼Œéœ€è¦ä½¿ç”¨Â `loadMicroApp`Â æ¥åŠ è½½ã€‚
-   å¦‚æœè¿™äº›å¾®åº”ç”¨éƒ½æœ‰è·¯ç”±è·³è½¬çš„éœ€æ±‚ï¼Œè¦ä¿è¯è¿™äº›è·¯ç”±èƒ½äº’ä¸å¹²æ‰°ï¼Œéœ€è¦ä½¿ç”¨Â `momery`Â è·¯ç”±ã€‚
-   `vue-router`Â ä½¿ç”¨Â `abstract`Â æ¨¡å¼ï¼Œ`react-router`Â ä½¿ç”¨Â `memory history`Â æ¨¡å¼ï¼Œ`angular-router`Â ä¸æ”¯æŒã€‚
-   Vue Router çš„å¯¼èˆªæ–¹æ³• (`push`ã€Â `replace`ã€Â `go`) åœ¨å„ç±»è·¯ç”±æ¨¡å¼(`history`ã€Â `hash`Â å’ŒÂ `abstract`) ä¸‹è¡¨ç°ä¸€è‡´ã€‚
-   `abstract` æ˜¯vueè·¯ç”±ä¸­çš„ç¬¬ä¸‰ç§æ¨¡å¼ï¼Œæœ¬èº«æ˜¯ç”¨æ¥åœ¨ä¸æ”¯æŒæµè§ˆå™¨APIçš„ç¯å¢ƒä¸­ï¼Œå……å½“fallbackï¼Œæ— è®º hashè¿˜æ˜¯historyæ¨¡å¼éƒ½ä¼šå¯¹æµè§ˆå™¨ä¸Šçš„urläº§ç”Ÿä½œç”¨ï¼Œäºæ˜¯æˆ‘ä»¬åˆ©ç”¨åˆ°äº†abstractè¿™ç§ä¸æµè§ˆå™¨åˆ†ç¦»çš„è·¯ç”±æ¨¡å¼è§£å†³å¤šåº”ç”¨è·¯ç”±å†²çªçš„é—®é¢˜ã€‚

```
function render({ data = {} , container, defaultPath } = {}) {
    router = new VueRouter({
        mode: 'abstract', // ä¸ä¼šè¢«URLæ‰€å½±å“
        routes
    })

    instance = new Vue({
        router,
        store,
        render: h => h(App)
    }).$mount(container ? container.querySelector('#appVueHash') : '#appVueHash')

    if (defaultPath) {
        router.push(defaultPath)
    }
}
å¤åˆ¶ä»£ç 
```

## åä¹ã€å¾®åº”ç”¨å¼€å‘ä¸éƒ¨ç½²

## å¼€å‘ä¸éƒ¨ç½²ç›®å½•å»ºè®®

> å»ºè®®åœ¨å¼€å‘ä¸éƒ¨ç½²çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å¾®åº”ç”¨éƒ½æ”¾åœ¨ä¸€ä¸ªç›®å½•ï¼Œè™½ç„¶qiankunçš„åº”ç”¨åªéœ€æä¾›å¾®åº”ç”¨URLåœ°å€å³å¯ï¼Œä»ç†è®ºä¸Šæ¥è¯´é¡¹ç›®æ”¾åœ¨é‚£é‡Œéƒ½æ˜¯æ²¡æœ‰å½±å“çš„ã€‚ä½†æ˜¯å‡ºäºç®¡ç†ç»´æŠ¤çš„ç›®çš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¨èï¼š

-   ç›¸å…³åº”ç”¨éƒ½åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œç»Ÿä¸€ç®¡ç†
-   æ‰€æœ‰å¾®åº”ç”¨éƒ½æ˜¯ç‹¬ç«‹é¡¹ç›®ã€ç‹¬ç«‹ä»“åº“ã€ç‹¬ç«‹éƒ¨ç½²

```
â””â”€â”€ micro-app-container Â  Â  Â  # æ ¹æ–‡ä»¶å¤¹
    â”œâ”€â”€ main/ Â  Â  Â  Â  Â  Â  Â  Â  # åŸºåº§åº”ç”¨/ä¸»åº”ç”¨
 Â   â”œâ”€â”€ child/ Â  Â  Â  Â  Â  Â  Â  Â # å­˜æ”¾æ‰€æœ‰å¾®åº”ç”¨çš„æ–‡ä»¶å¤¹
 Â   | Â  â”œâ”€â”€ vue-hash/ Â  Â  Â  Â  # å­˜æ”¾å¾®åº”ç”¨ vue-hash çš„æ–‡ä»¶å¤¹
 Â   | Â  â”œâ”€â”€ vue-history/ Â  Â  Â # å­˜æ”¾å¾®åº”ç”¨ vue-history çš„æ–‡ä»¶å¤¹
 Â   â”œâ”€â”€ package.json Â  Â  Â  Â  Â # å…¬å…±æ–‡ä»¶çš„ index.html æ‰§è¡Œå‘½ä»¤
 Â   â”œâ”€â”€ node_modules/ Â  Â  Â  Â  # å…¬å…±æ–‡ä»¶ä¾èµ–
å¤åˆ¶ä»£ç 
```

## ä½¿ç”¨[npm-run-all ç®€åŒ–scripté…ç½®](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fmysticatea%2Fnpm-run-all "https://github.com/mysticatea/npm-run-all")

æ ¹æ®ä¸Šé¢çš„ç»“æ„ä¸€ä¸ªä¸€ä¸ª å¯åŠ¨oræ‰“åŒ…åº”ç”¨å¤ªéº»çƒ¦äº†ï¼Œä½¿ç”¨npm-run-all å‘½ä»¤ **è§£å†³npm run** **å‘½ä»¤æ— æ³•åŒæ—¶è¿è¡Œå¤šä¸ªè„šæœ¬çš„é—®é¢˜**

npm-run-allçš„ä¸‰ä¸ªç‰¹ç‚¹ï¼š

-   é¡ºåºæ‰§è¡Œ ã€å¹¶è¡Œæ‰§è¡Œã€æ··åˆæ‰§è¡Œ
-   `--parallel`: å¹¶è¡Œè¿è¡Œå¤šä¸ªå‘½ä»¤ï¼Œä¾‹å¦‚ï¼šnpm-run-all --parallel lint build
-   `--serial`: å¤šä¸ªå‘½ä»¤æŒ‰æ’åˆ—é¡ºåºæ‰§è¡Œï¼Œä¾‹å¦‚ï¼šnpm-run-all --serial clean lint build:
-   `--continue-on-error`: æ˜¯å¦å¿½ç•¥é”™è¯¯ï¼Œæ·»åŠ æ­¤å‚æ•° npm-run-all ä¼šè‡ªåŠ¨é€€å‡ºå‡ºé”™çš„å‘½ä»¤ï¼Œç»§ç»­è¿è¡Œæ­£å¸¸çš„
-   `--race`: æ·»åŠ æ­¤å‚æ•°ä¹‹åï¼Œåªè¦æœ‰ä¸€ä¸ªå‘½ä»¤è¿è¡Œå‡ºé”™ï¼Œé‚£ä¹ˆ npm-run-all å°±ä¼šç»“æŸæ‰å…¨éƒ¨çš„å‘½ä»¤

å®‰è£…ä¾èµ–

```
npm install npm-run-all --save-dev
// or
yarn add npm-run-all --dev
å¤åˆ¶ä»£ç 
```

é…ç½®å‘½ä»¤ package.json, ä¸€é”®ç»™æ‰€æœ‰åº”ç”¨å®‰è£…ä¾èµ–

```
// æ‰§è¡Œ install: çš„å‘½ä»¤ï½ å¯ä»¥æ‰¹é‡æ‰§è¡Œç›¸åŒå‘½ä»¤çš„å‰ç¼€ï¼Œå¯ä»¥å¼‚æ­¥ã€åŒæ­¥æ‰§è¡Œå‘½ä»¤
// ä¾‹å¦‚ï¼š npm run install-all å°±ç»™æ‰€æœ‰é¡¹ç›®å®‰è£…ä¾èµ–
"scripts": {
    "install:child-hash": "cd child/child-hash && yarn",
    "install:child-history": "cd child/child-history && yarn",
    "install:main": "cd main && yarn",
    "install-all": "npm-run-all install:*", // å…¨å±€å®‰è£…ä¾èµ–

    "start:child-hash": "cd child/child-hash && npm run serve",
    "start:child-history": "cd child/child-history && npm run serve",
    "start:main": "cd main && npm run serve",
    "serve-all": "npm-run-all --parallel start:*", // å…¨å±€å¯åŠ¨

    "build:child-hash": "cd child/child-hash && npm run build",
    "build:child-history": "cd child/child-history && npm run build",
    "build:main": "cd main && npm run build",
    "build-all": "npm-run-all --parallel build:*" // å…¨å±€æ‰“åŒ…
}
å¤åˆ¶ä»£ç 
```

**æˆ–è€…é…åˆè„šæœ¬å¯ä»¥è‡ªå·±å†™ä¸€å†™ç®€å•çš„ shell è„šæœ¬**

```
# script/clone-all.sh
# ç›¸å…³é¡¹ç›®åœ°å€

# xxx é¡¹ç›®
git clone http:/xxxxxxx.git

# xxx é¡¹ç›®
git clone http://xxxxxxxx.git
å¤åˆ¶ä»£ç 
```

**package.json ä¸­å¢åŠ å‘½ä»¤æ‰§è¡Œ**

```
"clone:all": "bash ./scripts/clone-all.sh" // npm run clone:all ä¾¿å¯ä»¥æ‰¹é‡å…‹éš†é¡¹ç›®äº† 
å¤åˆ¶ä»£ç 
```

**éƒ¨ç½²çš„æ—¶å€™ä¹Ÿå’Œå¼€å‘çš„æ—¶å€™ä¸€æ ·ï¼Œä¸è¿‡å¯ä»¥ç›´æ¥æ”¾åœ¨åŸºåº§åº”ç”¨é‡Œé¢ä½¿ç”¨**

```
â””â”€â”€ html/ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # æ ¹æ–‡ä»¶å¤¹
 Â   |
 Â   â”œâ”€â”€ child/ Â  Â  Â  Â  Â  Â  Â   # å­˜æ”¾æ‰€æœ‰å¾®åº”ç”¨çš„æ–‡ä»¶å¤¹
 Â   | Â  â”œâ”€â”€ vue-hash/ Â  Â  Â  Â  # å­˜æ”¾å¾®åº”ç”¨ vue-hash çš„æ–‡ä»¶å¤¹
 Â   | Â  â”œâ”€â”€ vue-history/ Â  Â   # å­˜æ”¾å¾®åº”ç”¨ vue-history çš„æ–‡ä»¶å¤¹
 Â   â”œâ”€â”€ index.html Â  Â  Â  Â  Â   # ä¸»åº”ç”¨çš„index.html
 Â   â”œâ”€â”€ css/ Â  Â  Â  Â  Â  Â  Â  Â   # ä¸»åº”ç”¨çš„cssæ–‡ä»¶å¤¹
 Â   â”œâ”€â”€ js/ Â  Â  Â  Â  Â  Â  Â  Â  Â  # ä¸»åº”ç”¨çš„jsæ–‡ä»¶å¤¹
å¤åˆ¶ä»£ç 
```

**æ­¤æ—¶éœ€è¦è®¾ç½®å¾®åº”ç”¨æ„å»ºæ—¶çš„ `publicPath` å’Œ `history` æ¨¡å¼çš„è·¯ç”± `base`ï¼Œç„¶åæ‰èƒ½æ‰“åŒ…æ”¾åˆ°å¯¹åº”çš„ç›®å½•é‡Œã€‚æ„å»ºçš„æ—¶å€™åˆ‡è®°è¦ä¿®æ”¹ webpack ä¸­çš„ publicPath åœ°å€ï¼ï¼ï¼**

| é¡¹ç›® | è·¯ç”± base | publicPath | çœŸå®è®¿é—®è·¯å¾„ |
| --- | --- | --- | --- |
| vue-hash | æ—  | /child/vue-hash/ | [http://localhost:8080/child/vue-hash/](https://link.juejin.cn/?target=http%3A%2F%2Flocalhost%3A8080%2Fchild%2Fvue-hash%2F "http://localhost:8080/child/vue-hash/") |
| vue-history | /child/vue-history/ | /child/vue-history/ | [http://localhost:8080/child/vue-history/](https://link.juejin.cn/?target=http%3A%2F%2Flocalhost%3A8080%2Fchild%2Fvue-history%2F "http://localhost:8080/child/vue-history/") |

-   vue-history å¾®åº”ç”¨
    
    1.  å¾®åº”ç”¨è·¯ç”±è®¾ç½®ï¼š
    
    ```
    base: window.__POWERED_BY_QIANKUN__ ? '/app-vue-history/' : '/child/vue-history/',
    å¤åˆ¶ä»£ç 
    ```
    
    2.  å¾®åº”ç”¨ webpack æ‰“åŒ… publicPath é…ç½®ï¼ˆ`vue.config.js`ï¼‰ï¼š
    
    ```
    module.exports = {
     Â publicPath: '/child/vue-history/',
    };
    å¤åˆ¶ä»£ç 
    ```
    
    3.  åŒæ—¶ä¸»åº”ç”¨çš„é…ç½®æ–‡ä»¶ entry å…¥å£ä¹Ÿè¦å’Œå½“å‰ç¯å¢ƒä¸€æ ·éœ€è¦åŠ¨æ€æ›´æ”¹
-   ä½†æ˜¯ç¬”è€…è§‰å¾—è¿™æ ·å†™çœŸçš„ä¸ä¼˜é›…ï¼Œç¬”è€…å¸Œæœ›æœ‰å…³äºå¾®å‰ç«¯çš„æ‰€æœ‰é…ç½®éƒ½åœ¨ä¸€ä¸ªå¾®å‰ç«¯é…ç½®é¡µé‡Œé¢ç»´æŠ¤ï¼Œå¹¶ä¸”æ¸…æ™°å¯è§ã€‚
    
-   æ‰€ä»¥ç¬”è€…çš„åšæ³•æ˜¯æ–¹æ³•åˆ¤æ–­ç¯å¢ƒä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå‡å°‘ä¸‰å…ƒçš„ä¸‘é™‹ä¸æ··ä¹±ï¼ŒæŠŠè·¯ç”±å‰ç¼€åŠ¨æ€çš„ä¸‹å‘ç»™å¾®åº”ç”¨ï¼Œä½†å¾®åº”ç”¨æ³¨å†Œçš„æ—¶å€™ï¼Œåœ¨åŠ¨æ€æŠŠå‰ç¼€åŠ ä¸Š
    

```
// ä¸»åº”ç”¨ src/const/micro/application-list.js
// è·å–ä¸åŒç¯å¢ƒçš„å…¥å£
function getEentry({ prodPath, devPath }) {
 Â  Â const isProduction = process.env.NODE_ENV === 'production'
 Â  Â return isProduction ? prodPath : devPath
}

// æ³¨å†Œå¾®åº”ç”¨åˆ—è¡¨
export default [
    {
        name: 'your-name', // åº”ç”¨çš„åå­—
        // é»˜è®¤ä¼šåŠ è½½è¿™ä¸ªhtml è§£æé‡Œé¢çš„js åŠ¨æ€çš„æ‰§è¡Œ ï¼ˆå­åº”ç”¨å¿…é¡»æ”¯æŒè·¨åŸŸï¼‰fetch
        entry: getEentry({
            devPath: '//localhost:7286/', // å¼€å‘ç¯å¢ƒåœ°å€
            prodPath: `/child/your-name/` // ç”Ÿäº§ç¯å¢ƒåœ°å€
        }),
        props: { // ä¸‹å‘å¾®åº”ç”¨çš„å…¥å£
            routeBase: '/app-vue-history/', // åŠ¨æ€ä¸‹å‘è·¯ç”±å‰ç¼€
        }
    }
]
å¤åˆ¶ä»£ç 
```

## æ€»ç»“

-   æ„Ÿè°¢å„ä½èƒ½çœ‹åˆ°è¿™é‡Œï¼Œè¿™æ˜¯ç¬”è€…åœ¨å¾®å‰ç«¯å®è·µçš„ä¸€äº›å¿ƒå¾—ï¼Œç¢äºç¯‡å¹…åŸå› ï¼Œå¾ˆå¤šæŠ€æœ¯ç»†èŠ‚æˆ‘ä»¬å°±ä¸å†æ–‡ä¸­èµ˜è¿°äº†ï¼Œå¦‚æœæœ‰å¸Œæœ›äº†è§£æ›´å¤š qiankun åŸç†ï¼Œæˆ–è€…æ›´å¤šå®è·µç»†èŠ‚çš„å°ä¼™ä¼´ï¼Œå¯ä»¥åœ¨æ–‡ç« åº•éƒ¨ç•™è¨€ï¼Œåœ¨**æ­¤å¾ˆæ„Ÿè°¢èƒ½ç»™äºˆæˆ‘å®è·µæœºä¼šçš„å½¬å“¥ä¸æ ‡å“¥**ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½åœ¨æ‚¨å¾®å‰ç«¯çš„æ¢ç´¢ä¹‹è·¯ä¸ºæ‚¨ç…§äº®å‰æ–¹ï¼Œæ„Ÿè°¢æ”¯æŒï¼Œæœ¬æ–‡å¦‚æœæœ‰ç¬”è¯¯çš„çš„åœ°æ–¹ï¼Œæ¬¢è¿æå‡ºï¼Œå®šä¼šåŠæ—¶ä¿®å¤ä¸æ”¹è¿›ï¼Œæ„¿å›ä»£ç è·¯ä¸Šä¸€è·¯ç•…é€šæ— é˜»ï½