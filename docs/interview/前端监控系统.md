## å‰ç«¯ç›‘æ§ç›®æ ‡

### ç¨³å®šæ€§

![image-20220905211245905](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/imgsimage-20220905211245905.png)

### ç”¨æˆ·ä½“éªŒ

| é”™è¯¯åç§°                                    | å¤‡æ³¨                                                         |
| ------------------------------------------- | ------------------------------------------------------------ |
| åŠ è½½æ—¶é—´                                    | å„ä¸ªé˜¶æ®µçš„åŠ è½½æ—¶é—´                                           |
| TTFB(time to first byte)(é¦–å­—èŠ‚æ—¶é—´)        | æ˜¯æŒ‡æµè§ˆå™¨å‘èµ·ç¬¬ä¸€ä¸ªè¯·æ±‚åˆ°æ•°æ®è¿”å›ç¬¬ä¸€ä¸ªå­—èŠ‚æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´åŒ…å«äº†ç½‘ç»œè¯·æ±‚æ—¶é—´ã€åç«¯å¤„ç†æ—¶é—´ |
| FP(First Paint)(é¦–æ¬¡ç»˜åˆ¶)                   | é¦–æ¬¡ç»˜åˆ¶åŒ…æ‹¬äº†ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰çš„èƒŒæ™¯ç»˜åˆ¶ï¼Œå®ƒæ˜¯å°†ç¬¬ä¸€ä¸ªåƒç´ ç‚¹ç»˜åˆ¶åˆ°å±å¹•çš„æ—¶åˆ» |
| FCP(First Content Paint)(é¦–æ¬¡å†…å®¹ç»˜åˆ¶)      | é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ˜¯æµè§ˆå™¨å°†ç¬¬ä¸€ä¸ªDOMæ¸²æŸ“åˆ°å±å¹•çš„æ—¶é—´,å¯ä»¥æ˜¯ä»»ä½•æ–‡æœ¬ã€å›¾åƒã€SVGç­‰çš„æ—¶é—´ |
| FMP(First Meaningful paint)(é¦–æ¬¡æœ‰æ„ä¹‰ç»˜åˆ¶) | FMP(First Meaningful paint)(é¦–æ¬¡æœ‰æ„ä¹‰ç»˜åˆ¶)                  |
| FID(First Input Delay)(é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ)        | ç”¨æˆ·é¦–æ¬¡å’Œé¡µé¢äº¤äº’åˆ°é¡µé¢å“åº”äº¤äº’çš„æ—¶é—´                       |
| å¡é¡¿                                        | è¶…è¿‡50msçš„é•¿ä»»åŠ¡                                             |

### ä¸šåŠ¡

![image-20220905212304088](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/imgsimage-20220905212304088.png)

## å‰ç«¯ç›‘æ§æµç¨‹



![image-20220905212737893](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/imgsimage-20220905212737893.png)

çœ‹æŠ¥è¡¨ï¼Œè®¾ç½®é˜ˆå€¼è¿›è¡ŒæŠ¥è­¦ï¼ˆpvå¢é•¿è¿‡å¿«ï¼Œç™½å±æ¬¡æ•°è¿‡å¤šï¼‰

### å¸¸è§åŸ‹ç‚¹æ–¹æ¡ˆ

#### ä»£ç åŸ‹ç‚¹

- ä»£ç åŸ‹ç‚¹ï¼Œå°±æ˜¯ä»¥åµŒå…¥ä»£ç çš„å½¢å¼è¿›è¡ŒåŸ‹ç‚¹æ¯”å¦‚éœ€è¦ç›‘æ§ç”¨æˆ·çš„ç‚¹å‡»äº‹ä»¶,ä¼šé€‰æ‹©åœ¨ç”¨æˆ·ç‚¹å‡»æ—¶,æ’å…¥ä¸€æ®µä»£ç ï¼Œä¿å­˜è¿™ä¸ªç›‘å¬è¡Œä¸ºæˆ–è€…ç›´æ¥å°†ç›‘å¬è¡Œä¸ºä»¥æŸä¸€ç§æ•°æ˜æ ¼å¼ç›´æ¥ä¼ é€’ç»™æœåŠ¡å™¨ç«¯
- ä¼˜ç‚¹æ˜¯å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»ï¼Œç²¾ç¡®çš„å‘é€æˆ–ä¿å­˜æ‰€éœ€è¦çš„æ•°æ®ä¿¡æ¯ç¼ºç‚¹æ˜¯å·¥ä½œé‡è¾ƒå¤§
- ç¼ºç‚¹æ˜¯å·¥ä½œé‡è¾ƒå¤§

#### å¯è§†åŒ–åŸ‹ç‚¹

- é€šè¿‡å¯è§†åŒ–äº¤äº’çš„æ‰‹æ®µï¼Œä»£æ›¿ä»£ç åŸ‹ç‚¹
- å°†ä¸šåŠ¡ä»£ç å’ŒåŸ‹ç‚¹ä»£ç åˆ†ç¦»ï¼Œæä¾›ä¸€ä¸ªå¯è§†åŒ–äº¤äº’çš„é¡µé¢ï¼Œè¾“å…¥ä¸ºä¸šåŠ¡ä»£ç ï¼Œé€šè¿‡è¿™ä¸ªå¯è§†åŒ–ç³»ç»Ÿï¼Œå¯ä»¥åœ¨ä¸šåŠ¡ä»£ç ä¸­è‡ªå®šä¹‰çš„å¢åŠ åŸ‹ç‚¹äº‹ä»¶ç­‰ç­‰,æœ€åè¾“å‡ºçš„ä»£ç è€¦åˆäº†ä¸šåŠ¡ä»£ç å’ŒåŸ‹ç‚¹ä»£ç 
- å¯è§†åŒ–åŸ‹ç‚¹å…¶å®æ˜¯ç”¨ç³»ç»Ÿæ¥ä»£æ›¿æ‰‹å·¥æ’å…¥åŸ‹ç‚¹ä»£ç 

#### æ— ç—•åŸ‹ç‚¹

- å‰ç«¯çš„ä»»æ„ä¸€ä¸ªäº‹ä»¶éƒ½è¢«ç»‘å®šä¸€ä¸ªæ ‡è¯†ï¼Œæ‰€æœ‰çš„äº‹ä»¶éƒ½åˆ«è®°å½•ä¸‹æ¥
- é€šè¿‡å®šæœŸä¸Šä¼ è®°å½•æ–‡ä»¶,é…åˆæ–‡ä»¶è§£æï¼Œè§£æå‡ºæ¥æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œå¹¶ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Šä¾›ä¸“ä¸šäººå‘˜åˆ†æ
- æ— ç—•åŸ‹ç‚¹çš„ä¼˜ç‚¹æ˜¯é‡‡é›†å…¨é‡æ•°æ®,ä¸ä¼šå‡ºç°æ¼åŸ‹å’Œè¯¯åŸ‹ç­‰ç°è±¡
- ç¼ºç‚¹æ˜¯ç»™æ•°æ®ä¼ è¾“å’ŒæœåŠ¡å™¨å¢åŠ å‹åŠ›ï¼Œä¹Ÿæ— æ³•çµæ´»å®šåˆ¶æ•°æ®ç»“æ„

## ç›‘æ§é‡‡é›†è„šæœ¬

### å¼€é€šæ—¥å¿—æœåŠ¡

æ—¥å¿—æœåŠ¡(Log Service,ç®€ç§°SLS)æ˜¯é’ˆå¯¹æ—¥å¿—ç±»æ•°æ®ä¸€ç«™å¼æœåŠ¡ï¼Œç”¨æˆ·æ— éœ€å¼€å‘å°±èƒ½å¿«æ·å®Œæˆæ•°æ®é‡‡é›†ã€æ¶ˆè´¹ã€æŠ•é€’ä»¥åŠæŸ¥è¯¢åˆ†æç­‰åŠŸèƒ½ï¼Œå¸®åŠ©æå‡è¿ç»´çš„æµ·é‡æ—¥å¿—å¤„ç†èƒ½åŠ›

### ç›‘æ§é”™è¯¯

#### é”™è¯¯åˆ†ç±»

jsé”™è¯¯ï¼šjsé”™è¯¯ï¼ŒPromiseå¼‚å¸¸

èµ„æºå¼‚å¸¸ï¼šç›‘å¬error

#### æ•°æ®ç»“æ„è®¾è®¡

##### 1.jsError

![image-20220908222433544](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/image-20220908222433544.png)

##### 2.promiseError

## **å‰ç«¯é”™è¯¯æ•è· & æµè§ˆå™¨ä¸ŠæŠ¥ API åŠæ—¶æœº**
åœ¨ä¸ä½¿ç”¨ç¬¬ä¸‰æ–¹ç›‘æ§å¹³å°ï¼ˆå¦‚ Sentryã€Fundebugï¼‰çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æµè§ˆå™¨è‡ªå¸¦çš„ API æ‰‹åŠ¨æ•è·é”™è¯¯ï¼Œå¹¶é€šè¿‡ **`navigator.sendBeacon`ã€`fetch` æˆ– `XMLHttpRequest`** è¿›è¡Œä¸ŠæŠ¥ã€‚

---

## **ğŸ“Œ 1. å‰ç«¯é”™è¯¯æ•è·æ–¹å¼**
### **1.1 åŒæ­¥ & è¿è¡Œæ—¶é”™è¯¯**
#### **ï¼ˆ1ï¼‰try-catch**
é€‚ç”¨äº **åŒæ­¥ä»£ç **ï¼Œä½†æ— æ³•æ•è· **å¼‚æ­¥é”™è¯¯**ã€‚

```js
try {
  let a = undefinedVariable;
} catch (error) {
  console.error("æ•è·åˆ°åŒæ­¥é”™è¯¯:", error);
  reportError(error);
}
```

#### **ï¼ˆ2ï¼‰window.onerror**
é€‚ç”¨äº **å…¨å±€è¿è¡Œæ—¶é”™è¯¯**ï¼ˆå¦‚ JS è¯­æ³•é”™è¯¯ã€è¿è¡Œæ—¶é”™è¯¯ï¼‰ã€‚

```js
window.onerror = function (message, source, lineno, colno, error) {
  console.error("å…¨å±€é”™è¯¯æ•è·:", { message, source, lineno, colno, error });
  reportError(error || { message, source, lineno, colno });
};
```

---

### **1.2 èµ„æºåŠ è½½é”™è¯¯**
å½“ **CSSã€å›¾ç‰‡ã€è„šæœ¬ç­‰èµ„æºåŠ è½½å¤±è´¥** æ—¶ï¼Œå¯ä»¥ç›‘å¬ `error` äº‹ä»¶ï¼š

```js
window.addEventListener("error", (event) => {
  if (event.target instanceof HTMLScriptElement || event.target instanceof HTMLLinkElement || event.target instanceof HTMLImageElement) {
    console.error("èµ„æºåŠ è½½å¤±è´¥:", event.target.src || event.target.href);
    reportError({ message: "èµ„æºåŠ è½½å¤±è´¥", src: event.target.src || event.target.href });
  }
}, true);
```

---

### **1.3 å¼‚æ­¥ & Promise é”™è¯¯**
å¦‚æœ `Promise` å‘ç”Ÿé”™è¯¯ä½†æ²¡æœ‰ `catch`ï¼Œä¼šè§¦å‘ `unhandledrejection` äº‹ä»¶ï¼š

```js
window.addEventListener("unhandledrejection", (event) => {
  console.error("æœªå¤„ç†çš„ Promise é”™è¯¯:", event.reason);
  reportError(event.reason);
});
```

ç¤ºä¾‹ï¼š
```js
new Promise((resolve, reject) => {
  reject(new Error("Promise å‡ºé”™äº†"));
});
```

---

### **1.4 React & Vue ç»„ä»¶é”™è¯¯**
#### **ï¼ˆ1ï¼‰React é”™è¯¯è¾¹ç•Œ**
```jsx
import React from "react";

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    console.error("React ç»„ä»¶é”™è¯¯:", error, errorInfo);
    reportError({ error, errorInfo });
  }

  render() {
    if (this.state.hasError) {
      return <h1>é¡µé¢å‡ºé”™äº†</h1>;
    }
    return this.props.children;
  }
}

export default ErrorBoundary;
```

#### **ï¼ˆ2ï¼‰Vue 3 å…¨å±€é”™è¯¯æ•è·**
```js
import { createApp } from "vue";
import App from "./App.vue";

const app = createApp(App);

app.config.errorHandler = (err, instance, info) => {
  console.error("Vue ç»„ä»¶é”™è¯¯:", err, instance, info);
  reportError({ error: err, instance, info });
};
```

---

### **1.5 ç½‘ç»œè¯·æ±‚é”™è¯¯**
ä½¿ç”¨ `fetch` æˆ– `axios` æ‹¦æˆªé”™è¯¯ï¼š
```js
fetch("https://example.com/api")
  .then(response => response.json())
  .catch(error => {
    console.error("Fetch å¤±è´¥:", error);
    reportError(error);
  });
```

---

## **ğŸ“Œ 2. é”™è¯¯ä¸ŠæŠ¥æ–¹å¼**
æ•è·åˆ°é”™è¯¯åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ **`navigator.sendBeacon`ã€`fetch`ã€`XMLHttpRequest`** è¿›è¡Œä¸ŠæŠ¥ã€‚

---

### **2.1 `navigator.sendBeacon`**
ğŸ“Œ **é€‚ç”¨äº**ï¼š
- **é¡µé¢å¸è½½æ—¶ï¼ˆ`beforeunload`ã€`unload`ï¼‰ä¸ŠæŠ¥**ã€‚
- **æ— éœ€ç­‰å¾…å“åº”**ï¼Œä¸å½±å“é¡µé¢æ€§èƒ½ã€‚

```js
function reportError(error) {
  const data = JSON.stringify({
    message: error.message || "æœªçŸ¥é”™è¯¯",
    stack: error.stack || "",
    url: window.location.href,
    userAgent: navigator.userAgent,
    timestamp: Date.now(),
  });

  navigator.sendBeacon("https://your-server.com/error-log", data);
}

window.addEventListener("beforeunload", () => {
  reportError({ message: "é¡µé¢å³å°†å…³é—­", url: window.location.href });
});
```

---

### **2.2 `fetch`ï¼ˆæ”¯æŒæ›´å¤šé…ç½®ï¼‰**
ğŸ“Œ **é€‚ç”¨äº**ï¼š
- **éœ€è¦å¤„ç†å“åº”ã€è¶…æ—¶æ§åˆ¶ã€é‡è¯•æœºåˆ¶**ã€‚
- **æ”¯æŒ POSTã€GETã€Header è‡ªå®šä¹‰**ã€‚

```js
function reportError(error) {
  fetch("https://your-server.com/error-log", {
    method: "POST",
    body: JSON.stringify({
      message: error.message || "æœªçŸ¥é”™è¯¯",
      stack: error.stack || "",
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now(),
    }),
    headers: { "Content-Type": "application/json" },
  }).catch(err => console.error("é”™è¯¯ä¸ŠæŠ¥å¤±è´¥:", err));
}
```

---

### **2.3 `XMLHttpRequest`ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰**
ğŸ“Œ **é€‚ç”¨äº**ï¼š
- **ä½ç‰ˆæœ¬æµè§ˆå™¨ï¼ˆIE11 åŠä»¥ä¸‹ï¼‰**ã€‚

```js
function reportError(error) {
  const xhr = new XMLHttpRequest();
  xhr.open("POST", "https://your-server.com/error-log", true);
  xhr.setRequestHeader("Content-Type", "application/json");
  xhr.send(JSON.stringify({
    message: error.message || "æœªçŸ¥é”™è¯¯",
    stack: error.stack || "",
    url: window.location.href,
    userAgent: navigator.userAgent,
    timestamp: Date.now(),
  }));
}
```

---

## **ğŸ“Œ 3. ä¸ŠæŠ¥æ—¶æœº**
| **ä¸ŠæŠ¥æ—¶æœº** | **é€‚ç”¨ API** | **è¯´æ˜** |
|------------|-----------|--------|
| **é”™è¯¯å‘ç”Ÿæ—¶** | `fetch` / `XMLHttpRequest` | ç«‹å³ä¸ŠæŠ¥ï¼Œé€‚ç”¨äºå®æ—¶ç›‘æ§ |
| **é¡µé¢å¸è½½æ—¶** | `navigator.sendBeacon` | é€‚ç”¨äºé¡µé¢å…³é—­å‰çš„ä¸ŠæŠ¥ |
| **å‘¨æœŸæ€§æ‰¹é‡ä¸ŠæŠ¥** | `setInterval + localStorage` | é€‚ç”¨äºå‡å°‘ç½‘ç»œè¯·æ±‚ï¼Œæ‰¹é‡å¤„ç† |
| **ç”¨æˆ·è¡Œä¸ºè§¦å‘** | `clickã€input äº‹ä»¶ç›‘å¬` | å¯åœ¨ç”¨æˆ·ç‰¹å®šæ“ä½œæ—¶è¿›è¡Œä¸ŠæŠ¥ |

### **ğŸ“Œ æ‰¹é‡ä¸ŠæŠ¥ï¼ˆå‡å°‘è¯·æ±‚æ¬¡æ•°ï¼‰**
```js
const errorQueue = [];

function reportError(error) {
  errorQueue.push({
    message: error.message || "æœªçŸ¥é”™è¯¯",
    stack: error.stack || "",
    url: window.location.href,
    userAgent: navigator.userAgent,
    timestamp: Date.now(),
  });

  // 5 ç§’æ‰¹é‡ä¸ŠæŠ¥ä¸€æ¬¡
  if (errorQueue.length > 5) {
    sendBatchErrors();
  }
}

function sendBatchErrors() {
  if (errorQueue.length === 0) return;
  
  fetch("https://your-server.com/error-log", {
    method: "POST",
    body: JSON.stringify(errorQueue),
    headers: { "Content-Type": "application/json" },
  }).then(() => {
    errorQueue.length = 0; // æ¸…ç©ºé˜Ÿåˆ—
  });
}

setInterval(sendBatchErrors, 5000);
```

---

## **ğŸ“Œ 4. æ€»ç»“**
| **é”™è¯¯ç±»å‹** | **æ•è·æ–¹å¼** | **ä¸ŠæŠ¥æ–¹å¼** |
|------------|-----------|-----------|
| **åŒæ­¥ä»£ç é”™è¯¯** | `try-catch` | `fetch` / `sendBeacon` |
| **è¿è¡Œæ—¶é”™è¯¯** | `window.onerror` | `fetch` / `sendBeacon` |
| **èµ„æºåŠ è½½å¤±è´¥** | `window.addEventListener("error")` | `fetch` |
| **Promise é”™è¯¯** | `unhandledrejection` | `fetch` |
| **React ç»„ä»¶é”™è¯¯** | `ErrorBoundary` | `fetch` |
| **Vue ç»„ä»¶é”™è¯¯** | `app.config.errorHandler` | `fetch` |
| **ç½‘ç»œè¯·æ±‚é”™è¯¯** | `fetch().catch()` / `axios.interceptors` | `fetch` |

é€šè¿‡è¿™äº›æ–¹å¼ï¼Œå¯ä»¥å®ç° **å‰ç«¯é”™è¯¯æ•è· + æœåŠ¡å™¨ä¸ŠæŠ¥**ï¼Œæ— éœ€ä¾èµ–ç¬¬ä¸‰æ–¹ç›‘æ§å¹³å°ï¼Œå®ç°è½»é‡çº§çš„é”™è¯¯ç›‘æ§ç³»ç»Ÿï¼ğŸš€





### **ç›‘å¬é¡µé¢å¼‚å¸¸å¹¶ä¸ŠæŠ¥çš„å‘é€æ—¶æœº**
å¦‚æœè¦**ç›‘å¬é¡µé¢å¼‚å¸¸å¹¶ä¸ŠæŠ¥åˆ°åç«¯**ï¼Œéœ€è¦è€ƒè™‘å‘é€æ•°æ®çš„**æœ€ä½³æ—¶æœº**ï¼Œé¿å…æ•°æ®ä¸¢å¤±ï¼ŒåŒæ—¶ä¸å½±å“ç”¨æˆ·ä½“éªŒã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„å‘é€æ—¶æœºï¼š

---

### **1. ç«‹å³ä¸ŠæŠ¥ï¼ˆå®æ—¶ä¸ŠæŠ¥ï¼‰**
é€‚ç”¨äº**é‡è¦é”™è¯¯**ï¼ˆå¦‚è‡´å‘½é”™è¯¯ã€å…³é”®åŠŸèƒ½å¼‚å¸¸ï¼‰ï¼Œä½†å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œå°¤å…¶æ˜¯é«˜é¢‘è§¦å‘çš„é”™è¯¯ã€‚

```js
window.addEventListener('error', function (event) {
    fetch('/error-report', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            type: 'runtime_error',
            message: event.message,
            source: event.filename,
            line: event.lineno,
            column: event.colno,
            stack: event.error?.stack || '',
            time: Date.now(),
        })
    });
});
```

é€‚ç”¨åœºæ™¯ï¼š
- å…³é”®åŠŸèƒ½å¼‚å¸¸ï¼ˆå¦‚æ”¯ä»˜å¤±è´¥ï¼‰
- è¿è¡Œæ—¶ JS é”™è¯¯
- èµ„æºåŠ è½½å¤±è´¥ï¼ˆå›¾ç‰‡ã€è„šæœ¬ï¼‰

ç¼ºç‚¹ï¼š
- çŸ­æ—¶é—´å†…å¤§é‡é”™è¯¯å¯èƒ½å¯¼è‡´é¢‘ç¹è¯·æ±‚ï¼Œå½±å“æ€§èƒ½

---

### **2. æ‰¹é‡ä¸ŠæŠ¥ï¼ˆå®šæ—¶å‘é€ï¼‰**
é€‚ç”¨äº**éå…³é”®é”™è¯¯**ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚ï¼Œæé«˜æ€§èƒ½ã€‚å¯ä»¥ä½¿ç”¨ `setTimeout` æˆ– `requestIdleCallback` æ‰¹é‡å‘é€ã€‚

```js
const errorQueue = [];

window.addEventListener('error', function (event) {
    errorQueue.push({
        type: 'runtime_error',
        message: event.message,
        source: event.filename,
        line: event.lineno,
        column: event.colno,
        stack: event.error?.stack || '',
        time: Date.now(),
    });

    // æ¯ 5 ç§’å‘é€ä¸€æ¬¡
    if (!window.errorTimer) {
        window.errorTimer = setTimeout(() => {
            fetch('/error-report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(errorQueue),
            });
            errorQueue.length = 0; // æ¸…ç©ºé˜Ÿåˆ—
            window.errorTimer = null;
        }, 5000);
    }
});
```

é€‚ç”¨åœºæ™¯ï¼š
- é«˜é¢‘é”™è¯¯ï¼ˆå¦‚ console.warnã€è¯·æ±‚å¤±è´¥ï¼‰
- å½±å“ä¸å¤§çš„ UI å¼‚å¸¸
- èµ„æºåŠ è½½å¤±è´¥

ç¼ºç‚¹ï¼š
- å¯èƒ½ä¼šå»¶è¿Ÿä¸ŠæŠ¥ï¼Œå¯¼è‡´éƒ¨åˆ†é”™è¯¯æ•°æ®ä¸¢å¤±

---

### **3. é¡µé¢å…³é—­æ—¶ä¸ŠæŠ¥ï¼ˆ`beforeunload`ï¼‰**
é€‚ç”¨äº**é¡µé¢å³å°†å…³é—­**ï¼Œä½†ä¸é€‚åˆå®æ—¶ä¸ŠæŠ¥ã€‚å¯ä»¥ä½¿ç”¨ `navigator.sendBeacon`ï¼ˆæ¨èï¼‰æˆ– `fetch`ã€‚

```js
window.addEventListener('beforeunload', function () {
    if (errorQueue.length > 0) {
        navigator.sendBeacon('/error-report', JSON.stringify(errorQueue));
    }
});
```

é€‚ç”¨åœºæ™¯ï¼š
- é¡µé¢å´©æºƒ
- ç”¨æˆ·æœªä¸»åŠ¨ä¸ŠæŠ¥çš„é”™è¯¯
- ç¦»å¼€é¡µé¢æ—¶æ•´ç†é”™è¯¯æ•°æ®

ç¼ºç‚¹ï¼š
- ä¸èƒ½ä¿è¯ 100% å‘é€æˆåŠŸ
- `sendBeacon` æœ‰æ•°æ®å¤§å°é™åˆ¶ï¼ˆçº¦ 64KBï¼‰

---

### **4. ç”¨æˆ·æ“ä½œåä¸ŠæŠ¥ï¼ˆäº¤äº’è§¦å‘ï¼‰**
é€‚ç”¨äº**ç”¨æˆ·ç‚¹å‡»ã€æäº¤è¡¨å•ã€åˆ‡æ¢é¡µé¢æ—¶æ‰¹é‡ä¸ŠæŠ¥**ã€‚

```js
document.addEventListener('visibilitychange', function () {
    if (document.visibilityState === 'hidden' && errorQueue.length > 0) {
        navigator.sendBeacon('/error-report', JSON.stringify(errorQueue));
    }
});
```

é€‚ç”¨åœºæ™¯ï¼š
- ç›‘æ§ç‰¹å®šæ“ä½œçš„é”™è¯¯ï¼ˆå¦‚ç‚¹å‡»æŒ‰é’®ã€æäº¤è¡¨å•ï¼‰
- é€‚ç”¨äºå•é¡µåº”ç”¨ï¼ˆSPAï¼‰ï¼Œé˜²æ­¢é¡µé¢åˆ·æ–°ä¸¢å¤±é”™è¯¯ä¿¡æ¯

ç¼ºç‚¹ï¼š
- é€‚ç”¨äº**ä½é¢‘è§¦å‘**çš„é”™è¯¯ï¼Œä¸é€‚åˆé«˜é¢‘é”™è¯¯

---

### **5. Web Worker / Service Worker ä¸ŠæŠ¥**
é€‚ç”¨äº**ç¦»çº¿å­˜å‚¨é”™è¯¯å¹¶åœ¨ç”¨æˆ·æ¢å¤ç½‘ç»œåä¸ŠæŠ¥**ã€‚

```js
const worker = new Worker('errorWorker.js');

window.addEventListener('error', function (event) {
    worker.postMessage({
        type: 'runtime_error',
        message: event.message,
        source: event.filename,
        line: event.lineno,
        column: event.colno,
        stack: event.error?.stack || '',
        time: Date.now(),
    });
});

// errorWorker.js
self.addEventListener('message', function (event) {
    self.errors = self.errors || [];
    self.errors.push(event.data);

    setTimeout(() => {
        if (self.errors.length > 0) {
            fetch('/error-report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(self.errors),
            });
            self.errors = [];
        }
    }, 5000);
});
```

é€‚ç”¨åœºæ™¯ï¼š
- æ–­ç½‘æƒ…å†µä¸‹ç¼“å­˜é”™è¯¯ï¼Œç­‰ç½‘ç»œæ¢å¤åä¸ŠæŠ¥
- é€‚ç”¨äº PWAã€ç¦»çº¿åº”ç”¨

ç¼ºç‚¹ï¼š
- éœ€è¦é¢å¤–ç»´æŠ¤ Worker çº¿ç¨‹

---

### **æ€»ç»“**
| æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **å®æ—¶ä¸ŠæŠ¥** (`fetch`) | å…³é”®åŠŸèƒ½å¼‚å¸¸ | åŠæ—¶åé¦ˆ | å¯èƒ½å½±å“æ€§èƒ½ |
| **æ‰¹é‡ä¸ŠæŠ¥** (`setTimeout`) | é«˜é¢‘é”™è¯¯ | é™ä½è¯·æ±‚æ•° | å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤± |
| **é¡µé¢å…³é—­æ—¶ä¸ŠæŠ¥** (`sendBeacon`) | é¡µé¢å´©æºƒã€ç¦»å¼€é¡µé¢ | ç¡®ä¿æ•°æ®å°½å¯èƒ½å‘é€ | ä¸èƒ½ 100% æˆåŠŸ |
| **ç”¨æˆ·äº¤äº’åä¸ŠæŠ¥** (`visibilitychange`) | è¡¨å•ã€æŒ‰é’®ç‚¹å‡» | ä½å¹²æ‰° | ä»…é€‚ç”¨äºä½é¢‘é”™è¯¯ |
| **Web Worker ä¸ŠæŠ¥** | æ–­ç½‘æ¢å¤ | é€‚ç”¨äº PWA | éœ€è¦é¢å¤–ç»´æŠ¤ |

---

**æœ€ä½³å®è·µ**
- **ä¸¥é‡é”™è¯¯**ï¼ˆå¦‚ç™½å±ã€æ”¯ä»˜å¤±è´¥ï¼‰ï¼š**ç«‹å³ä¸ŠæŠ¥**
- **éè‡´å‘½é”™è¯¯**ï¼ˆå¦‚åŠ è½½å¤±è´¥ã€API è¶…æ—¶ï¼‰ï¼š**æ‰¹é‡ä¸ŠæŠ¥**
- **é¡µé¢å…³é—­**ï¼š**`sendBeacon` ä¿è¯æ•°æ®ä¸ä¼šä¸¢å¤±**
- **PWA / æ–­ç½‘æƒ…å†µ**ï¼š**ä½¿ç”¨ Service Worker ç¼“å­˜å¹¶ç¨åä¸ŠæŠ¥**

å¦‚æœä½ è¦åœ¨ç‰¹å®šåœºæ™¯ä¸‹ä¸ŠæŠ¥é”™è¯¯ï¼Œæ¯”å¦‚ **Vueã€Reactã€Node.js åç«¯**ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘ä½ çš„å…·ä½“éœ€æ±‚ï¼Œæˆ‘å¯ä»¥ç»™å‡ºæ›´ç²¾ç»†çš„æ–¹æ¡ˆï¼

